<!DOCTYPE html><html><head>
      <title>next_improvements</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/sujitkhanna/.cursor/extensions/shd101wyy.markdown-preview-enhanced-0.8.19-universal/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      <div>
<h1 id="extending-the-project-to-perform-both-tool-calls-as-well-as-analyzing-the-responses-based-on-the-tool-outputs">Extending the project to perform both tool calls as well as analyzing the responses based on the tool outputs </h1>
<p>Short answer first: <strong>yes</strong>, this makes mathematical sense and <strong>yes</strong>, it’s fully compatible with SkyRL.</p>
<ul>
<li>In RL terms, you’re defining a <strong>dense per‑turn reward</strong> for tool usage + analysis <strong>and</strong> a <strong>terminal reward</strong> that scores the <strong>final text answer</strong> against a <strong>reference answer</strong> produced by your synthetic data generator. Maximizing expected return under GRPO/PPO will push the policy toward correct tools/arguments <em>and</em> high‑quality final summaries.</li>
<li>SkyRL is built for this: multi‑turn <code>BaseTextEnv</code> tasks, tool calls via ToolGroups, final answers (e.g., the Search example uses <code>&lt;answer&gt;…&lt;/answer&gt;</code> and gives reward for correctness), and dataset entries that keep only a seed prompt while the environment computes turn‑level rewards. (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</li>
</ul>
<p>Below is a <strong>complete recipe</strong>:</p>
<hr>
<h2 id="0-what-mathematically-makes-sense-here">0) What “mathematically makes sense” here </h2>
<p>Let an episode be ( \tau = (s_0,a_0,r_0,\dots,s_T,a_T,r_T) ) where:</p>
<ul>
<li>Steps (1..K) are <strong>tool turns</strong>; step (K{+}1) is the <strong>final text answer</strong>.</li>
<li>Reward (r_t = r_t^{\text{tools}}) for tool turns (shaped by your rubric), and (r_{K+1} = \alpha \cdot r^{\text{final}} ) where ( r^{\text{final}} \in [0,1] ) comes from <strong>LLM‑as‑a‑Judge</strong> (LAJ) comparing the <strong>policy’s final answer</strong> vs the <strong>reference</strong> (and/or a set of “verifiable facts” extracted during data generation). (\alpha) balances tool learning vs answer quality.</li>
</ul>
<p>GRPO/PPO maximizes ( \mathbb{E}_\pi\left[\sum_t r_t\right] ) using advantages (A_t) (e.g., GAE). Since LAJ outputs are <strong>numeric rewards</strong>, they’re just another term in the return; no special math is needed. (This is analogous to SkyRL’s Search example, which assigns a terminal 0/1 for correct/incorrect final text. We’re just using a <strong>graded</strong> judge instead of binary correctness.) (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</p>
<hr>
<h2 id="1-data-model-you-should-write-to-train_llmjson">1) Data model you should write to <code>train_llm.json</code> </h2>
<p>Add <strong>two</strong> new sections to your <code>reward_spec.ground_truth</code>:</p>
<ul>
<li><code>final_reference</code>: the <strong>reference final answer</strong> your generator produces <em>by actually running the plan over MCP tools and analyzing the outputs</em>. Store both <strong>text</strong> and <strong>facts</strong> (structured), plus optional citations.</li>
<li><code>judge_rubric</code>: a <strong>structured rubric</strong> your environment will pass to LAJ to score the policy’s final text against the reference.</li>
</ul>
<h3 id="11-minimal-schema-extension-dropin">1.1 Minimal schema extension (drop‑in) </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"data_source"</span><span class="token operator">:</span> <span class="token string">"synthetic/llm"</span><span class="token punctuation">,</span>
  <span class="token property">"env_class"</span><span class="token operator">:</span> <span class="token string">"MCPToolEnv"</span><span class="token punctuation">,</span>
  <span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"…"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"…"</span> <span class="token punctuation">}</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"reward_spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"rule"</span><span class="token punctuation">,</span>
    <span class="token property">"ground_truth"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
      <span class="token property">"complexity"</span><span class="token operator">:</span> <span class="token string">"simple|moderate|complex"</span><span class="token punctuation">,</span>
      <span class="token property">"max_turns"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
      <span class="token property">"limits"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"max_servers"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"max_tools"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"tool_sequence"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"…"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"…"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"…"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"analysis_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"steps"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"name"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"…"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"final_answer_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"text|markdown|json"</span><span class="token punctuation">,</span>
          <span class="token property">"must_include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"list"</span><span class="token punctuation">,</span><span class="token string">"of"</span><span class="token punctuation">,</span><span class="token string">"keys-or-names"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"grounded_from"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"state_keys_to_check"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"quality_criteria"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"no hallucinations"</span><span class="token punctuation">,</span><span class="token string">"concise"</span><span class="token punctuation">,</span> <span class="token string">"…"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"final_reference"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"answer_text"</span><span class="token operator">:</span> <span class="token string">"the reference final summary, generated by your agent after running tools"</span><span class="token punctuation">,</span>
        <span class="token property">"facts"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"NVDA"</span><span class="token punctuation">,</span><span class="token string">"AMD"</span><span class="token punctuation">,</span><span class="token string">"META"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"…"</span><span class="token punctuation">,</span><span class="token string">"…"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"citations"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>  <span class="token comment">// step indexes that support facts</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"judge_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"weights"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token property">"grounding"</span><span class="token operator">:</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token property">"clarity"</span><span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token property">"safety"</span><span class="token operator">:</span> <span class="token number">0.1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
          <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"grounding"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"clarity"</span><span class="token operator">:</span>  <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"safety"</span><span class="token operator">:</span>   <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"total"</span><span class="token operator">:</span>    <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"coverage"</span><span class="token punctuation">,</span><span class="token string">"grounding"</span><span class="token punctuation">,</span><span class="token string">"clarity"</span><span class="token punctuation">,</span><span class="token string">"safety"</span><span class="token punctuation">,</span><span class="token string">"total"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"target_length_range"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"extra_info"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"scenario"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"scenario"</span><span class="token operator">:</span><span class="token string">"…"</span><span class="token punctuation">,</span><span class="token property">"turns"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><ul>
<li>Keep the <strong>prompt compact</strong> (system + first user) per SkyRL’s Dataset Preparation guidance. The env drives multi‑turn reward logic. (<a href="https://skyrl.readthedocs.io/?utm_source=chatgpt.com" title="Welcome to SkyRL's documentation! — SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li><code>final_reference</code> is <strong>not</strong> shown to the policy; it’s used only for reward.</li>
</ul>
<hr>
<h2 id="2-changes-to-your-generator-srcdatasetllmgenerate_with_llmpy">2) Changes to your generator <code>src/dataset/llm/generate_with_llm.py</code> </h2>
<p>You’ll add <strong>two phases</strong> after planning:</p>
<ol>
<li><strong>Execute the plan</strong> over MCP tools, step‑by‑step, applying your <strong>analysis_rubric.steps</strong> (extract/compute/select/accept_if/next_args_from) to build a <strong>named state</strong> and capture <strong>per‑step result summaries</strong>.</li>
<li><strong>Compose the reference final text</strong> using the named state (either via deterministic templating or by calling an LLM with a short, grounded prompt), and write it as <code>final_reference.answer_text</code> (+ <code>facts</code>, <code>citations</code>).</li>
</ol>
<blockquote>
<p>Tip: keep the <strong>DSL</strong> small and safe (no <code>eval</code>), e.g., functions like <code>last</code>, <code>prev</code>, <code>pct_change_last_day</code>, <code>topk</code>, <code>argmax</code>, <code>unique</code>, <code>regex_extract_all</code>, <code>concat</code>, <code>head</code>. This mirrors SkyRL’s practice of keeping env logic deterministic and light. (<a href="https://skyrl.readthedocs.io/en/latest/tutorials/new_env.html?utm_source=chatgpt.com" title="Creating a New Environment or Task - SkyRL documentation">skyrl.readthedocs.io</a>)</p>
</blockquote>
<h3 id="21-minimal-prready-patch-conceptual-diff">2.1 Minimal, PR‑ready patch (conceptual diff) </h3>
<pre data-role="codeBlock" data-info="diff" class="language-diff diff"><code><span class="token coord">--- a/src/dataset/llm/generate_with_llm.py</span>
<span class="token coord">+++ b/src/dataset/llm/generate_with_llm.py</span>
@@
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">TASK_SCHEMA = {...}  # your existing schema
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">TASK_SCHEMA = {
</span><span class="token prefix inserted">+</span><span class="token line">  "name": "rl_task",
</span><span class="token prefix inserted">+</span><span class="token line">  "schema": {
</span><span class="token prefix inserted">+</span><span class="token line">    "type": "object",
</span><span class="token prefix inserted">+</span><span class="token line">    "properties": {
</span><span class="token prefix inserted">+</span><span class="token line">      "task_id": {"type": "string"},
</span><span class="token prefix inserted">+</span><span class="token line">      "complexity": {"type": "string", "enum": ["simple","moderate","complex"]},
</span><span class="token prefix inserted">+</span><span class="token line">      "user_prompt": {"type": "string"},
</span><span class="token prefix inserted">+</span><span class="token line">      "max_turns": {"type": "integer", "minimum": 3, "maximum": 16},
</span><span class="token prefix inserted">+</span><span class="token line">      "tools_available": {"type": "array", "items": {"type": "string"}},
</span><span class="token prefix inserted">+</span><span class="token line">      "limits": {"type": "object"},
</span><span class="token prefix inserted">+</span><span class="token line">      "tool_sequence": {
</span><span class="token prefix inserted">+</span><span class="token line">        "type": "array", "minItems": 2, "maxItems": 12,
</span><span class="token prefix inserted">+</span><span class="token line">        "items": {
</span><span class="token prefix inserted">+</span><span class="token line">          "type": "object",
</span><span class="token prefix inserted">+</span><span class="token line">          "properties": {
</span><span class="token prefix inserted">+</span><span class="token line">            "step": {"type":"integer","minimum":1},
</span><span class="token prefix inserted">+</span><span class="token line">            "server":{"type":"string"},
</span><span class="token prefix inserted">+</span><span class="token line">            "tool":{"type":"string"},
</span><span class="token prefix inserted">+</span><span class="token line">            "params":{"type":"object"},
</span><span class="token prefix inserted">+</span><span class="token line">            "analysis_requirements": {
</span><span class="token prefix inserted">+</span><span class="token line">              "type":"object",
</span><span class="token prefix inserted">+</span><span class="token line">              "properties":{
</span><span class="token prefix inserted">+</span><span class="token line">                "extract":{"type":"array","items":{"type":"string"}},
</span><span class="token prefix inserted">+</span><span class="token line">                "compute":{"type":"array","items":{"type":"string"}},
</span><span class="token prefix inserted">+</span><span class="token line">                "select":{"type":"array","items":{"type":"string"}},
</span><span class="token prefix inserted">+</span><span class="token line">                "accept_if":{"type":"array","items":{"type":"string"}},
</span><span class="token prefix inserted">+</span><span class="token line">                "next_args_from":{"type":"string"}
</span><span class="token prefix inserted">+</span><span class="token line">              },
</span><span class="token prefix inserted">+</span><span class="token line">              "required":["next_args_from"],
</span><span class="token prefix inserted">+</span><span class="token line">              "additionalProperties": true
</span><span class="token prefix inserted">+</span><span class="token line">            }
</span><span class="token prefix inserted">+</span><span class="token line">          },
</span><span class="token prefix inserted">+</span><span class="token line">          "required": ["step","server","tool","params","analysis_requirements"],
</span><span class="token prefix inserted">+</span><span class="token line">          "additionalProperties": true
</span><span class="token prefix inserted">+</span><span class="token line">        }
</span><span class="token prefix inserted">+</span><span class="token line">      },
</span><span class="token prefix inserted">+</span><span class="token line">      "final_answer_requirements": {
</span><span class="token prefix inserted">+</span><span class="token line">        "type": "object",
</span><span class="token prefix inserted">+</span><span class="token line">        "properties": {
</span><span class="token prefix inserted">+</span><span class="token line">          "format": {"type":"string"},
</span><span class="token prefix inserted">+</span><span class="token line">          "must_include":{"type":"array","items":{"type":"string"}},
</span><span class="token prefix inserted">+</span><span class="token line">          "grounded_from":{"type":"array","items":{"type":"string"}},
</span><span class="token prefix inserted">+</span><span class="token line">          "quality_criteria":{"type":"array","items":{"type":"string"}}
</span><span class="token prefix inserted">+</span><span class="token line">        },
</span><span class="token prefix inserted">+</span><span class="token line">        "required": ["format","must_include","grounded_from"]
</span><span class="token prefix inserted">+</span><span class="token line">      },
</span><span class="token prefix inserted">+</span><span class="token line">      "judge_rubric": {
</span><span class="token prefix inserted">+</span><span class="token line">        "type":"object",
</span><span class="token prefix inserted">+</span><span class="token line">        "properties":{
</span><span class="token prefix inserted">+</span><span class="token line">          "weights":{"type":"object"},
</span><span class="token prefix inserted">+</span><span class="token line">          "schema":{"type":"object"},
</span><span class="token prefix inserted">+</span><span class="token line">          "target_length_range":{"type":"array","items":{"type":"integer"}}
</span><span class="token prefix inserted">+</span><span class="token line">        },
</span><span class="token prefix inserted">+</span><span class="token line">          "required":["weights","schema"]
</span><span class="token prefix inserted">+</span><span class="token line">      }
</span><span class="token prefix inserted">+</span><span class="token line">    },
</span><span class="token prefix inserted">+</span><span class="token line">    "required": ["task_id","complexity","user_prompt","max_turns","tool_sequence","final_answer_requirements","judge_rubric"],
</span><span class="token prefix inserted">+</span><span class="token line">    "additionalProperties": false
</span><span class="token prefix inserted">+</span><span class="token line">  }
</span><span class="token prefix inserted">+</span><span class="token line">}
</span></span>@@
<span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">async def _one_task(...):
</span><span class="token prefix unchanged"> </span><span class="token line">    # 1) Ask LLM for plan (as you do today)
</span><span class="token prefix unchanged"> </span><span class="token line">    task = await _call_llm_with_schema(...)
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">    return task
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">    # 2) Verify &amp; repair chaining (next_args_from, step ranges)
</span><span class="token prefix inserted">+</span><span class="token line">    task = _verify_and_repair(task)
</span><span class="token prefix inserted">+</span><span class="token line">    # 3) Execute plan over MCP tools to build named state and per-step summaries
</span><span class="token prefix inserted">+</span><span class="token line">    exec_out = await simulate_plan_and_collect(task, tool_manager)
</span><span class="token prefix inserted">+</span><span class="token line">    # 4) Compose reference final answer (LLM or template), grounded in exec_out.state
</span><span class="token prefix inserted">+</span><span class="token line">    final_ref = await compose_reference_answer(task, exec_out)
</span><span class="token prefix inserted">+</span><span class="token line">    task["_exec_out"] = exec_out.to_dict()    # optional: keep light summaries, hashes
</span><span class="token prefix inserted">+</span><span class="token line">    task["_final_reference"] = final_ref
</span><span class="token prefix inserted">+</span><span class="token line">    return task
</span></span>@@
<span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">def to_skyrl_sample(task, system_prompt):
</span><span class="token prefix deleted">-</span><span class="token line">    ground_truth = {...}
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">def to_skyrl_sample(task, system_prompt):
</span><span class="token prefix inserted">+</span><span class="token line">    ground_truth = {
</span><span class="token prefix inserted">+</span><span class="token line">      "task_id": task["task_id"],
</span><span class="token prefix inserted">+</span><span class="token line">      "complexity": task["complexity"],
</span><span class="token prefix inserted">+</span><span class="token line">      "max_turns": task["max_turns"],
</span><span class="token prefix inserted">+</span><span class="token line">      "limits": task.get("limits", {}),
</span><span class="token prefix inserted">+</span><span class="token line">      "tool_sequence": task["tool_sequence"],
</span><span class="token prefix inserted">+</span><span class="token line">      "analysis_rubric": {
</span><span class="token prefix inserted">+</span><span class="token line">        "steps": [{ "step": s["step"], **s["analysis_requirements"] } for s in task["tool_sequence"]],
</span><span class="token prefix inserted">+</span><span class="token line">        "final_answer_requirements": task["final_answer_requirements"]
</span><span class="token prefix inserted">+</span><span class="token line">      },
</span><span class="token prefix inserted">+</span><span class="token line">      "final_reference": task["_final_reference"],
</span><span class="token prefix inserted">+</span><span class="token line">      "judge_rubric": task["judge_rubric"]
</span><span class="token prefix inserted">+</span><span class="token line">    }
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">    return {
</span><span class="token prefix unchanged"> </span><span class="token line">      "data_source": "synthetic/llm",
</span><span class="token prefix unchanged"> </span><span class="token line">      "env_class": "MCPToolEnv",
</span><span class="token prefix unchanged"> </span><span class="token line">      "prompt": [
</span><span class="token prefix unchanged"> </span><span class="token line">        {"role": "system", "content": system_prompt},
</span><span class="token prefix unchanged"> </span><span class="token line">        {"role": "user", "content": task["user_prompt"]}
</span><span class="token prefix unchanged"> </span><span class="token line">      ],
</span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line">      "reward_spec": {"method":"rule","ground_truth": ground_truth},
</span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line">      "reward_spec": {"method":"rule","ground_truth": ground_truth},
</span></span><span class="token unchanged"><span class="token prefix unchanged"> </span><span class="token line">      "extra_info": {"version": "lh-v2"}
</span><span class="token prefix unchanged"> </span><span class="token line">    }
</span></span></code></pre><h3 id="22-execution-harness-new-helpers">2.2 Execution harness (new helpers) </h3>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">simulate_plan_and_collect</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> tm<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token string">"ExecOut"</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Runs tool_sequence with placeholder resolution and applies analysis_rubric.steps
    to produce named state and lightweight per-step summaries.
    """</span>
    plan <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span>
    steps_rubric <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">[</span><span class="token string">"analysis_requirements"</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> plan<span class="token punctuation">]</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># named values introduced by extract/compute/select</span>
    per_step <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> idx<span class="token punctuation">,</span> step <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>plan<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        args <span class="token operator">=</span> resolve_placeholders<span class="token punctuation">(</span>step<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>   <span class="token comment"># ${var} replacement</span>
        result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> tm<span class="token punctuation">.</span>execute_tool<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{</span>step<span class="token punctuation">[</span><span class="token string">'server'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>step<span class="token punctuation">[</span><span class="token string">'tool'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">20.0</span><span class="token punctuation">)</span>
        summary <span class="token operator">=</span> summarize_tool_result<span class="token punctuation">(</span>result<span class="token punctuation">)</span>               <span class="token comment"># small, e.g., top keys, counts</span>
        <span class="token comment"># apply rubric: extract/compute/select/accept_if</span>
        updates<span class="token punctuation">,</span> checks <span class="token operator">=</span> apply_analysis<span class="token punctuation">(</span>steps_rubric<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
        state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>updates<span class="token punctuation">)</span>
        per_step<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"step"</span><span class="token punctuation">:</span> idx<span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> args<span class="token punctuation">,</span> <span class="token string">"summary"</span><span class="token punctuation">:</span> summary<span class="token punctuation">,</span> <span class="token string">"checks"</span><span class="token punctuation">:</span> checks<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> ExecOut<span class="token punctuation">(</span>state<span class="token operator">=</span>state<span class="token punctuation">,</span> steps<span class="token operator">=</span>per_step<span class="token punctuation">)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">apply_analysis</span><span class="token punctuation">(</span>ar<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">tuple</span><span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Implements a tiny, safe DSL (no eval) for extract/compute/select/accept_if."""</span>
    updates <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    checks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"accept_pass"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"missing"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token comment"># extract</span>
    <span class="token keyword keyword-for">for</span> name <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"extract"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val<span class="token punctuation">,</span> ok <span class="token operator">=</span> safe_extract<span class="token punctuation">(</span>name<span class="token punctuation">,</span> result<span class="token punctuation">)</span>   <span class="token comment"># support "close[]", "articles[][title]"</span>
        <span class="token keyword keyword-if">if</span> ok<span class="token punctuation">:</span> updates<span class="token punctuation">[</span>name<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>  checks<span class="token punctuation">[</span><span class="token string">"missing"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> checks<span class="token punctuation">[</span><span class="token string">"accept_pass"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token comment"># compute/select (whitelisted ops like last, prev, pct_change_last_day, topk, argmax, unique, regex_extract_all, head, concat, merge_map, count_keys)</span>
    <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"compute"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> updates<span class="token punctuation">.</span>update<span class="token punctuation">(</span>safe_compute<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  updates<span class="token punctuation">.</span>update<span class="token punctuation">(</span>safe_compute<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># accept_if</span>
    <span class="token keyword keyword-for">for</span> cond <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"accept_if"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> safe_check<span class="token punctuation">(</span>cond<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span> checks<span class="token punctuation">[</span><span class="token string">"accept_pass"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword keyword-return">return</span> updates<span class="token punctuation">,</span> checks

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">compose_reference_answer</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> exec_out<span class="token punctuation">:</span> <span class="token string">"ExecOut"</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Produce final_reference {answer_text, facts, citations} from state."""</span>
    far <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token string">"final_answer_requirements"</span><span class="token punctuation">]</span>
    <span class="token comment"># build facts deterministically from state:</span>
    facts <span class="token operator">=</span> build_facts<span class="token punctuation">(</span>exec_out<span class="token punctuation">.</span>state<span class="token punctuation">,</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"grounded_from"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># use a small LLM prompt or a template to compose the text</span>
    answer_text <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> small_llm_compose<span class="token punctuation">(</span>far<span class="token punctuation">,</span> exec_out<span class="token punctuation">.</span>state<span class="token punctuation">,</span> facts<span class="token punctuation">)</span>
    <span class="token comment"># map which steps support which facts</span>
    citations <span class="token operator">=</span> infer_citations<span class="token punctuation">(</span>facts<span class="token punctuation">,</span> exec_out<span class="token punctuation">.</span>steps<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"answer_text"</span><span class="token punctuation">:</span> answer_text<span class="token punctuation">,</span> <span class="token string">"facts"</span><span class="token punctuation">:</span> facts<span class="token punctuation">,</span> <span class="token string">"citations"</span><span class="token punctuation">:</span> citations<span class="token punctuation">}</span>
</code></pre><ul>
<li><strong>Why do this at data‑gen time?</strong> So your <strong>reference</strong> is grounded in <strong>real tool results</strong>, not a hallucinated answer. At training, the env will compare the <strong>policy’s</strong> final text to this reference using LAJ and/or heuristics.</li>
</ul>
<hr>
<h2 id="3-environment-changes-how-the-final-answer-is-rewarded">3) Environment changes (how the final answer is rewarded) </h2>
<p>Your <code>MCPToolEnv(BaseTextEnv)</code> should accept either:</p>
<ul>
<li>a <strong>tool call</strong> (<code>{"tool":"server.tool","arguments":{...}}</code>) or</li>
<li>a <strong>final answer</strong> (<code>{"final_answer":"…text…"}</code>), similar to the <strong>Search example</strong>, which uses <code>&lt;answer&gt;…&lt;/answer&gt;</code> with stop strings to mark the last turn. (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</li>
</ul>
<h3 id="31-final-answer-scoring-in-the-env">3.1 Final answer scoring in the env </h3>
<p><strong>Heuristic (fast):</strong></p>
<ul>
<li><strong>Coverage:</strong> does text include all names in <code>analysis_rubric.final_answer_requirements.must_include</code>?</li>
<li><strong>Grounding:</strong> is text consistent with <code>final_reference.facts</code> (e.g., set overlap equals 1.0), and <strong>does not</strong> contradict them?</li>
<li><strong>Clarity:</strong> target length range; simple readability checks.</li>
<li><strong>Safety:</strong> blacklist checks.</li>
</ul>
<p><strong>LLM‑as‑a‑Judge (LAJ):</strong></p>
<ul>
<li>Judge sees a <strong>compact state summary</strong>, the <strong>policy’s final text</strong>, and the <strong>reference</strong> (text + facts).</li>
<li>Use <strong>Structured Outputs</strong> with your <code>judge_rubric.schema</code> to force <strong>numbers‑only</strong>.</li>
</ul>
<p><strong>Reward:</strong></p>
<ul>
<li>( r_{\text{final}} = \lambda_{\text{heur}} r_{\text{heur}} + \lambda_{\text{laj}} r_{\text{laj}} ) (both in ([0,1])).</li>
<li>Total episode return is sum of shaped tool rewards + ( \alpha \cdot r_{\text{final}} ).</li>
</ul>
<p>This mirrors SkyRL’s pattern where the final text inside <code>&lt;answer&gt;</code> is what gets rewarded (binary in Search; graded here). (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</p>
<hr>
<h2 id="4-two-sample-dataset-items-with-final_reference--judge_rubric">4) Two <strong>sample dataset items</strong> (with <code>final_reference</code> &amp; <code>judge_rubric</code>) </h2>
<h3 id="41-nasdaq100-news-triage-truncated-for-space-drop-into-your-json-array">4.1 NASDAQ‑100 news triage (truncated for space; drop into your JSON array) </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"data_source"</span><span class="token operator">:</span> <span class="token string">"synthetic/llm"</span><span class="token punctuation">,</span>
  <span class="token property">"env_class"</span><span class="token operator">:</span> <span class="token string">"MCPToolEnv"</span><span class="token punctuation">,</span>
  <span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"You have tools DuckDuckGo, yahoo_finance, python_execution, slack. Emit tool calls as {\"tool\":\"server.tool\",\"arguments\":{...}}. Finish with {\"final_answer\":\"...\"}."</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"Find top-3 gainers in NASDAQ-100 today, get 5 news headlines each, select negative-sentiment ones, and post a brief digest."</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"reward_spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"rule"</span><span class="token punctuation">,</span>
    <span class="token property">"ground_truth"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"nasdaq100_neg_digest_v2"</span><span class="token punctuation">,</span>
      <span class="token property">"complexity"</span><span class="token operator">:</span> <span class="token string">"complex"</span><span class="token punctuation">,</span>
      <span class="token property">"max_turns"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
      <span class="token property">"limits"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"max_servers"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"max_tools"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"tool_sequence"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"NASDAQ-100 components list"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"fetch_content"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"${tickers_url}"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"yahoo_finance"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"get_yfinance_price_history"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"ticker"</span><span class="token operator">:</span> <span class="token string">"${tickers}"</span><span class="token punctuation">,</span> <span class="token property">"period"</span><span class="token operator">:</span> <span class="token string">"2d"</span><span class="token punctuation">,</span> <span class="token property">"interval"</span><span class="token operator">:</span> <span class="token string">"1d"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return compute_topk_pct_change(${price_json}, k=3)"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[0]} stock news"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[1]} stock news"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[2]} stock news"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return finbert_titles(${news_titles})"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return select_negative(${title_sentiment_map}, top_n=5)"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"slack"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"send_slack_message"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"channel"</span><span class="token operator">:</span> <span class="token string">"news-desk"</span><span class="token punctuation">,</span> <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Top-3: ${top3}. Negative: ${neg_titles}"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"analysis_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"steps"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url ~= '^https?://.*'"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers_url"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = regex_extract_all('[A-Z]{1,5}', content)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = filter_membership(tickers,'NASDAQ100')"</span><span class="token punctuation">,</span><span class="token string">"tickers = unique(tickers)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(tickers) &gt;= 80"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"price_json"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"pct = pct_change_last_day(price_json)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"count_keys(pct) &gt;= 80"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"price_json"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3[]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(top3) == 3"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"top3"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"articles0[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles0 = titles(articles0)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news_titles0) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news_titles0"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"articles1[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles1 = titles(articles1)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news_titles1) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news_titles1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"articles2[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles2 = titles(articles2)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news_titles2) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news_titles2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"title_sentiment_map{title-&gt;score}"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles = concat(news_titles0,news_titles1,news_titles2)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"count_keys(title_sentiment_map) &gt;= len(news_titles)*0.8"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"title_sentiment_map"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"neg_titles[]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"neg_titles = head(neg_titles,5)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"neg_titles"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"neg_titles"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"final_answer_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>
          <span class="token property">"must_include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">,</span> <span class="token string">"neg_titles"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"grounded_from"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">,</span> <span class="token string">"title_sentiment_map"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"quality_criteria"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"relevant headlines"</span><span class="token punctuation">,</span> <span class="token string">"no hallucinated tickers"</span><span class="token punctuation">,</span> <span class="token string">"concise"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"final_reference"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"answer_text"</span><span class="token operator">:</span> <span class="token string">"Top-3 NASDAQ-100 gainers today: NVDA, AMD, META. Notable negative headlines: '…', '…', '…'."</span><span class="token punctuation">,</span>
        <span class="token property">"facts"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"NVDA"</span><span class="token punctuation">,</span><span class="token string">"AMD"</span><span class="token punctuation">,</span><span class="token string">"META"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"…"</span><span class="token punctuation">,</span><span class="token string">"…"</span><span class="token punctuation">,</span><span class="token string">"…"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"citations"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"judge_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"weights"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token number">0.35</span><span class="token punctuation">,</span> <span class="token property">"grounding"</span><span class="token operator">:</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token property">"clarity"</span><span class="token operator">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token property">"safety"</span><span class="token operator">:</span> <span class="token number">0.10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
          <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"grounding"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"clarity"</span><span class="token operator">:</span>  <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"safety"</span><span class="token operator">:</span>   <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"total"</span><span class="token operator">:</span>    <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"coverage"</span><span class="token punctuation">,</span><span class="token string">"grounding"</span><span class="token punctuation">,</span><span class="token string">"clarity"</span><span class="token punctuation">,</span><span class="token string">"safety"</span><span class="token punctuation">,</span><span class="token string">"total"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"target_length_range"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="42-s3-error-histogram-final-answer-includes-decision--justification">4.2 S3 error histogram (final answer includes decision &amp; justification) </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"data_source"</span><span class="token operator">:</span> <span class="token string">"synthetic/llm"</span><span class="token punctuation">,</span>
  <span class="token property">"env_class"</span><span class="token operator">:</span> <span class="token string">"MCPToolEnv"</span><span class="token punctuation">,</span>
  <span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"You have tools aws, python_execution, slack, jira. Emit tool calls as {\"tool\":\"server.tool\",\"arguments\":{...}}. Finish with {\"final_answer\":\"...\"}."</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"Find buckets &gt;10 GB, compute today's error %, post a histogram to Slack, open a Jira ticket if any error % &gt; 1%."</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"reward_spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"rule"</span><span class="token punctuation">,</span>
    <span class="token property">"ground_truth"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"aws_error_histogram_v2"</span><span class="token punctuation">,</span>
      <span class="token property">"complexity"</span><span class="token operator">:</span> <span class="token string">"complex"</span><span class="token punctuation">,</span>
      <span class="token property">"max_turns"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
      <span class="token property">"limits"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"max_servers"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"max_tools"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"tool_sequence"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"aws"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"aws_s3_list_buckets"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return filter_big_buckets(${buckets}, min_gb=10)"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"aws"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"aws_s3_list_objects"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"bucket"</span><span class="token operator">:</span> <span class="token string">"${big_buckets[0]}"</span><span class="token punctuation">,</span> <span class="token property">"prefix"</span><span class="token operator">:</span> <span class="token string">"logs/errors/${today}"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return compute_error_pct(${objects_json})"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"aws"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"aws_s3_list_objects"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"bucket"</span><span class="token operator">:</span> <span class="token string">"${big_buckets[1]}"</span><span class="token punctuation">,</span> <span class="token property">"prefix"</span><span class="token operator">:</span> <span class="token string">"logs/errors/${today}"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return compute_error_pct(${objects_json2})"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return build_histogram(${error_pct_map})"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"slack"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"send_slack_message"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"channel"</span><span class="token operator">:</span> <span class="token string">"ops-alerts"</span><span class="token punctuation">,</span> <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Today's error % distribution"</span><span class="token punctuation">,</span> <span class="token property">"attachments"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"${histogram_path}"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return find_exceedances(${error_pct_map}, threshold=1.0)"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"jira"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"create_ticket"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"project"</span><span class="token operator">:</span> <span class="token string">"OPS"</span><span class="token punctuation">,</span> <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"Buckets &gt;1% errors"</span><span class="token punctuation">,</span> <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Buckets: ${exceed_buckets}"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"slack"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"send_slack_message"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"channel"</span><span class="token operator">:</span> <span class="token string">"ops-alerts"</span><span class="token punctuation">,</span> <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Jira opened for: ${exceed_buckets}"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"analysis_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"steps"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"buckets[]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(buckets) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"buckets"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"big_buckets[]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(big_buckets) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"big_buckets"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"objects_json"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"objects_json"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"error_pct1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"error_pct1 &gt;= 0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"error_pct1"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"objects_json2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"objects_json2"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"error_pct2"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"error_pct_map = merge_map({'${big_buckets[0]}': error_pct1, '${big_buckets[1]}': error_pct2})"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"count_keys(error_pct_map) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"error_pct_map"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"histogram_path"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"histogram_path ~= '^/tmp/.*\\.png$'"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"histogram_path"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"histogram_path"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"exceed_buckets[]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"exceed_buckets"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"jira_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"jira_id ~= '^[A-Z]+-\\d+$'"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"jira_id"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"exceed_buckets"</span> <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"final_answer_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>
          <span class="token property">"must_include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"histogram_path"</span><span class="token punctuation">,</span> <span class="token string">"exceed_buckets"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"grounded_from"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"error_pct_map"</span><span class="token punctuation">,</span><span class="token string">"exceed_buckets"</span><span class="token punctuation">,</span><span class="token string">"jira_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"quality_criteria"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"include only buckets above threshold"</span><span class="token punctuation">,</span> <span class="token string">"valid Jira ID if ticket created"</span><span class="token punctuation">,</span> <span class="token string">"no sensitive info"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"final_reference"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"answer_text"</span><span class="token operator">:</span> <span class="token string">"Histogram posted. Buckets above 1%: logs-prod, archive-east. Jira OPS-1432 created."</span><span class="token punctuation">,</span>
        <span class="token property">"facts"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"exceed_buckets"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"logs-prod"</span><span class="token punctuation">,</span><span class="token string">"archive-east"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"jira_id"</span><span class="token operator">:</span> <span class="token string">"OPS-1432"</span><span class="token punctuation">,</span> <span class="token property">"histogram_path"</span><span class="token operator">:</span> <span class="token string">"/tmp/errs.png"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"citations"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"exceed_buckets"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"jira_id"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"histogram_path"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"judge_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"weights"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token number">0.3</span><span class="token punctuation">,</span> <span class="token property">"grounding"</span><span class="token operator">:</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token property">"clarity"</span><span class="token operator">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token property">"safety"</span><span class="token operator">:</span> <span class="token number">0.1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
          <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"grounding"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"clarity"</span><span class="token operator">:</span>  <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"safety"</span><span class="token operator">:</span>   <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"total"</span><span class="token operator">:</span>    <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"coverage"</span><span class="token punctuation">,</span><span class="token string">"grounding"</span><span class="token punctuation">,</span><span class="token string">"clarity"</span><span class="token punctuation">,</span><span class="token string">"safety"</span><span class="token punctuation">,</span><span class="token string">"total"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"target_length_range"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><hr>
<h2 id="5-how-this-plugs-into-skyrl">5) How this plugs into SkyRL </h2>
<ul>
<li><strong>Dataset</strong>: compact seed prompt + rich <code>ground_truth</code> metadata — exactly how SkyRL expects you to provide data that the env will use for rewards. (<a href="https://skyrl.readthedocs.io/?utm_source=chatgpt.com" title="Welcome to SkyRL's documentation! — SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Environment</strong>: subclass <code>BaseTextEnv</code>, parse tool calls &amp; final answer, call your ToolGroups, compute rewards per turn. This is the documented pattern for multi‑turn tasks with tools and final text (see <strong>Search</strong> example: “agent has n turns, outputs <code>&lt;answer&gt;</code> at the end, receive reward”). (<a href="https://skyrl.readthedocs.io/en/latest/tutorials/new_env.html?utm_source=chatgpt.com" title="Creating a New Environment or Task - SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Training</strong>: run GRPO in SkyRL‑Train exactly like their examples; the final answer reward is just another term. (If you’re using vLLM for rollout, ensure you capture per‑token logprobs and refresh LoRA adapters after updates.)</li>
</ul>
<hr>
<h2 id="6-gotchas--best-practices">6) Gotchas &amp; best practices </h2>
<ul>
<li><strong>Leakage:</strong> never put <code>final_reference</code> in observations; it’s only for reward.</li>
<li><strong>Cost:</strong> cache LAJ calls by <code>(task_id, hash(policy_answer))</code>.</li>
<li><strong>Stability:</strong> start with heavier heuristic weight (e.g., 0.7) and add LAJ (0.3).</li>
<li><strong>Style mismatch:</strong> LAJ should judge <strong>facts &amp; grounding</strong> more than surface style; include <code>facts</code> in the rubric context.</li>
<li><strong>Determinism:</strong> keep DSL deterministic; if a step fails <code>accept_if</code>, penalize and keep going to preserve learning signal.</li>
<li><strong>Search‑style tags (optional):</strong> if you adopt <code>&lt;answer&gt;…&lt;/answer&gt;</code>, add stop strings so sampler cuts generations cleanly (the Search example does this with <code>&lt;/answer&gt;</code>). (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</li>
</ul>
<hr>
<p>If you paste your current <code>generate_with_llm.py</code>, I’ll return a <strong>line‑exact patch</strong> adding:</p>
<ul>
<li>the extended schema,</li>
<li>the MCP execution harness,</li>
<li>the DSL evaluator,</li>
<li>and the <code>final_reference</code> + <code>judge_rubric</code> writing logic.</li>
</ul>
<p>That will give you a <strong>self‑contained</strong> synthetic dataset where <strong>plans are executed, analysis is applied, and reference answers are produced</strong>, ready for <strong>LAJ‑based</strong> final scoring during SkyRL training.</p>
<h1 id="implementation-plan-for-the-data-generator-and-environment-design">Implementation plan for the data generator and environment design </h1>
<p>Below is a <strong>surgical, code‑level plan</strong> to (A) upgrade your <strong><code>src/dataset/llm/generate_with_llm.py</code></strong> so the synthetic agent <strong>actually executes its tool plan</strong> and emits a <strong>ground‑truth final answer</strong>, and (B) implement a <strong>multi‑turn SkyRL environment</strong> that rewards (1) correct tool use + analysis each turn <strong>and</strong> (2) the <strong>final text answer</strong> using <strong>LLM‑as‑a‑Judge (LAJ)</strong> (optionally combined with heuristics).</p>
<p>Where I reference SkyRL behavior, I cite the official docs/examples so your team can confirm alignment:</p>
<ul>
<li><strong>Dataset format</strong> (what each record must contain). (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</li>
<li><strong>BaseTextEnv</strong> interface and how multi‑turn envs are implemented. (<a href="https://skyrl.readthedocs.io/?utm_source=chatgpt.com" title="Welcome to SkyRL's documentation! — SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Tools integration</strong> (ToolGroup, parsing actions, calling tools). (<a href="https://skyrl.readthedocs.io/en/latest/tutorials/new_env.html?utm_source=chatgpt.com" title="Creating a New Environment or Task - SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Multi‑turn final answers</strong> (Search example uses <code>&lt;answer&gt;…&lt;/answer&gt;</code> and stop strings). (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html" title="Multi-Turn RL for Search with SkyRL — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>LLM‑as‑a‑Judge</strong> (reference example + config pattern). (<a href="https://skyrl.readthedocs.io/en/latest/examples/llm_as_a_judge.html" title="LLM as a Judge for GSM8K — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
</ul>
<blockquote>
<p>I reviewed the three files you attached: <code>generate_with_llm.py</code>, <code>mini_agent_trajectories.py</code>, and <code>common.py</code>. They appear abbreviated with ellipses (<code>...</code>). I’ll give <strong>drop‑in code blocks</strong> and <strong>exact insertion points</strong> so you can merge them even if lines don’t match 1:1.</p>
</blockquote>
<hr>
<h2 id="a-upgrade-generate_with_llmpy-to-produce-executed-grounded-final-answers">A) Upgrade <code>generate_with_llm.py</code> to produce <em>executed</em>, <em>grounded</em> final answers </h2>
<p><strong>Goal:</strong> after your LLM proposes a multi‑turn tool plan, <strong>actually run</strong> that plan against your MCP servers (or the same local tool shims you’ll use in the env), apply an <strong>analysis DSL</strong> (extract/compute/select/accept_if), then <strong>compose a reference final answer</strong> from the derived state. The resulting dataset entries add:</p>
<ul>
<li><code>ground_truth.tool_sequence</code> (what to do),</li>
<li><code>ground_truth.analysis_rubric</code> (how to check each step),</li>
<li><strong><code>ground_truth.final_reference</code></strong> (answer text + facts + citations),</li>
<li><strong><code>ground_truth.judge_rubric</code></strong> (weights + JSON schema the env passes to the Judge).</li>
</ul>
<p>SkyRL’s dataset loader wants <strong>compact prompts</strong> + <strong>reward_spec</strong> per sample; the rest is your metadata for the environment to compute rewards. (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</p>
<h3 id="a1-minimal-schema-extension">A.1 Minimal schema extension </h3>
<p>Add two blocks to your task schema + final writer:</p>
<ul>
<li><code>final_answer_requirements</code> (format, must_include, grounded_from, criteria)</li>
<li><code>judge_rubric</code> (weights + structured output schema + optional length range)</li>
</ul>
<blockquote>
<p>These are used for <strong>data generation</strong> (to force the planner to think about the end state) <strong>and</strong> later by the <strong>environment</strong> to score final answers.</p>
</blockquote>
<h4 id="-patch-addreplace-these-pieces-in-srcdatasetllmgenerate_with_llmpy">🔧 Patch: add/replace these pieces in <code>src/dataset/llm/generate_with_llm.py</code> </h4>
<blockquote>
<p><strong>1) Imports &amp; helpers (top of file, after existing imports)</strong></p>
</blockquote>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === NEW: imports for executing plan &amp; composing final ===</span>
<span class="token keyword keyword-from">from</span> dataclasses <span class="token keyword keyword-import">import</span> dataclass
<span class="token keyword keyword-from">from</span> copy <span class="token keyword keyword-import">import</span> deepcopy

<span class="token comment"># If you already have a ToolManager for MCP in your repo, import it here.</span>
<span class="token comment"># Otherwise, you can stub `execute_tool_fqn(tool_fqn: str, params: dict) -&gt; dict`</span>
<span class="token comment"># and later wire it to your MCP client used by the environment.</span>
<span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>tool_manager <span class="token keyword keyword-import">import</span> ToolManager
    MCP_AVAILABLE <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
    MCP_AVAILABLE <span class="token operator">=</span> <span class="token boolean">False</span>
    ToolManager <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre><blockquote>
<p><strong>2) Extend your TASK_SCHEMA (replace/augment your dict)</strong></p>
</blockquote>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>TASK_SCHEMA <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"skyrl_task"</span><span class="token punctuation">,</span>
    <span class="token string">"schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"task_id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"user_prompt"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"complexity"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span> <span class="token string">"enum"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"simple"</span><span class="token punctuation">,</span> <span class="token string">"moderate"</span><span class="token punctuation">,</span> <span class="token string">"complex"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"max_turns"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"tools_available"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"limits"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"tool_sequence"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                <span class="token string">"minItems"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token string">"maxItems"</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
                <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                    <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"step"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"server"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"tool"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"analysis_requirements"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                            <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                                <span class="token string">"extract"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"compute"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"select"</span><span class="token punctuation">:</span>  <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"accept_if"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"next_args_from"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"next_args_from"</span><span class="token punctuation">]</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">,</span> <span class="token string">"server"</span><span class="token punctuation">,</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">,</span> <span class="token string">"analysis_requirements"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"additionalProperties"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"final_answer_requirements"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"format"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># "text" | "markdown" | "json"</span>
                    <span class="token string">"must_include"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"grounded_from"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"quality_criteria"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"format"</span><span class="token punctuation">,</span> <span class="token string">"must_include"</span><span class="token punctuation">,</span> <span class="token string">"grounded_from"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"judge_rubric"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"weights"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>             <span class="token comment"># JSON schema for LAJ structured outputs</span>
                    <span class="token string">"target_length_range"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span> <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span><span class="token string">"integer"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">"minItems"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"maxItems"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"weights"</span><span class="token punctuation">,</span> <span class="token string">"schema"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"task_id"</span><span class="token punctuation">,</span> <span class="token string">"user_prompt"</span><span class="token punctuation">,</span> <span class="token string">"complexity"</span><span class="token punctuation">,</span> <span class="token string">"max_turns"</span><span class="token punctuation">,</span> <span class="token string">"tool_sequence"</span><span class="token punctuation">,</span>
                     <span class="token string">"final_answer_requirements"</span><span class="token punctuation">,</span> <span class="token string">"judge_rubric"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"additionalProperties"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><blockquote>
<p><strong>3) Add an execution record and DSL to evaluate steps</strong> (near bottom or a new section)</p>
</blockquote>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === NEW: Executed plan outputs ===</span>
<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ExecStep</span><span class="token punctuation">:</span>
    step<span class="token punctuation">:</span> <span class="token builtin">int</span>
    tool_fqn<span class="token punctuation">:</span> <span class="token builtin">str</span>
    args<span class="token punctuation">:</span> <span class="token builtin">dict</span>
    result_summary<span class="token punctuation">:</span> <span class="token builtin">dict</span>
    accept_pass<span class="token punctuation">:</span> <span class="token builtin">bool</span>
    checks<span class="token punctuation">:</span> <span class="token builtin">dict</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ExecOut</span><span class="token punctuation">:</span>
    state<span class="token punctuation">:</span> <span class="token builtin">dict</span>
    steps<span class="token punctuation">:</span> List<span class="token punctuation">[</span>ExecStep<span class="token punctuation">]</span>

<span class="token comment"># --- Safe DSL utilities (expand as needed; keep deterministic) ---</span>
<span class="token keyword keyword-def">def</span> <span class="token function">_extract_path</span><span class="token punctuation">(</span>result<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span>Optional<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Supports simple paths like 'field', 'field[]', 'obj[][title]', 'map{key-&gt;val}' summary
    Return (value, ok)
    """</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> path<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"[]"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># list extraction</span>
            key <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-if">if</span> path<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"[][title]"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            key <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"[]"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            items <span class="token operator">=</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>it<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> it <span class="token keyword keyword-in">in</span> items <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"{title-&gt;score}"</span> <span class="token keyword keyword-in">in</span> path<span class="token punctuation">:</span>
            <span class="token comment"># summarized maps from list of items having title/score</span>
            base <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            items <span class="token operator">=</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>it<span class="token punctuation">[</span><span class="token string">"title"</span><span class="token punctuation">]</span><span class="token punctuation">:</span> it<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> it <span class="token keyword keyword-in">in</span> items <span class="token keyword keyword-if">if</span> <span class="token string">"title"</span> <span class="token keyword keyword-in">in</span> it<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>path <span class="token keyword keyword-in">in</span> result<span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">False</span>

<span class="token keyword keyword-def">def</span> <span class="token function">_compute</span><span class="token punctuation">(</span>expr<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Tiny, whitelisted DSL. Examples:
    - "pct = pct_change_last_day(price_json)"
    - "top3 = topk(pct, 3)"
    - "tickers = regex_extract_all('[A-Z]{1,5}', content)"
    - "neg_titles = head(neg_titles, 5)"
    """</span>
    out <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    name<span class="token punctuation">,</span> rhs <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> expr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">pct_change_last_day</span><span class="token punctuation">(</span>price_json<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># price_json: {ticker: [ {open,close,...}, ... ]}</span>
        <span class="token comment"># return {ticker: pct} for last 2 rows</span>
        pct <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-for">for</span> k<span class="token punctuation">,</span> arr <span class="token keyword keyword-in">in</span> price_json<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token keyword keyword-and">and</span> <span class="token string">"close"</span> <span class="token keyword keyword-in">in</span> arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword keyword-and">and</span> <span class="token string">"close"</span> <span class="token keyword keyword-in">in</span> arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                b<span class="token punctuation">,</span> a <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-if">if</span> b <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    pct<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>a <span class="token operator">/</span> b<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span>
        <span class="token keyword keyword-return">return</span> pct
    <span class="token keyword keyword-def">def</span> <span class="token function">topk</span><span class="token punctuation">(</span>d<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> k<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>k_ <span class="token keyword keyword-for">for</span> k_<span class="token punctuation">,</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> kv<span class="token punctuation">:</span> kv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">head</span><span class="token punctuation">(</span>lst<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> lst<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">unique</span><span class="token punctuation">(</span>lst<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">.</span>fromkeys<span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">*</span>lsts<span class="token punctuation">)</span><span class="token punctuation">:</span> out<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">[</span>out<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>_l<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> _l <span class="token keyword keyword-in">in</span> lsts<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword keyword-return">return</span> out
    <span class="token keyword keyword-def">def</span> <span class="token function">count_keys</span><span class="token punctuation">(</span>d<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token number">0</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">regex_extract_all</span><span class="token punctuation">(</span>pattern<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-import">import</span> re
        <span class="token keyword keyword-return">return</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> text <span class="token keyword keyword-or">or</span> <span class="token string">""</span><span class="token punctuation">)</span>
    <span class="token comment"># ---- Eval RHS in controlled namespace ----</span>
    safe_ns <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">**</span>deepcopy<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"pct_change_last_day"</span><span class="token punctuation">:</span> pct_change_last_day<span class="token punctuation">,</span>
        <span class="token string">"topk"</span><span class="token punctuation">:</span> topk<span class="token punctuation">,</span> <span class="token string">"head"</span><span class="token punctuation">:</span> head<span class="token punctuation">,</span> <span class="token string">"unique"</span><span class="token punctuation">:</span> unique<span class="token punctuation">,</span> <span class="token string">"concat"</span><span class="token punctuation">:</span> concat<span class="token punctuation">,</span>
        <span class="token string">"count_keys"</span><span class="token punctuation">:</span> count_keys<span class="token punctuation">,</span> <span class="token string">"regex_extract_all"</span><span class="token punctuation">:</span> regex_extract_all<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># Support calls in the form fn(state_key, ...), where state_key was introduced earlier.</span>
    value <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>rhs<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> safe_ns<span class="token punctuation">)</span>  <span class="token comment"># guarded namespace</span>
    out<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token keyword keyword-return">return</span> out

<span class="token keyword keyword-def">def</span> <span class="token function">_check</span><span class="token punctuation">(</span>cond<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token comment"># e.g., "len(tickers) &gt;= 80", "top_gainer in tickers", "histogram_path ~= '^/tmp/.*\\.png$'"</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">" ~="</span> <span class="token keyword keyword-in">in</span> cond<span class="token punctuation">:</span>
            lhs<span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> cond<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"~="</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-import">import</span> re
            <span class="token keyword keyword-return">return</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"'\""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>cond<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>

<span class="token keyword keyword-def">def</span> <span class="token function">_resolve_placeholders</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Any<span class="token punctuation">:</span>
    <span class="token comment"># Replace ${var} or ${arr[i]} inside params</span>
    <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-import">import</span> re
        <span class="token keyword keyword-def">def</span> <span class="token function">repl</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">:</span>
            key <span class="token operator">=</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r"\$\{([^}]+)\}"</span><span class="token punctuation">,</span> repl<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span> _resolve_placeholders<span class="token punctuation">(</span>v<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> k<span class="token punctuation">,</span> v <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>_resolve_placeholders<span class="token punctuation">(</span>v<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> v <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">]</span>
    <span class="token keyword keyword-return">return</span> obj
</code></pre><blockquote>
<p><strong>4) Execute the plan + build a final reference</strong></p>
</blockquote>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">simulate_plan_and_collect</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> tm<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>ToolManager<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> ExecOut<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Runs tool_sequence with placeholder resolution and applies analysis_requirements
    to produce named state + per-step summaries.
    """</span>
    state<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    exec_steps<span class="token punctuation">:</span> List<span class="token punctuation">[</span>ExecStep<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> step_obj <span class="token keyword keyword-in">in</span> task<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>step_obj<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        tool_fqn <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>step_obj<span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>step_obj<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
        params <span class="token operator">=</span> _resolve_placeholders<span class="token punctuation">(</span>step_obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"params"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> tm <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># If MCP ToolManager not wired yet, just mock a stable shape</span>
            result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"ok"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"echo"</span><span class="token punctuation">:</span> params<span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> tm<span class="token punctuation">.</span>execute_tool<span class="token punctuation">(</span>tool_fqn<span class="token punctuation">,</span> params<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">20.0</span><span class="token punctuation">)</span>

        <span class="token comment"># Apply analysis requirements</span>
        ar <span class="token operator">=</span> step_obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"analysis_requirements"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        updates <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        missing <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        accept <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-for">for</span> need <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"extract"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            val<span class="token punctuation">,</span> ok <span class="token operator">=</span> _extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> need<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> ok<span class="token punctuation">:</span>
                key <span class="token operator">=</span> need<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                updates<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                missing<span class="token punctuation">.</span>append<span class="token punctuation">(</span>need<span class="token punctuation">)</span>
                accept <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"compute"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span> updates<span class="token punctuation">.</span>update<span class="token punctuation">(</span>_compute<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token operator">**</span>updates<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span> accept <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span> updates<span class="token punctuation">.</span>update<span class="token punctuation">(</span>_compute<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token operator">**</span>updates<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span> accept <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword keyword-for">for</span> cond <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"accept_if"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> _check<span class="token punctuation">(</span>cond<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token operator">**</span>updates<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                accept <span class="token operator">=</span> <span class="token boolean">False</span>

        state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>updates<span class="token punctuation">)</span>
        exec_steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ExecStep<span class="token punctuation">(</span>
            step<span class="token operator">=</span>step<span class="token punctuation">,</span> tool_fqn<span class="token operator">=</span>tool_fqn<span class="token punctuation">,</span> args<span class="token operator">=</span>params<span class="token punctuation">,</span>
            result_summary<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"keys"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># keep tiny</span>
            accept_pass<span class="token operator">=</span>accept<span class="token punctuation">,</span>
            checks<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"missing"</span><span class="token punctuation">:</span> missing<span class="token punctuation">,</span> <span class="token string">"updated"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>updates<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> ExecOut<span class="token punctuation">(</span>state<span class="token operator">=</span>state<span class="token punctuation">,</span> steps<span class="token operator">=</span>exec_steps<span class="token punctuation">)</span>

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">compose_reference_answer</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> exec_out<span class="token punctuation">:</span> ExecOut<span class="token punctuation">,</span> client<span class="token punctuation">:</span> AsyncOpenAI<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    far <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token string">"final_answer_requirements"</span><span class="token punctuation">]</span>
    facts <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> exec_out<span class="token punctuation">.</span>state<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> name <span class="token keyword keyword-in">in</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"grounded_from"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token comment"># Compose with a small LLM, STRICT JSON output to reduce drift</span>
    system <span class="token operator">=</span> <span class="token string">"You are a concise analyst. Write the final answer strictly grounded in the provided facts."</span>
    user <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"facts"</span><span class="token punctuation">:</span> facts<span class="token punctuation">,</span>
        <span class="token string">"must_include"</span><span class="token punctuation">:</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"must_include"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"format"</span><span class="token punctuation">:</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"format"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"quality_criteria"</span><span class="token punctuation">:</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"quality_criteria"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># If you prefer determinism or cost-free, you can template instead of calling the LLM.</span>
    resp <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_RESP_MODEL"</span><span class="token punctuation">,</span> <span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        response_format<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"json_object"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        messages<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system<span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    answer_text <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"answer"</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"final_answer"</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>facts<span class="token punctuation">)</span>
    <span class="token comment"># Build simple citations: map each fact name to the last step that updated it</span>
    name_to_step <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>exec_out<span class="token punctuation">.</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> exec_out<span class="token punctuation">.</span>state<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> k <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> name_to_step <span class="token keyword keyword-and">and</span> k <span class="token keyword keyword-in">in</span> s<span class="token punctuation">.</span>checks<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"updated"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                name_to_step<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> s<span class="token punctuation">.</span>step
    citations <span class="token operator">=</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span> <span class="token punctuation">[</span>name_to_step<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> name_to_step<span class="token punctuation">.</span>get<span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span><span class="token string">"answer_text"</span><span class="token punctuation">:</span> answer_text<span class="token punctuation">,</span> <span class="token string">"facts"</span><span class="token punctuation">:</span> facts<span class="token punctuation">,</span> <span class="token string">"citations"</span><span class="token punctuation">:</span> citations<span class="token punctuation">}</span>
</code></pre><blockquote>
<p><strong>5) Thread it into your existing <code>_one_task(...)</code> flow</strong> (after you get the <em>planned</em> <code>task</code> from the LLM)</p>
</blockquote>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_one_task</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> _call_llm_with_schema<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> TASK_SCHEMA<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>   <span class="token comment"># your existing planner call</span>
    task <span class="token operator">=</span> _verify_and_repair<span class="token punctuation">(</span>task<span class="token punctuation">)</span>  <span class="token comment"># ensure next_args_from chains exist (implement simple checks)</span>

    tm <span class="token operator">=</span> ToolManager<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> MCP_AVAILABLE <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span>  <span class="token comment"># wire to MCP servers if available</span>
    exec_out <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> simulate_plan_and_collect<span class="token punctuation">(</span>task<span class="token punctuation">,</span> tm<span class="token punctuation">)</span>

    openai_client <span class="token operator">=</span> AsyncOpenAI<span class="token punctuation">(</span>api_key<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    final_ref <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> compose_reference_answer<span class="token punctuation">(</span>task<span class="token punctuation">,</span> exec_out<span class="token punctuation">,</span> openai_client<span class="token punctuation">)</span>

    task<span class="token punctuation">[</span><span class="token string">"_exec_out"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>asdict<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> exec_out<span class="token punctuation">.</span>steps<span class="token punctuation">]</span><span class="token punctuation">}</span>  <span class="token comment"># optional, keep tiny</span>
    task<span class="token punctuation">[</span><span class="token string">"_final_reference"</span><span class="token punctuation">]</span> <span class="token operator">=</span> final_ref
    <span class="token keyword keyword-return">return</span> task
</code></pre><blockquote>
<p><strong>6) Write the SkyRL‑compatible record</strong> (modify your writer)</p>
</blockquote>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">to_skyrl_sample</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> system_prompt<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> env_class<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> data_source<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    prompt_messages <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>   <span class="token string">"content"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"user_prompt"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
    ground_truth <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"task_id"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"task_id"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"complexity"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"complexity"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"max_turns"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"max_turns"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"limits"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"limits"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"tool_sequence"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"analysis_rubric"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span><span class="token string">"step"</span><span class="token punctuation">:</span> s<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">**</span>s<span class="token punctuation">[</span><span class="token string">"analysis_requirements"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
                <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> task<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"final_answer_requirements"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"final_answer_requirements"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"final_reference"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"_final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"judge_rubric"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"judge_rubric"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
        <span class="token string">"data_source"</span><span class="token punctuation">:</span> data_source<span class="token punctuation">,</span>
        <span class="token string">"env_class"</span><span class="token punctuation">:</span> env_class<span class="token punctuation">,</span>
        <span class="token string">"prompt"</span><span class="token punctuation">:</span> prompt_messages<span class="token punctuation">,</span>
        <span class="token string">"reward_spec"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"method"</span><span class="token punctuation">:</span> <span class="token string">"rule"</span><span class="token punctuation">,</span> <span class="token string">"ground_truth"</span><span class="token punctuation">:</span> ground_truth<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"extra_info"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"gen"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"model"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_model"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"backend"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_backend"</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><p><strong>That’s all you need</strong> on the data‑gen side. Each sample is now <strong>grounded</strong>: the plan was <strong>executed</strong>, the <strong>state</strong> was derived by your DSL, and a <strong>reference final answer</strong> exists for the <strong>Judge</strong> to compare against during training. (Dataset remains within the SkyRL format: minimal prompt + <code>reward_spec</code> — everything else lives under ground_truth for env reward.) (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</p>
<hr>
<h2 id="b-implement-the-multiturn-environment-with-perturn-rewards--final-text-reward">B) Implement the <strong>multi‑turn environment</strong> with <strong>per‑turn rewards</strong> + <strong>final text reward</strong> </h2>
<p>Create <strong><code>src/envs/mcp_tool_env.py</code></strong> (or extend your existing one) as a subclass of <code>BaseTextEnv</code> (text‑in/text‑out). In each step:</p>
<ol>
<li>
<p><strong>Parse action</strong>:</p>
<ul>
<li>either a <strong>tool call</strong>: <code>{"tool":"server.tool","arguments":{...}}</code></li>
<li>or a <strong>final answer</strong>: <code>{"final_answer":"…text…"}</code><br>
(You can also allow <code>&lt;answer&gt;…&lt;/answer&gt;</code> or <code>&lt;tool&gt;…&lt;/tool&gt;</code> tags; if you do, add <strong>stop strings</strong> like the Search example: <code>stop='["&lt;/tool&gt;", "&lt;/answer&gt;"]'</code> in generator sampling.) (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html" title="Multi-Turn RL for Search with SkyRL — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
</ul>
</li>
<li>
<p><strong>Tool step</strong>:</p>
<ul>
<li>resolve placeholders from the <strong>current named state</strong>, call the right ToolGroup method, run <strong>analysis rubric</strong>: <code>extract/compute/select/accept_if/next_args_from</code>.</li>
<li>compute <strong>shaped reward</strong> (+ penalties if malformed).</li>
</ul>
</li>
<li>
<p><strong>Final step</strong>:</p>
<ul>
<li>compute <strong>Heuristic</strong> score (coverage/grounding/clarity/safety vs the requirements + reference facts).</li>
<li>compute <strong>LAJ</strong> score by sending a compact rubric to the Judge model with <strong>structured outputs</strong> (numbers‑only). SkyRL already documents the judge pattern (for GSM8K) — we just do a graded version with multiple dimensions. (<a href="https://skyrl.readthedocs.io/en/latest/examples/llm_as_a_judge.html" title="LLM as a Judge for GSM8K — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
</ul>
</li>
</ol>
<p>Here’s a concise implementation skeleton:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># src/envs/mcp_tool_env.py</span>
<span class="token keyword keyword-from">from</span> __future__ <span class="token keyword keyword-import">import</span> annotations
<span class="token keyword keyword-import">import</span> json<span class="token punctuation">,</span> re<span class="token punctuation">,</span> os<span class="token punctuation">,</span> asyncio
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Any<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Tuple<span class="token punctuation">,</span> Optional
<span class="token keyword keyword-from">from</span> skyrl_gym<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>base_text_env <span class="token keyword keyword-import">import</span> BaseTextEnv<span class="token punctuation">,</span> BaseTextEnvStepOutput  <span class="token comment"># API per docs</span>
<span class="token keyword keyword-from">from</span> skyrl_gym<span class="token punctuation">.</span>tools<span class="token punctuation">.</span>core <span class="token keyword keyword-import">import</span> ToolGroup  <span class="token comment"># or your ToolManager wrappers</span>
<span class="token keyword keyword-from">from</span> openai <span class="token keyword keyword-import">import</span> AsyncOpenAI

<span class="token keyword keyword-class">class</span> <span class="token class-name">MCPToolEnv</span><span class="token punctuation">(</span>BaseTextEnv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Multi-turn, multi-tool env that also rewards a final text answer."""</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> env_config<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> extras<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>turn <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>max_turns <span class="token operator">=</span> <span class="token punctuation">(</span>env_config <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"max_turns"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>reward_weights <span class="token operator">=</span> <span class="token punctuation">(</span>env_config <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"reward_weights"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token string">"tool_name"</span><span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token string">"param_binding"</span><span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token string">"extract"</span><span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
            <span class="token string">"compute"</span><span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token string">"accept_if"</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token string">"penalty"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
            <span class="token string">"final_heur"</span><span class="token punctuation">:</span> <span class="token number">0.6</span><span class="token punctuation">,</span> <span class="token string">"final_laj"</span><span class="token punctuation">:</span> <span class="token number">0.4</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment"># Initialize ToolGroups (search, python, finance, slack, etc.)</span>
        <span class="token comment"># Or bridge to your MCP servers if you already have a ToolManager.</span>
        self<span class="token punctuation">.</span>init_tool_groups<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_make_tool_groups<span class="token punctuation">(</span>extras <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># Judge</span>
        self<span class="token punctuation">.</span>judge <span class="token operator">=</span> AsyncOpenAI<span class="token punctuation">(</span>api_key<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Set by init()</span>
        self<span class="token punctuation">.</span>gt <span class="token operator">=</span> <span class="token boolean">None</span>            <span class="token comment"># ground_truth (dict from reward_spec)</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>           <span class="token comment"># named values we derive per step</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_make_tool_groups</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> extras<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>ToolGroup<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># TODO: return actual tool groups; you can wrap MCP servers as ToolGroup adapters</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># ---------- BaseTextEnv API ----------</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">init</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> prompt<span class="token punctuation">,</span> ground_truth<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Called once per episode with the dataset prompt and its ground_truth from reward_spec.
        """</span>
        self<span class="token punctuation">.</span>turn <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>gt <span class="token operator">=</span> ground_truth <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-return">return</span> prompt<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"task_id"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"task_id"</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BaseTextEnvStepOutput<span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>turn <span class="token operator">+=</span> <span class="token number">1</span>
        kind<span class="token punctuation">,</span> payload <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_action<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> kind <span class="token operator">==</span> <span class="token string">"tool"</span><span class="token punctuation">:</span>
            tool_fqn<span class="token punctuation">,</span> args <span class="token operator">=</span> payload<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"arguments"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token comment"># Execute the tool via BaseTextEnv helper</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                group_name<span class="token punctuation">,</span> tool_name <span class="token operator">=</span> tool_fqn<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                obs <span class="token operator">=</span> self<span class="token punctuation">.</span>_execute_tool<span class="token punctuation">(</span>group_name<span class="token punctuation">,</span> tool_name<span class="token punctuation">,</span> <span class="token punctuation">[</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># returns serializable result</span>
            <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                <span class="token comment"># malformed tool -&gt; penalty, continue</span>
                <span class="token keyword keyword-return">return</span> BaseTextEnvStepOutput<span class="token punctuation">(</span>
                    observations<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    reward<span class="token operator">=</span>self<span class="token punctuation">.</span>reward_weights<span class="token punctuation">[</span><span class="token string">"penalty"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    done<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>turn <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>max_turns<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"tool_exec"</span><span class="token punctuation">,</span> <span class="token string">"exception"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span>
                <span class="token punctuation">)</span>
            <span class="token comment"># Apply analysis rubric for this step (if present)</span>
            step_idx <span class="token operator">=</span> self<span class="token punctuation">.</span>_match_step<span class="token punctuation">(</span>tool_fqn<span class="token punctuation">)</span>
            r_step<span class="token punctuation">,</span> meta <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_tool_step<span class="token punctuation">(</span>step_idx<span class="token punctuation">,</span> tool_fqn<span class="token punctuation">,</span> args<span class="token punctuation">,</span> obs<span class="token punctuation">)</span>
            done <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>turn <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>max_turns<span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> BaseTextEnvStepOutput<span class="token punctuation">(</span>
                observations<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>obs<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                reward<span class="token operator">=</span>r_step<span class="token punctuation">,</span>
                done<span class="token operator">=</span>done<span class="token punctuation">,</span>
                metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"step"</span><span class="token punctuation">:</span> step_idx<span class="token punctuation">,</span> <span class="token operator">**</span>meta<span class="token punctuation">}</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># Final answer branch</span>
        final_text <span class="token operator">=</span> payload
        r_final<span class="token punctuation">,</span> meta <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>_score_final<span class="token punctuation">(</span>final_text<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> BaseTextEnvStepOutput<span class="token punctuation">(</span>
            observations<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            reward<span class="token operator">=</span>r_final<span class="token punctuation">,</span>
            done<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"final"</span><span class="token punctuation">:</span> meta<span class="token punctuation">}</span>
        <span class="token punctuation">)</span>

    <span class="token comment"># ---------- Parsing ----------</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">_parse_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># JSON first</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            obj <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"tool"</span> <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> obj<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"arguments"</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"arguments"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"final_answer"</span> <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token string">"final"</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span><span class="token string">"final_answer"</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword keyword-pass">pass</span>
        <span class="token comment"># Tag-style, compatible with Search pattern</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"&lt;answer&gt;"</span> <span class="token keyword keyword-in">in</span> text <span class="token keyword keyword-and">and</span> <span class="token string">"&lt;/answer&gt;"</span> <span class="token keyword keyword-in">in</span> text<span class="token punctuation">:</span>
            ans <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;answer&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;/answer&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"final"</span><span class="token punctuation">,</span> ans
        <span class="token keyword keyword-if">if</span> <span class="token string">"&lt;tool&gt;"</span> <span class="token keyword keyword-in">in</span> text <span class="token keyword keyword-and">and</span> <span class="token string">"&lt;/tool&gt;"</span> <span class="token keyword keyword-in">in</span> text<span class="token punctuation">:</span>
            inner <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;tool&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;/tool&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            m <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"&lt;([a-zA-Z0-9_.-]+)&gt;(.*)&lt;/\\1&gt;"</span><span class="token punctuation">,</span> inner<span class="token punctuation">,</span> re<span class="token punctuation">.</span>DOTALL<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> m<span class="token punctuation">:</span>
                name<span class="token punctuation">,</span> args_text <span class="token operator">=</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                    args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>args_text<span class="token punctuation">)</span>
                <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
                    args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"raw"</span><span class="token punctuation">:</span> args_text<span class="token punctuation">}</span>
                <span class="token keyword keyword-return">return</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span> <span class="token string">"arguments"</span><span class="token punctuation">:</span> args<span class="token punctuation">}</span>
        <span class="token comment"># Default: treat as final free text</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"final"</span><span class="token punctuation">,</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># ---------- Rewarding ----------</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">_match_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tool_fqn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tool_sequence"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>s<span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>s<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span> <span class="token operator">==</span> tool_fqn<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>turn  <span class="token comment"># fallback</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_score_tool_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> step_idx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> tool_fqn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> args<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> result<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        ar <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"analysis_rubric"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"steps"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> step_idx<span class="token punctuation">:</span>
                ar <span class="token operator">=</span> s<span class="token punctuation">;</span> <span class="token keyword keyword-break">break</span>
        <span class="token keyword keyword-if">if</span> ar <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># No rubric -&gt; small neutral reward</span>
            <span class="token keyword keyword-return">return</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"warn"</span><span class="token punctuation">:</span> <span class="token string">"no_rubric"</span><span class="token punctuation">}</span>

        reward <span class="token operator">=</span> <span class="token number">0.0</span>
        meta <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"tool"</span><span class="token punctuation">:</span> tool_fqn<span class="token punctuation">,</span> <span class="token string">"args"</span><span class="token punctuation">:</span> args<span class="token punctuation">,</span> <span class="token string">"accept_if"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

        <span class="token comment"># Tool choice reward</span>
        expected_fqn <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword keyword-for">for</span> st <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>st<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> step_idx<span class="token punctuation">:</span>
                expected_fqn <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>st<span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>st<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">;</span> <span class="token keyword keyword-break">break</span>
        <span class="token keyword keyword-if">if</span> expected_fqn <span class="token operator">==</span> tool_fqn<span class="token punctuation">:</span>
            reward <span class="token operator">+=</span> self<span class="token punctuation">.</span>reward_weights<span class="token punctuation">[</span><span class="token string">"tool_name"</span><span class="token punctuation">]</span>

        <span class="token comment"># Param binding reward (did args use the prior state's 'next_args_from' value?)</span>
        naf <span class="token operator">=</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"next_args_from"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> naf<span class="token punctuation">:</span>
            used <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> naf <span class="token keyword keyword-in">in</span> used<span class="token punctuation">:</span>
                reward <span class="token operator">+=</span> self<span class="token punctuation">.</span>reward_weights<span class="token punctuation">[</span><span class="token string">"param_binding"</span><span class="token punctuation">]</span>

        <span class="token comment"># Extract</span>
        ext_ok <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-for">for</span> need <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"extract"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            val <span class="token operator">=</span> self<span class="token punctuation">.</span>_extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> need<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-if">if</span> val <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span> ext_ok <span class="token operator">=</span> <span class="token boolean">False</span>
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>state<span class="token punctuation">[</span>need<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
        <span class="token keyword keyword-if">if</span> ext_ok<span class="token punctuation">:</span> reward <span class="token operator">+=</span> self<span class="token punctuation">.</span>reward_weights<span class="token punctuation">[</span><span class="token string">"extract"</span><span class="token punctuation">]</span>

        <span class="token comment"># Compute/select</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"compute"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_compute<span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_compute<span class="token punctuation">(</span>expr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            reward <span class="token operator">+=</span> self<span class="token punctuation">.</span>reward_weights<span class="token punctuation">[</span><span class="token string">"compute"</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword keyword-pass">pass</span>

        <span class="token comment"># accept_if</span>
        all_ok <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-for">for</span> cond <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"accept_if"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            ok <span class="token operator">=</span> self<span class="token punctuation">.</span>_check<span class="token punctuation">(</span>cond<span class="token punctuation">)</span>
            meta<span class="token punctuation">[</span><span class="token string">"accept_if"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"cond"</span><span class="token punctuation">:</span> cond<span class="token punctuation">,</span> <span class="token string">"ok"</span><span class="token punctuation">:</span> ok<span class="token punctuation">}</span><span class="token punctuation">)</span>
            all_ok <span class="token operator">=</span> all_ok <span class="token keyword keyword-and">and</span> ok
        <span class="token keyword keyword-if">if</span> all_ok<span class="token punctuation">:</span> reward <span class="token operator">+=</span> self<span class="token punctuation">.</span>reward_weights<span class="token punctuation">[</span><span class="token string">"accept_if"</span><span class="token punctuation">]</span>

        <span class="token keyword keyword-return">return</span> reward<span class="token punctuation">,</span> meta

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_score_final</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># Heuristic</span>
        h_score<span class="token punctuation">,</span> h_meta <span class="token operator">=</span> self<span class="token punctuation">.</span>_score_final_heur<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        <span class="token comment"># LAJ</span>
        j_score<span class="token punctuation">,</span> j_meta <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>_score_final_laj<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
        w <span class="token operator">=</span> self<span class="token punctuation">.</span>reward_weights
        total <span class="token operator">=</span> w<span class="token punctuation">[</span><span class="token string">"final_heur"</span><span class="token punctuation">]</span> <span class="token operator">*</span> h_score <span class="token operator">+</span> w<span class="token punctuation">[</span><span class="token string">"final_laj"</span><span class="token punctuation">]</span> <span class="token operator">*</span> j_score
        <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"heur"</span><span class="token punctuation">:</span> h_meta<span class="token punctuation">,</span> <span class="token string">"laj"</span><span class="token punctuation">:</span> j_meta<span class="token punctuation">}</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_score_final_heur</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        far <span class="token operator">=</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">[</span><span class="token string">"analysis_rubric"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"final_answer_requirements"</span><span class="token punctuation">]</span>
        jr  <span class="token operator">=</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">[</span><span class="token string">"judge_rubric"</span><span class="token punctuation">]</span>
        weights <span class="token operator">=</span> jr<span class="token punctuation">[</span><span class="token string">"weights"</span><span class="token punctuation">]</span>
        lo<span class="token punctuation">,</span> hi <span class="token operator">=</span> <span class="token punctuation">(</span>jr<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"target_length_range"</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Coverage: all must_include items appear or can be verified from state</span>
        must <span class="token operator">=</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"must_include"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        cov_hits <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> must <span class="token keyword keyword-if">if</span> k <span class="token keyword keyword-in">in</span> text <span class="token keyword keyword-or">or</span> k <span class="token keyword keyword-in">in</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        coverage <span class="token operator">=</span> cov_hits <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>must<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># Grounding: mentions consistent with reference facts</span>
        facts <span class="token operator">=</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"facts"</span><span class="token punctuation">]</span>
        grounding <span class="token operator">=</span> self<span class="token punctuation">.</span>_grounding_score<span class="token punctuation">(</span>text<span class="token punctuation">,</span> facts<span class="token punctuation">)</span>

        <span class="token comment"># Clarity: simple length band</span>
        words <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        clarity <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token keyword keyword-if">if</span> lo <span class="token operator">&lt;=</span> words <span class="token operator">&lt;=</span> hi <span class="token keyword keyword-else">else</span> <span class="token number">0.5</span> <span class="token keyword keyword-if">if</span> <span class="token punctuation">(</span><span class="token number">0.7</span><span class="token operator">*</span>lo<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> words <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token number">1.5</span><span class="token operator">*</span>hi<span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token number">0.0</span>

        <span class="token comment"># Safety: simple heuristic</span>
        safety <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"\b(SSN|password|api_key)\b"</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>I<span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token number">0.0</span>

        total <span class="token operator">=</span> <span class="token punctuation">(</span>weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"coverage"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>coverage <span class="token operator">+</span>
                 weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"grounding"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>grounding <span class="token operator">+</span>
                 weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"clarity"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>clarity <span class="token operator">+</span>
                 weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"safety"</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">*</span>safety<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"coverage"</span><span class="token punctuation">:</span>coverage<span class="token punctuation">,</span> <span class="token string">"grounding"</span><span class="token punctuation">:</span>grounding<span class="token punctuation">,</span> <span class="token string">"clarity"</span><span class="token punctuation">:</span>clarity<span class="token punctuation">,</span> <span class="token string">"safety"</span><span class="token punctuation">:</span>safety<span class="token punctuation">}</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_score_final_laj</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># Compact state summary + reference</span>
        facts <span class="token operator">=</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"facts"</span><span class="token punctuation">]</span>
        ref   <span class="token operator">=</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"answer_text"</span><span class="token punctuation">]</span>
        schema <span class="token operator">=</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">[</span><span class="token string">"judge_rubric"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"schema"</span><span class="token punctuation">]</span>
        rubric_prompt <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"instructions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"Score the FINAL answer vs the reference &amp; facts."</span><span class="token punctuation">,</span>
                <span class="token string">"Return ONLY JSON with fields in the provided schema."</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"facts"</span><span class="token punctuation">:</span> facts<span class="token punctuation">,</span> <span class="token string">"reference"</span><span class="token punctuation">:</span> ref<span class="token punctuation">,</span> <span class="token string">"final"</span><span class="token punctuation">:</span> text
        <span class="token punctuation">}</span>
        resp <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> self<span class="token punctuation">.</span>judge<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
            model<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_JUDGE_MODEL"</span><span class="token punctuation">,</span> <span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            response_format<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"json_schema"</span><span class="token punctuation">,</span> <span class="token string">"json_schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"judge_schema"</span><span class="token punctuation">,</span><span class="token string">"schema"</span><span class="token punctuation">:</span> schema<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            messages<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"system"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span><span class="token string">"You are a strict evaluator."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>rubric_prompt<span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            temperature<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"total"</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data

    <span class="token comment"># --- local copies of DSL helpers (same semantics as generator) ---</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">_extract_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> res<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> _extract_path<span class="token punctuation">(</span>res<span class="token punctuation">,</span> path<span class="token punctuation">)</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">_compute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> expr<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> _compute<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">_check</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cond<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token keyword keyword-return">return</span> _check<span class="token punctuation">(</span>cond<span class="token punctuation">,</span> self<span class="token punctuation">.</span>state<span class="token punctuation">)</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">_grounding_score</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> facts<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
        <span class="token comment"># Example: enforce that any ticker in text belongs to facts['top3'] if that exists</span>
        <span class="token keyword keyword-import">import</span> re
        <span class="token keyword keyword-if">if</span> <span class="token string">"top3"</span> <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">:</span>
            mentions <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"\b[A-Z]{1,5}\b"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span>
            target <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>facts<span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> mentions<span class="token punctuation">:</span> <span class="token keyword keyword-return">return</span> <span class="token number">0.5</span>  <span class="token comment"># neutral</span>
            ok <span class="token operator">=</span> <span class="token builtin">all</span><span class="token punctuation">(</span>m <span class="token keyword keyword-in">in</span> target <span class="token keyword keyword-for">for</span> m <span class="token keyword keyword-in">in</span> mentions <span class="token keyword keyword-if">if</span> m<span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token number">1.0</span> <span class="token keyword keyword-if">if</span> ok <span class="token keyword keyword-else">else</span> <span class="token number">0.0</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">0.5</span>
</code></pre><ul>
<li>This adheres to the <strong>BaseTextEnv</strong> interface (returning <code>BaseTextEnvStepOutput</code>) and integrates <strong>ToolGroups</strong> the same way the docs show. (<a href="https://skyrl.readthedocs.io/?utm_source=chatgpt.com" title="Welcome to SkyRL's documentation! — SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li>If you choose to use tags (<code>&lt;answer&gt;</code>), add <code>generator.sampling_params.stop='["&lt;/tool&gt;", "&lt;/answer&gt;"]'</code> in your training configs, same as the <strong>Search</strong> example. (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html" title="Multi-Turn RL for Search with SkyRL — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
<li>If you prefer <strong>JSON‑only</strong> actions, you can skip stop strings.</li>
</ul>
<hr>
<h2 id="c-sample-dataset-items-now-with-final_reference--judge_rubric">C) Sample dataset items (now with <code>final_reference</code> + <code>judge_rubric</code>) </h2>
<p>Put these in <code>data/processed/train_llm.json</code> along with your existing records; they use the same shape your environment expects:</p>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"data_source"</span><span class="token operator">:</span> <span class="token string">"synthetic/llm"</span><span class="token punctuation">,</span>
  <span class="token property">"env_class"</span><span class="token operator">:</span> <span class="token string">"MCPToolEnv"</span><span class="token punctuation">,</span>
  <span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"You have tools DuckDuckGo, yahoo_finance, python_execution, slack. Use {\"tool\":\"server.tool\",\"arguments\":{...}}. Finish with {\"final_answer\":\"...\"}."</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"Find top-3 NASDAQ-100 gainers today, collect 5 headlines each, select negative ones, and post a brief digest."</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"reward_spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"rule"</span><span class="token punctuation">,</span>
    <span class="token property">"ground_truth"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"nasdaq100_neg_digest_v2"</span><span class="token punctuation">,</span>
      <span class="token property">"complexity"</span><span class="token operator">:</span> <span class="token string">"complex"</span><span class="token punctuation">,</span>
      <span class="token property">"max_turns"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
      <span class="token property">"limits"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"max_servers"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"max_tools"</span><span class="token operator">:</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"tool_sequence"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"NASDAQ-100 components list"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers_url"</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url ~= '^https?://.*'"</span><span class="token punctuation">]</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"fetch_content"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"${tickers_url}"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = regex_extract_all('[A-Z]{1,5}', content)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = unique(tickers)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(tickers) &gt;= 80"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"yahoo_finance"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"get_yfinance_price_history"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"ticker"</span><span class="token operator">:</span> <span class="token string">"${tickers}"</span><span class="token punctuation">,</span> <span class="token property">"period"</span><span class="token operator">:</span> <span class="token string">"2d"</span><span class="token punctuation">,</span> <span class="token property">"interval"</span><span class="token operator">:</span> <span class="token string">"1d"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"price_json"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"pct = pct_change_last_day(price_json)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"count_keys(pct) &gt;= 80"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"price_json"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return compute_topk_pct_change(${price_json}, k=3)"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3[]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(top3) == 3"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"top3"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[0]} stock news"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"articles0[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles0 = titles(articles0)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news_titles0) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news_titles0"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[1]} stock news"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"articles1[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles1 = titles(articles1)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news_titles1) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news_titles1"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"DuckDuckGo"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[2]} stock news"</span><span class="token punctuation">,</span> <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"articles2[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles2 = titles(articles2)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news_titles2) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news_titles2"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return finbert_titles(${news_titles})"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"title_sentiment_map{title-&gt;score}"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news_titles = concat(news_titles0,news_titles1,news_titles2)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"count_keys(title_sentiment_map) &gt;= len(news_titles)*0.8"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"title_sentiment_map"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"return select_negative(${title_sentiment_map}, top_n=5)"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"neg_titles[]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"neg_titles = head(neg_titles,5)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"neg_titles"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span> <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"slack"</span><span class="token punctuation">,</span> <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"send_slack_message"</span><span class="token punctuation">,</span> <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"channel"</span><span class="token operator">:</span> <span class="token string">"news-desk"</span><span class="token punctuation">,</span> <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Top-3: ${top3}. Negative: ${neg_titles}"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"neg_titles"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"analysis_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"steps"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"final_answer_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>
          <span class="token property">"must_include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">,</span> <span class="token string">"neg_titles"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"grounded_from"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">,</span> <span class="token string">"title_sentiment_map"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"quality_criteria"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"relevant headlines"</span><span class="token punctuation">,</span> <span class="token string">"no hallucinated tickers"</span><span class="token punctuation">,</span> <span class="token string">"concise &lt;=120 words"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"final_reference"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"answer_text"</span><span class="token operator">:</span> <span class="token string">"Top-3: NVDA, AMD, META. Negative headlines: '…', '…'."</span><span class="token punctuation">,</span>
        <span class="token property">"facts"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"NVDA"</span><span class="token punctuation">,</span><span class="token string">"AMD"</span><span class="token punctuation">,</span><span class="token string">"META"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"…"</span><span class="token punctuation">,</span><span class="token string">"…"</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"citations"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"judge_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"weights"</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token number">0.35</span><span class="token punctuation">,</span> <span class="token property">"grounding"</span><span class="token operator">:</span> <span class="token number">0.4</span><span class="token punctuation">,</span> <span class="token property">"clarity"</span><span class="token operator">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span> <span class="token property">"safety"</span><span class="token operator">:</span> <span class="token number">0.10</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"target_length_range"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">40</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
          <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"grounding"</span><span class="token operator">:</span><span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"clarity"</span><span class="token operator">:</span>  <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"safety"</span><span class="token operator">:</span>   <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"total"</span><span class="token operator">:</span>    <span class="token punctuation">{</span><span class="token property">"type"</span><span class="token operator">:</span><span class="token string">"number"</span><span class="token punctuation">,</span><span class="token property">"minimum"</span><span class="token operator">:</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token property">"maximum"</span><span class="token operator">:</span><span class="token number">1</span><span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"coverage"</span><span class="token punctuation">,</span><span class="token string">"grounding"</span><span class="token punctuation">,</span><span class="token string">"clarity"</span><span class="token punctuation">,</span><span class="token string">"safety"</span><span class="token punctuation">,</span><span class="token string">"total"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>This conforms to SkyRL’s dataset contract (compact prompt + env_class + reward_spec), leaving your <strong>long‑horizon supervision</strong> under <code>ground_truth</code>. (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</p>
<hr>
<h2 id="d-training-knobs-to-make-multiturn--final-answer-work-smoothly">D) Training knobs to make multi‑turn + final answer work smoothly </h2>
<ul>
<li>If you adopt <strong>tag‑style</strong> final answers or tool calls (e.g., <code>&lt;answer&gt;…&lt;/answer&gt;</code>), set <strong>stop strings</strong> in generator sampling the same way the <strong>Search</strong> example does:<br>
<code>generator.sampling_params.stop='["&lt;/tool&gt;", "&lt;/answer&gt;"]'</code> (or <code>"&lt;/search&gt;"</code>/<code>"&lt;/answer&gt;"</code>). (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html" title="Multi-Turn RL for Search with SkyRL — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
<li>Keep <strong><code>generator.async_engine=true</code></strong> and <strong><code>generator.batched=false</code></strong> for <strong>multi‑turn</strong> async rollouts (again per Search). (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html" title="Multi-Turn RL for Search with SkyRL — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
<li>Judge model and policy model can be separate; see <strong>LLM‑as‑a‑Judge</strong> example for using an OpenAI model for the judge while training a Qwen policy. (<a href="https://skyrl.readthedocs.io/en/latest/examples/llm_as_a_judge.html" title="LLM as a Judge for GSM8K — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
</ul>
<hr>
<h2 id="e-why-this-is-mathematically-sound-grpoppo">E) Why this is mathematically sound (GRPO/PPO) </h2>
<p>You’re maximizing expected return (\mathbb{E}_\pi[\sum_t r_t]) where:</p>
<ul>
<li>(r_1,\dots,r_K) = <strong>shaped instrumented rewards</strong> (tool choice, param binding, extraction success, computations, accept_if), and</li>
<li>(r_{K+1} = \lambda_h \cdot r^{\text{heur}}(y_T) + \lambda_j \cdot r^{\text{LAJ}}(y_T, y^<em>)) is the <strong>terminal reward</strong> for the final text, with (y_T) the policy’s output and (y^</em>) the reference.<br>
LAJ returns a <strong>numeric</strong> score (0–1), so it slots directly into the return — this is exactly what the <strong>SkyRL LLM‑as‑a‑Judge</strong> example does (for GSM8K it’s binary, we generalize to graded). (<a href="https://skyrl.readthedocs.io/en/latest/examples/llm_as_a_judge.html" title="LLM as a Judge for GSM8K — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
</ul>
<hr>
<h2 id="f-sanity-tests-you-can-add-right-now">F) Sanity tests you can add right now </h2>
<ul>
<li><strong>Unit test</strong>: pass a fake step with <code>extract=["content"]</code> → ensure <code>self.state["content"]</code> updated and reward includes <code>extract</code> term.</li>
<li><strong>Final answer test</strong>: with <code>facts = {"top3": ["NVDA"]}</code>, final text <code>"Top-3: NVDA"</code> → coverage=1, grounding=1 → reward close to weights sum.</li>
<li><strong>Judge smoke</strong>: mock the OpenAI response to return <code>{"coverage":1,"grounding":1,"clarity":1,"safety":1,"total":1}</code> and ensure reward path works offline.</li>
</ul>
<hr>
<h2 id="g-where-this-maps-to-the-skyrl-documentation">G) Where this maps to the SkyRL documentation </h2>
<ul>
<li><strong>Create env</strong> with <strong>BaseTextEnv</strong>, define <code>step</code> that parses tool calls and final answers → “Creating a New Environment” tutorial (and the <code>BaseTextEnv</code> API excerpt). (<a href="https://skyrl.readthedocs.io/?utm_source=chatgpt.com" title="Welcome to SkyRL's documentation! — SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Use ToolGroups</strong> and <code>_execute_tool</code> → “Using Tools in SkyRL‑Gym” (core concepts, ToolGroup, env integration, action parsing). (<a href="https://skyrl.readthedocs.io/en/latest/tutorials/new_env.html?utm_source=chatgpt.com" title="Creating a New Environment or Task - SkyRL documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Multi‑turn with final answer</strong> and <strong>stop strings</strong> → “Multi‑Turn RL for Search” example and run config. (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html" title="Multi-Turn RL for Search with SkyRL — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Judge integration</strong> → “LLM as a Judge for GSM8K” example (structure, env calling judge model). (<a href="https://skyrl.readthedocs.io/en/latest/examples/llm_as_a_judge.html" title="LLM as a Judge for GSM8K — SkyRL  documentation">skyrl.readthedocs.io</a>)</li>
<li><strong>Dataset contract</strong> → “Dataset Preparation” (data_source, prompt, env_class, reward_spec). (<a href="https://skyrl.readthedocs.io/en/latest/examples/search.html?utm_source=chatgpt.com" title="Multi-Turn RL for Search with SkyRL">skyrl.readthedocs.io</a>)</li>
</ul>
<hr>
<h3 id="tldr-implementation-checklist">TL;DR implementation checklist </h3>
<ol>
<li>
<p><strong>Generator</strong> (<code>generate_with_llm.py</code>)</p>
<ul>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Extend schema with <code>final_answer_requirements</code> + <code>judge_rubric</code>.</li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Execute plan → <code>ExecOut(state, steps)</code> via MCP tools.</li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Compose <code>final_reference</code> with an LLM (or template) grounded in <code>state</code>.</li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Write <code>reward_spec.ground_truth</code> including <code>final_reference</code> + <code>judge_rubric</code>.</li>
</ul>
</li>
<li>
<p><strong>Environment</strong> (<code>mcp_tool_env.py</code>)</p>
<ul>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Parse action as tool or final; call tools via ToolGroups.</li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Implement <strong>per‑turn rubric scoring</strong> and <strong>final LAJ scoring</strong> (with structured outputs).</li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Return <code>BaseTextEnvStepOutput</code> each turn.</li>
</ul>
</li>
<li>
<p><strong>Training config</strong></p>
<ul>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> If using tags, set <code>generator.sampling_params.stop</code>.</li>
<li class="task-list-item"><input type="checkbox" class="task-list-item-checkbox" checked=""> Enable async multi‑turn rollouts as in Search.</li>
</ul>
</li>
</ol>
<p>Once you wire the ToolGroups to your MCP servers, this will let you train <strong>long‑horizon, multi‑tool research agents</strong> whose <strong>final textual answers</strong> are graded both <strong>heuristically</strong> and by an <strong>LLM judge</strong>, entirely within SkyRL’s standard interfaces. (<a href="https://skyrl.readthedocs.io/?utm_source=chatgpt.com" title="Welcome to SkyRL's documentation! — SkyRL documentation">skyrl.readthedocs.io</a>)</p>
<p>If you want me to turn these snippets into line‑exact diffs against your current files, paste the full current contents of <code>generate_with_llm.py</code> and <code>mcp_tool_env.py</code> (without <code>...</code>) and I’ll produce a ready‑to‑apply patch.</p>
</div>
      </div>
      
      
    
    
    
    
    
    
  
    </body></html>