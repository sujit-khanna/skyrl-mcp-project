<!DOCTYPE html><html><head>
      <title>sonnet45_implementation</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="file:////Users/sujitkhanna/.cursor/extensions/shd101wyy.markdown-preview-enhanced-0.8.19-universal/crossnote/dependencies/katex/katex.min.css">
      
      
      
      
      
      <style>
      code[class*=language-],pre[class*=language-]{color:#333;background:0 0;font-family:Consolas,"Liberation Mono",Menlo,Courier,monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.4;-moz-tab-size:8;-o-tab-size:8;tab-size:8;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*=language-]{padding:.8em;overflow:auto;border-radius:3px;background:#f5f5f5}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal;background:#f5f5f5}.token.blockquote,.token.comment{color:#969896}.token.cdata{color:#183691}.token.doctype,.token.macro.property,.token.punctuation,.token.variable{color:#333}.token.builtin,.token.important,.token.keyword,.token.operator,.token.rule{color:#a71d5d}.token.attr-value,.token.regex,.token.string,.token.url{color:#183691}.token.atrule,.token.boolean,.token.code,.token.command,.token.constant,.token.entity,.token.number,.token.property,.token.symbol{color:#0086b3}.token.prolog,.token.selector,.token.tag{color:#63a35c}.token.attr-name,.token.class,.token.class-name,.token.function,.token.id,.token.namespace,.token.pseudo-class,.token.pseudo-element,.token.url-reference .token.variable{color:#795da3}.token.entity{cursor:help}.token.title,.token.title .token.punctuation{font-weight:700;color:#1d3e81}.token.list{color:#ed6a43}.token.inserted{background-color:#eaffea;color:#55a532}.token.deleted{background-color:#ffecec;color:#bd2c00}.token.bold{font-weight:700}.token.italic{font-style:italic}.language-json .token.property{color:#183691}.language-markup .token.tag .token.punctuation{color:#333}.language-css .token.function,code.language-css{color:#0086b3}.language-yaml .token.atrule{color:#63a35c}code.language-yaml{color:#183691}.language-ruby .token.function{color:#333}.language-markdown .token.url{color:#795da3}.language-makefile .token.symbol{color:#795da3}.language-makefile .token.variable{color:#183691}.language-makefile .token.builtin{color:#0086b3}.language-bash .token.keyword{color:#0086b3}pre[data-line]{position:relative;padding:1em 0 1em 3em}pre[data-line] .line-highlight-wrapper{position:absolute;top:0;left:0;background-color:transparent;display:block;width:100%}pre[data-line] .line-highlight{position:absolute;left:0;right:0;padding:inherit 0;margin-top:1em;background:hsla(24,20%,50%,.08);background:linear-gradient(to right,hsla(24,20%,50%,.1) 70%,hsla(24,20%,50%,0));pointer-events:none;line-height:inherit;white-space:pre}pre[data-line] .line-highlight:before,pre[data-line] .line-highlight[data-end]:after{content:attr(data-start);position:absolute;top:.4em;left:.6em;min-width:1em;padding:0 .5em;background-color:hsla(24,20%,50%,.4);color:#f4f1ef;font:bold 65%/1.5 sans-serif;text-align:center;vertical-align:.3em;border-radius:999px;text-shadow:none;box-shadow:0 1px #fff}pre[data-line] .line-highlight[data-end]:after{content:attr(data-end);top:auto;bottom:.4em}html body{font-family:'Helvetica Neue',Helvetica,'Segoe UI',Arial,freesans,sans-serif;font-size:16px;line-height:1.6;color:#333;background-color:#fff;overflow:initial;box-sizing:border-box;word-wrap:break-word}html body>:first-child{margin-top:0}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{line-height:1.2;margin-top:1em;margin-bottom:16px;color:#000}html body h1{font-size:2.25em;font-weight:300;padding-bottom:.3em}html body h2{font-size:1.75em;font-weight:400;padding-bottom:.3em}html body h3{font-size:1.5em;font-weight:500}html body h4{font-size:1.25em;font-weight:600}html body h5{font-size:1.1em;font-weight:600}html body h6{font-size:1em;font-weight:600}html body h1,html body h2,html body h3,html body h4,html body h5{font-weight:600}html body h5{font-size:1em}html body h6{color:#5c5c5c}html body strong{color:#000}html body del{color:#5c5c5c}html body a:not([href]){color:inherit;text-decoration:none}html body a{color:#08c;text-decoration:none}html body a:hover{color:#00a3f5;text-decoration:none}html body img{max-width:100%}html body>p{margin-top:0;margin-bottom:16px;word-wrap:break-word}html body>ol,html body>ul{margin-bottom:16px}html body ol,html body ul{padding-left:2em}html body ol.no-list,html body ul.no-list{padding:0;list-style-type:none}html body ol ol,html body ol ul,html body ul ol,html body ul ul{margin-top:0;margin-bottom:0}html body li{margin-bottom:0}html body li.task-list-item{list-style:none}html body li>p{margin-top:0;margin-bottom:0}html body .task-list-item-checkbox{margin:0 .2em .25em -1.8em;vertical-align:middle}html body .task-list-item-checkbox:hover{cursor:pointer}html body blockquote{margin:16px 0;font-size:inherit;padding:0 15px;color:#5c5c5c;background-color:#f0f0f0;border-left:4px solid #d6d6d6}html body blockquote>:first-child{margin-top:0}html body blockquote>:last-child{margin-bottom:0}html body hr{height:4px;margin:32px 0;background-color:#d6d6d6;border:0 none}html body table{margin:10px 0 15px 0;border-collapse:collapse;border-spacing:0;display:block;width:100%;overflow:auto;word-break:normal;word-break:keep-all}html body table th{font-weight:700;color:#000}html body table td,html body table th{border:1px solid #d6d6d6;padding:6px 13px}html body dl{padding:0}html body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:700}html body dl dd{padding:0 16px;margin-bottom:16px}html body code{font-family:Menlo,Monaco,Consolas,'Courier New',monospace;font-size:.85em;color:#000;background-color:#f0f0f0;border-radius:3px;padding:.2em 0}html body code::after,html body code::before{letter-spacing:-.2em;content:'\00a0'}html body pre>code{padding:0;margin:0;word-break:normal;white-space:pre;background:0 0;border:0}html body .highlight{margin-bottom:16px}html body .highlight pre,html body pre{padding:1em;overflow:auto;line-height:1.45;border:#d6d6d6;border-radius:3px}html body .highlight pre{margin-bottom:0;word-break:normal}html body pre code,html body pre tt{display:inline;max-width:initial;padding:0;margin:0;overflow:initial;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}html body pre code:after,html body pre code:before,html body pre tt:after,html body pre tt:before{content:normal}html body blockquote,html body dl,html body ol,html body p,html body pre,html body ul{margin-top:0;margin-bottom:16px}html body kbd{color:#000;border:1px solid #d6d6d6;border-bottom:2px solid #c7c7c7;padding:2px 4px;background-color:#f0f0f0;border-radius:3px}@media print{html body{background-color:#fff}html body h1,html body h2,html body h3,html body h4,html body h5,html body h6{color:#000;page-break-after:avoid}html body blockquote{color:#5c5c5c}html body pre{page-break-inside:avoid}html body table{display:table}html body img{display:block;max-width:100%;max-height:100%}html body code,html body pre{word-wrap:break-word;white-space:pre}}.markdown-preview{width:100%;height:100%;box-sizing:border-box}.markdown-preview ul{list-style:disc}.markdown-preview ul ul{list-style:circle}.markdown-preview ul ul ul{list-style:square}.markdown-preview ol{list-style:decimal}.markdown-preview ol ol,.markdown-preview ul ol{list-style-type:lower-roman}.markdown-preview ol ol ol,.markdown-preview ol ul ol,.markdown-preview ul ol ol,.markdown-preview ul ul ol{list-style-type:lower-alpha}.markdown-preview .newpage,.markdown-preview .pagebreak{page-break-before:always}.markdown-preview pre.line-numbers{position:relative;padding-left:3.8em;counter-reset:linenumber}.markdown-preview pre.line-numbers>code{position:relative}.markdown-preview pre.line-numbers .line-numbers-rows{position:absolute;pointer-events:none;top:1em;font-size:100%;left:0;width:3em;letter-spacing:-1px;border-right:1px solid #999;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-preview pre.line-numbers .line-numbers-rows>span{pointer-events:none;display:block;counter-increment:linenumber}.markdown-preview pre.line-numbers .line-numbers-rows>span:before{content:counter(linenumber);color:#999;display:block;padding-right:.8em;text-align:right}.markdown-preview .mathjax-exps .MathJax_Display{text-align:center!important}.markdown-preview:not([data-for=preview]) .code-chunk .code-chunk-btn-group{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .status{display:none}.markdown-preview:not([data-for=preview]) .code-chunk .output-div{margin-bottom:16px}.markdown-preview .md-toc{padding:0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link div,.markdown-preview .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}.markdown-preview .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}.scrollbar-style::-webkit-scrollbar{width:8px}.scrollbar-style::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}.scrollbar-style::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode]){position:relative;width:100%;height:100%;top:0;left:0;margin:0;padding:0;overflow:auto}html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{position:relative;top:0;min-height:100vh}@media screen and (min-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em calc(50% - 457px + 2em)}}@media screen and (max-width:914px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode]) .markdown-preview{font-size:14px!important;padding:1em}}@media print{html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{display:none}}html body[for=html-export]:not([data-presentation-mode]) #sidebar-toc-btn{position:fixed;bottom:8px;left:8px;font-size:28px;cursor:pointer;color:inherit;z-index:99;width:32px;text-align:center;opacity:.4}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn{opacity:1}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc{position:fixed;top:0;left:0;width:300px;height:100%;padding:32px 0 48px 0;font-size:14px;box-shadow:0 0 4px rgba(150,150,150,.33);box-sizing:border-box;overflow:auto;background-color:inherit}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar{width:8px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track{border-radius:10px;background-color:transparent}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb{border-radius:5px;background-color:rgba(150,150,150,.66);border:4px solid rgba(150,150,150,.66);background-clip:content-box}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a{text-decoration:none}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc{padding:0 16px}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link{display:inline;padding:.25rem 0}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link div,html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper .md-toc-link p{display:inline}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc .md-toc .md-toc-link-wrapper.highlighted .md-toc-link{font-weight:800}html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{left:300px;width:calc(100% - 300px);padding:2em calc(50% - 457px - 300px / 2);margin:0;box-sizing:border-box}@media screen and (max-width:1274px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{padding:2em}}@media screen and (max-width:450px){html body[for=html-export]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview{width:100%}}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .markdown-preview{left:50%;transform:translateX(-50%)}html body[for=html-export]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc{display:none}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
      <!-- The content below will be included at the end of the <head> element. --><script type="text/javascript">
  document.addEventListener("DOMContentLoaded", function () {
    // your code here
  });
</script></head><body for="html-export">
    
    
      <div class="crossnote markdown-preview  ">
      
<h1 id="sonnet-45-ultra-detailed-implementation-plan">Sonnet 4.5 Ultra-Detailed Implementation Plan </h1>
<h2 id="multi-turn-tool-use-with-research-capabilities">Multi-Turn Tool Use with Research Capabilities </h2>
<p><strong>Author:</strong> Claude Sonnet 4.5<br>
<strong>Date:</strong> 2025-09-29<br>
<strong>Status:</strong> Design Document<br>
<strong>Complexity:</strong> High</p>
<hr>
<h2 id="executive-summary">Executive Summary </h2>
<p>This document provides a surgical, line-by-line implementation plan to upgrade the SkyRL MCP Research Agent to support <strong>long-horizon, multi-turn tool use with research capabilities</strong>. The core enhancement enables:</p>
<ol>
<li><strong>Executed tool plans</strong> during dataset generation (not just planned)</li>
<li><strong>Step-wise analysis</strong> using a safe DSL (extract/compute/select/accept_if)</li>
<li><strong>Reference final answers</strong> grounded in tool outputs</li>
<li><strong>Dense per-turn rewards</strong> for correct tool use + analysis</li>
<li><strong>LLM-as-a-Judge (LAJ)</strong> scoring for final text quality</li>
<li><strong>Heuristic + LAJ hybrid</strong> reward system</li>
</ol>
<p><strong>Mathematical foundation:</strong> We maximize expected return <code>E_π[Σ r_t]</code> where:</p>
<ul>
<li><code>r_1...r_K</code> = shaped rewards for tool execution quality</li>
<li><code>r_K+1</code> = terminal reward for final answer quality (heuristic + LAJ)</li>
</ul>
<p><strong>SkyRL compatibility:</strong> Fully compatible with <code>BaseTextEnv</code>, ToolGroups, compact dataset prompts, and GRPO/PPO training.</p>
<hr>
<h2 id="table-of-contents">Table of Contents </h2>
<ol>
<li><a href="#1-current-state-analysis">Current State Analysis</a></li>
<li><a href="#2-target-architecture">Target Architecture</a></li>
<li><a href="#3-phase-1-data-generator-enhancement">Phase 1: Data Generator Enhancement</a></li>
<li><a href="#4-phase-2-environment-reward-system">Phase 2: Environment Reward System</a></li>
<li><a href="#5-phase-3-integration--testing">Phase 3: Integration &amp; Testing</a></li>
<li><a href="#6-phase-4-training--evaluation">Phase 4: Training &amp; Evaluation</a></li>
<li><a href="#7-risk-mitigation">Risk Mitigation</a></li>
<li><a href="#8-success-criteria">Success Criteria</a></li>
<li><a href="#9-appendix">Appendix</a></li>
</ol>
<hr>
<h2 id="1-current-state-analysis">1. Current State Analysis </h2>
<h3 id="11-existing-components">1.1 Existing Components </h3>
<p><strong>Dataset Generator</strong> (<code>src/dataset/llm/generate_with_llm.py</code>)</p>
<ul>
<li>✅ Uses OpenAI Structured Outputs to generate task plans</li>
<li>✅ Supports complexity levels (simple/moderate/complex)</li>
<li>✅ Generates <code>tool_sequence</code> with server/tool/params</li>
<li>❌ Does NOT execute the plan against MCP tools</li>
<li>❌ Does NOT produce reference final answers</li>
<li>❌ Missing <code>analysis_requirements</code> per step</li>
<li>❌ Missing <code>final_answer_requirements</code> and <code>judge_rubric</code></li>
</ul>
<p><strong>Environment</strong> (<code>src/envs/mcp_tool_env.py</code>)</p>
<ul>
<li>✅ Subclasses <code>BaseTextEnv</code> correctly</li>
<li>✅ Parses JSON and XML-style tool actions</li>
<li>✅ Executes tools via <code>MCPToolGroup</code></li>
<li>❌ Reward logic is trivial (binary success on first tool)</li>
<li>❌ No per-step analysis or state tracking</li>
<li>❌ No final answer handling</li>
<li>❌ No LLM-as-a-Judge integration</li>
</ul>
<p><strong>Tool Integration</strong> (<code>src/utils/tool_manager.py</code>)</p>
<ul>
<li>✅ HTTP-based MCP tool execution</li>
<li>✅ Async support with timeouts</li>
<li>✅ Clean error handling</li>
<li>✅ Ready to use in both generator and environment</li>
</ul>
<p><strong>Training Pipeline</strong> (<code>src/training/train_grpo_vllm.py</code>)</p>
<ul>
<li>✅ LoRA/Full FT toggle working</li>
<li>✅ vLLM/HF backend selection</li>
<li>✅ Per-token logprobs captured</li>
<li>✅ W&amp;B logging integrated</li>
<li>❌ Configs need adjustment for multi-turn final answers</li>
</ul>
<h3 id="12-gap-analysis">1.2 Gap Analysis </h3>
<table>
<thead>
<tr>
<th>Component</th>
<th>Current</th>
<th>Required</th>
<th>Gap Size</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data Schema</td>
<td>Basic <code>tool_sequence</code></td>
<td><code>analysis_requirements</code>, <code>final_reference</code>, <code>judge_rubric</code></td>
<td><strong>Medium</strong></td>
</tr>
<tr>
<td>Generator Execution</td>
<td>Planning only</td>
<td>Execute + analyze + compose reference</td>
<td><strong>Large</strong></td>
</tr>
<tr>
<td>Environment State</td>
<td>Stateless per turn</td>
<td>Track named state across turns</td>
<td><strong>Medium</strong></td>
</tr>
<tr>
<td>Environment Rewards</td>
<td>Binary first-tool check</td>
<td>Dense per-step + LAJ final</td>
<td><strong>Large</strong></td>
</tr>
<tr>
<td>Action Parsing</td>
<td>Tool calls only</td>
<td>Tool calls + final answer</td>
<td><strong>Small</strong></td>
</tr>
<tr>
<td>Testing</td>
<td>Minimal</td>
<td>DSL tests, reward tests, judge mocks</td>
<td><strong>Medium</strong></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="2-target-architecture">2. Target Architecture </h2>
<h3 id="21-data-flow-enhanced">2.1 Data Flow (Enhanced) </h3>
<pre data-role="codeBlock" data-info="" class="language-text"><code>┌─────────────────────────────────────────────────────────────────┐
│                     DATA GENERATION PHASE                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  1. LLM Planner (OpenAI)                                        │
│     ↓                                                            │
│     task = {                                                     │
│       user_prompt,                                               │
│       tool_sequence: [                                           │
│         {step, server, tool, params,                             │
│          analysis_requirements: {                                │
│            extract: ["field[]", "nested[][key]"],                │
│            compute: ["var = fn(other_var)"],                     │
│            select: ["filtered = topk(data, 3)"],                 │
│            accept_if: ["len(result) &gt; 5"],                       │
│            next_args_from: "var"                                 │
│          }}                                                       │
│       ],                                                          │
│       final_answer_requirements: {                               │
│         format: "markdown",                                      │
│         must_include: ["fact1", "fact2"],                        │
│         grounded_from: ["state_var1", "state_var2"]              │
│       },                                                          │
│       judge_rubric: {                                            │
│         weights: {coverage: 0.3, grounding: 0.4, ...},           │
│         schema: {...JSON Schema for LAJ...}                      │
│       }                                                           │
│     }                                                             │
│                                                                  │
│  2. Plan Verification &amp; Repair                                  │
│     ↓                                                            │
│     - Check next_args_from chains exist                          │
│     - Validate step counts per complexity                        │
│     - Ensure extract keys referenced in later steps              │
│                                                                  │
│  3. Plan Execution (NEW!)                                       │
│     ↓                                                            │
│     state = {}                                                   │
│     for step in tool_sequence:                                   │
│       params_resolved = resolve_placeholders(step.params, state) │
│       result = await tool_manager.execute(step.tool, params)     │
│       # Apply analysis DSL                                       │
│       for field in step.extract:                                 │
│         state[field] = extract_path(result, field)               │
│       for expr in step.compute:                                  │
│         state.update(safe_compute(expr, state))                  │
│       for cond in step.accept_if:                                │
│         assert safe_check(cond, state)                           │
│     exec_out = ExecOut(state=state, steps=exec_steps)            │
│                                                                  │
│  4. Reference Answer Composition (NEW!)                         │
│     ↓                                                            │
│     facts = {k: state[k] for k in grounded_from}                 │
│     answer_text = compose_via_llm_or_template(facts, must_include)│
│     citations = map_facts_to_steps(facts, exec_steps)            │
│     final_reference = {answer_text, facts, citations}            │
│                                                                  │
│  5. Write SkyRL Dataset                                         │
│     ↓                                                            │
│     {                                                             │
│       data_source, env_class, prompt,                            │
│       reward_spec: {                                             │
│         method: "rule",                                          │
│         ground_truth: {                                          │
│           task_id, complexity, max_turns,                        │
│           tool_sequence,                                         │
│           analysis_rubric: {steps, final_answer_requirements},   │
│           final_reference,                                       │
│           judge_rubric                                           │
│         }                                                         │
│       }                                                           │
│     }                                                             │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      TRAINING PHASE (RL)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Environment: MCPToolEnv(BaseTextEnv)                           │
│                                                                  │
│  init(prompt, ground_truth):                                    │
│    self.gt = ground_truth                                        │
│    self.state = {}  # track derived state like generator        │
│    return prompt, task_info                                      │
│                                                                  │
│  step(action_text):                                             │
│    kind, payload = parse_action(action_text)                     │
│                                                                  │
│    if kind == "tool":                                           │
│      # Execute tool via ToolGroup                               │
│      result = self._execute_tool(group, tool, [args])           │
│                                                                  │
│      # Match to ground truth step                               │
│      step_idx = match_step(tool_fqn, self.gt.tool_sequence)     │
│      analysis_req = self.gt.analysis_rubric.steps[step_idx]     │
│                                                                  │
│      # Compute dense reward components                          │
│      r_tool_name = 0.2 if tool == expected else 0               │
│      r_param_bind = 0.15 if next_args_from in args else 0       │
│                                                                  │
│      # Apply analysis + update state                            │
│      for field in analysis_req.extract:                          │
│        val = extract_path(result, field)                         │
│        if val: self.state[field.base] = val; r_extract += 0.15  │
│      for expr in analysis_req.compute:                           │
│        self.state.update(safe_compute(expr, self.state))         │
│        r_compute += 0.15                                         │
│      for cond in analysis_req.accept_if:                         │
│        if safe_check(cond, self.state): r_accept += 0.1         │
│                                                                  │
│      r_step = r_tool_name + r_param_bind + r_extract + ...      │
│      return BaseTextEnvStepOutput(                              │
│        observations=[{"role":"user", "content": json(result)}],  │
│        reward=r_step,                                            │
│        done=(turn &gt;= max_turns),                                 │
│        metadata={step, breakdown}                                │
│      )                                                            │
│                                                                  │
│    elif kind == "final":                                        │
│      final_text = payload                                        │
│                                                                  │
│      # Heuristic scoring                                        │
│      far = self.gt.analysis_rubric.final_answer_requirements     │
│      coverage = count_includes(final_text, far.must_include)    │
│      grounding = check_consistency(final_text, self.gt.final_reference.facts)│
│      clarity = check_length_band(final_text, jr.target_range)   │
│      safety = check_blacklist(final_text)                        │
│      r_heur = weighted_sum(coverage, grounding, clarity, safety) │
│                                                                  │
│      # LLM-as-a-Judge scoring                                   │
│      judge_prompt = {                                            │
│        instructions: "Score FINAL vs reference",                 │
│        facts: self.gt.final_reference.facts,                     │
│        reference: self.gt.final_reference.answer_text,           │
│        final: final_text                                         │
│      }                                                            │
│      resp = await judge_llm.structured_output(                   │
│        schema=self.gt.judge_rubric.schema                        │
│      )                                                            │
│      r_laj = resp.total                                          │
│                                                                  │
│      # Combine rewards                                          │
│      r_final = w_heur * r_heur + w_laj * r_laj                  │
│                                                                  │
│      return BaseTextEnvStepOutput(                              │
│        observations=[],                                          │
│        reward=r_final,                                           │
│        done=True,                                                │
│        metadata={heur: {...}, laj: {...}}                        │
│      )                                                            │
│                                                                  │
│  GRPO/PPO:                                                      │
│    Rollout batch → compute advantages (GAE)                      │
│    Σ r_t includes both tool rewards and final reward            │
│    Policy loss + value loss + KL penalty                         │
│    Update → (if LoRA) refresh vLLM adapter                       │
└─────────────────────────────────────────────────────────────────┘
</code></pre><h3 id="22-key-design-decisions">2.2 Key Design Decisions </h3>
<p><strong>Decision 1: Safe DSL for Analysis</strong></p>
<ul>
<li><strong>Rationale:</strong> <code>eval()</code> is powerful but dangerous. We need deterministic, auditable operations.</li>
<li><strong>Implementation:</strong> Whitelist functions (<code>topk</code>, <code>head</code>, <code>unique</code>, <code>regex_extract_all</code>, <code>pct_change_last_day</code>, etc.)</li>
<li><strong>Scope:</strong> Generator and environment share identical DSL implementation</li>
<li><strong>Location:</strong> <code>src/envs/reward_functions.py</code> (single source of truth)</li>
</ul>
<p><strong>Decision 2: Compact Dataset Prompts</strong></p>
<ul>
<li><strong>Rationale:</strong> SkyRL expects <code>prompt</code> to be seed messages only; multi-turn supervision via <code>ground_truth</code></li>
<li><strong>Implementation:</strong>
<ul>
<li><code>prompt</code>: <code>[{system}, {user_query}]</code> only</li>
<li><code>ground_truth</code>: Contains <code>tool_sequence</code>, <code>analysis_rubric</code>, <code>final_reference</code>, <code>judge_rubric</code></li>
</ul>
</li>
<li><strong>Benefit:</strong> Stable tokenization, no prompt bloat, proper TI/TO alignment</li>
</ul>
<p><strong>Decision 3: Hybrid Reward System</strong></p>
<ul>
<li><strong>Rationale:</strong> Heuristics are fast/deterministic; LAJ is expensive/stochastic but captures quality</li>
<li><strong>Implementation:</strong>
<ul>
<li>Start training with <code>w_heur=0.7, w_laj=0.3</code></li>
<li>Increase LAJ weight as policy stabilizes</li>
<li>Cache LAJ calls by <code>(task_id, hash(final_text))</code></li>
</ul>
</li>
<li><strong>Benefit:</strong> Dense shaping early, quality refinement later</li>
</ul>
<p><strong>Decision 4: Step Indexing</strong></p>
<ul>
<li><strong>Rationale:</strong> Policy may call tools out-of-order or skip steps</li>
<li><strong>Implementation:</strong> Match tool calls to expected steps by <code>(server, tool)</code> FQN</li>
<li><strong>Fallback:</strong> If no match, use current turn index; apply generic penalty</li>
</ul>
<p><strong>Decision 5: ToolManager Reuse</strong></p>
<ul>
<li><strong>Rationale:</strong> Generator and environment should use identical tool execution logic</li>
<li><strong>Implementation:</strong> Both import <code>src/utils/tool_manager.ToolManager</code></li>
<li><strong>Benefit:</strong> Consistency, easier debugging, shared timeout/retry logic</li>
</ul>
<hr>
<h2 id="3-phase-1-data-generator-enhancement">3. Phase 1: Data Generator Enhancement </h2>
<h3 id="31-file-srcdatasetllmgenerate_with_llmpy">3.1 File: <code>src/dataset/llm/generate_with_llm.py</code> </h3>
<h4 id="311-new-imports-top-of-file">3.1.1 New Imports (Top of File) </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === ADD AFTER EXISTING IMPORTS ===</span>
<span class="token keyword keyword-from">from</span> dataclasses <span class="token keyword keyword-import">import</span> dataclass<span class="token punctuation">,</span> asdict
<span class="token keyword keyword-from">from</span> copy <span class="token keyword keyword-import">import</span> deepcopy
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Tuple<span class="token punctuation">,</span> Optional
<span class="token keyword keyword-import">import</span> re

<span class="token comment"># Import ToolManager for plan execution</span>
<span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>tool_manager <span class="token keyword keyword-import">import</span> ToolManager
    MCP_AVAILABLE <span class="token operator">=</span> <span class="token boolean">True</span>
<span class="token keyword keyword-except">except</span> ImportError<span class="token punctuation">:</span>
    MCP_AVAILABLE <span class="token operator">=</span> <span class="token boolean">False</span>
    ToolManager <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre><p><strong>Rationale:</strong></p>
<ul>
<li><code>dataclass</code>: Clean data structures for <code>ExecStep</code> and <code>ExecOut</code></li>
<li><code>deepcopy</code>: Safe namespace isolation for DSL eval</li>
<li><code>ToolManager</code>: Execute plans against real MCP servers</li>
</ul>
<h4 id="312-extended-task-schema-replace-existing-task_schema">3.1.2 Extended Task Schema (Replace Existing <code>TASK_SCHEMA</code>) </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>TASK_SCHEMA <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"skyrl_task"</span><span class="token punctuation">,</span>
    <span class="token string">"schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"task_id"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"user_prompt"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"complexity"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
                <span class="token string">"enum"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"simple"</span><span class="token punctuation">,</span> <span class="token string">"moderate"</span><span class="token punctuation">,</span> <span class="token string">"complex"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"max_turns"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span>
                <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
                <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"simple: 2-4, moderate: 4-8, complex: 8-16"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"tools_available"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"limits"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"max_tools"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"max_servers"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"max_tools"</span><span class="token punctuation">,</span> <span class="token string">"max_servers"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"tool_sequence"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                <span class="token string">"minItems"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                <span class="token string">"maxItems"</span><span class="token punctuation">:</span> <span class="token number">16</span><span class="token punctuation">,</span>
                <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                    <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"step"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"server"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"tool"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                            <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"May contain ${var} placeholders"</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"analysis_requirements"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                            <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                                <span class="token string">"extract"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                                    <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Paths like 'field', 'field[]', 'items[][title]', 'map{k-&gt;v}'"</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"compute"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                                    <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Expressions like 'pct = pct_change_last_day(prices)'"</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"select"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                                    <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Filtering like 'top3 = topk(pct, 3)'"</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"accept_if"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                                    <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                                    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Conditions like 'len(result) &gt;= 5' or 'url ~= \"^https://\"'"</span>
                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                <span class="token string">"next_args_from"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
                                    <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"State variable to use in next step's params"</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"next_args_from"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            <span class="token string">"additionalProperties"</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">,</span> <span class="token string">"server"</span><span class="token punctuation">,</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">,</span> <span class="token string">"analysis_requirements"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"additionalProperties"</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"final_answer_requirements"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"format"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">,</span>
                        <span class="token string">"enum"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span> <span class="token string">"json"</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"must_include"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                        <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Fact names that must appear in final answer"</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"grounded_from"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                        <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"State variable names to ground answer in"</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"quality_criteria"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                        <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"string"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Requirements like 'no hallucinations', 'concise'"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"format"</span><span class="token punctuation">,</span> <span class="token string">"must_include"</span><span class="token punctuation">,</span> <span class="token string">"grounded_from"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"additionalProperties"</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"judge_rubric"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"weights"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                        <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                            <span class="token string">"coverage"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token string">"grounding"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token string">"clarity"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                            <span class="token string">"safety"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
                        <span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"coverage"</span><span class="token punctuation">,</span> <span class="token string">"grounding"</span><span class="token punctuation">,</span> <span class="token string">"clarity"</span><span class="token punctuation">,</span> <span class="token string">"safety"</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"JSON Schema for LLM-as-a-Judge structured output"</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"target_length_range"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                        <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"array"</span><span class="token punctuation">,</span>
                        <span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"integer"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                        <span class="token string">"minItems"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                        <span class="token string">"maxItems"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                        <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"[min_words, max_words]"</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"weights"</span><span class="token punctuation">,</span> <span class="token string">"schema"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"additionalProperties"</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"task_id"</span><span class="token punctuation">,</span> <span class="token string">"user_prompt"</span><span class="token punctuation">,</span> <span class="token string">"complexity"</span><span class="token punctuation">,</span> <span class="token string">"max_turns"</span><span class="token punctuation">,</span>
            <span class="token string">"tool_sequence"</span><span class="token punctuation">,</span> <span class="token string">"final_answer_requirements"</span><span class="token punctuation">,</span> <span class="token string">"judge_rubric"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"additionalProperties"</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p><strong>Key Changes:</strong></p>
<ul>
<li>Added <code>analysis_requirements</code> per tool step (extract/compute/select/accept_if/next_args_from)</li>
<li>Added <code>final_answer_requirements</code> (format, must_include, grounded_from, quality_criteria)</li>
<li>Added <code>judge_rubric</code> (weights, schema, target_length_range)</li>
<li>Strengthened constraints (minItems, maxItems, enums)</li>
</ul>
<p><strong>Prompting Strategy:</strong><br>
Update <code>USER_TEMPLATE</code> to instruct planner:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>USER_TEMPLATE <span class="token operator">=</span> <span class="token punctuation">(</span>
    <span class="token string">"Domain: {domain}\n"</span>
    <span class="token string">"Complexity: {complexity}\n"</span>
    <span class="token string">"Tool inventory (server: tools):\n{inventory}\n"</span>
    <span class="token string">"Constraints: call at most {max_tools} tools within {max_turns} turns.\n"</span>
    <span class="token string">"\n"</span>
    <span class="token string">"IMPORTANT REQUIREMENTS:\n"</span>
    <span class="token string">"1. For EACH tool step, specify analysis_requirements:\n"</span>
    <span class="token string">"   - extract: Fields to pull from tool result (e.g., 'articles[]', 'price[][close]')\n"</span>
    <span class="token string">"   - compute: Derived variables using safe functions (topk, pct_change_last_day, regex_extract_all, etc.)\n"</span>
    <span class="token string">"   - select: Filtering operations (head, unique, filter)\n"</span>
    <span class="token string">"   - accept_if: Validation conditions (len(...) &gt; 5, field ~= 'regex')\n"</span>
    <span class="token string">"   - next_args_from: State variable name to pass to next step's params as ${var}\n"</span>
    <span class="token string">"2. Chain steps: each step's next_args_from must be derived by that step's extract/compute/select.\n"</span>
    <span class="token string">"3. Final step should produce variables listed in final_answer_requirements.grounded_from.\n"</span>
    <span class="token string">"4. Specify final_answer_requirements: format (text/markdown/json), must_include facts, grounded_from state vars.\n"</span>
    <span class="token string">"5. Provide judge_rubric: weights summing to 1.0, JSON schema for judge output, target_length_range.\n"</span>
    <span class="token string">"\n"</span>
    <span class="token string">"Complexity guidelines:\n"</span>
    <span class="token string">"- simple: 2-4 steps, single domain\n"</span>
    <span class="token string">"- moderate: 4-8 steps, 2 domains\n"</span>
    <span class="token string">"- complex: 8-16 steps, 3+ domains, conditional logic\n"</span>
<span class="token punctuation">)</span>
</code></pre><h4 id="313-data-structures-for-execution">3.1.3 Data Structures for Execution </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === ADD AFTER TASK_SCHEMA ===</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ExecStep</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Record of a single executed tool step."""</span>
    step<span class="token punctuation">:</span> <span class="token builtin">int</span>
    tool_fqn<span class="token punctuation">:</span> <span class="token builtin">str</span>  <span class="token comment"># "server.tool"</span>
    args<span class="token punctuation">:</span> <span class="token builtin">dict</span>  <span class="token comment"># Resolved params (placeholders filled)</span>
    result_summary<span class="token punctuation">:</span> <span class="token builtin">dict</span>  <span class="token comment"># Lightweight summary of tool result</span>
    accept_pass<span class="token punctuation">:</span> <span class="token builtin">bool</span>  <span class="token comment"># All accept_if conditions passed</span>
    checks<span class="token punctuation">:</span> <span class="token builtin">dict</span>  <span class="token comment"># Details: missing fields, updated state keys</span>

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">ExecOut</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Aggregated execution output."""</span>
    state<span class="token punctuation">:</span> <span class="token builtin">dict</span>  <span class="token comment"># Named variables derived via extract/compute/select</span>
    steps<span class="token punctuation">:</span> List<span class="token punctuation">[</span>ExecStep<span class="token punctuation">]</span>  <span class="token comment"># Per-step records</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">to_dict</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
            <span class="token string">"state_keys"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>asdict<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>steps<span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
</code></pre><p><strong>Rationale:</strong></p>
<ul>
<li><code>ExecStep</code>: Lightweight record (don't store full tool results; just summaries)</li>
<li><code>ExecOut</code>: Aggregates derived state and step records</li>
<li><code>to_dict()</code>: Serialize for dataset metadata (optional breadcrumbs)</li>
</ul>
<h4 id="314-safe-dsl-implementation">3.1.4 Safe DSL Implementation </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === ADD AFTER ExecOut ===</span>

<span class="token keyword keyword-def">def</span> <span class="token function">_extract_path</span><span class="token punctuation">(</span>result<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span>Optional<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Extract value from tool result using path notation.

    Supported patterns:
    - "field" → result["field"]
    - "field[]" → result["field"] (list)
    - "items[][title]" → [item["title"] for item in result["items"]]
    - "data{key-&gt;val}" → {item["key"]: item["val"] for item in result["data"]}

    Returns: (value, success)
    """</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Simple field</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"["</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> path <span class="token keyword keyword-and">and</span> <span class="token string">"{"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> path<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>path <span class="token keyword keyword-in">in</span> result<span class="token punctuation">)</span>

        <span class="token comment"># List extraction: "field[]"</span>
        <span class="token keyword keyword-if">if</span> path<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">"[]"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            key <span class="token operator">=</span> path<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-return">return</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span>

        <span class="token comment"># Nested list field: "items[][title]"</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"[]["</span> <span class="token keyword keyword-in">in</span> path<span class="token punctuation">:</span>
            base<span class="token punctuation">,</span> field <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"[]["</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            field <span class="token operator">=</span> field<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token string">"]"</span><span class="token punctuation">)</span>
            items <span class="token operator">=</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>it<span class="token punctuation">.</span>get<span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> it <span class="token keyword keyword-in">in</span> items <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span>

        <span class="token comment"># Map extraction: "data{title-&gt;score}"</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"{"</span> <span class="token keyword keyword-in">in</span> path <span class="token keyword keyword-and">and</span> <span class="token string">"-&gt;"</span> <span class="token keyword keyword-in">in</span> path<span class="token punctuation">:</span>
            base <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            mapping <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"}"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            key_field<span class="token punctuation">,</span> val_field <span class="token operator">=</span> mapping<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"-&gt;"</span><span class="token punctuation">)</span>
            items <span class="token operator">=</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span>base<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
                it<span class="token punctuation">[</span>key_field<span class="token punctuation">]</span><span class="token punctuation">:</span> it<span class="token punctuation">.</span>get<span class="token punctuation">(</span>val_field<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-for">for</span> it <span class="token keyword keyword-in">in</span> items
                <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword keyword-and">and</span> key_field <span class="token keyword keyword-in">in</span> it
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">True</span>

        <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">False</span>
    <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token boolean">False</span>


<span class="token keyword keyword-def">def</span> <span class="token function">_compute</span><span class="token punctuation">(</span>expr<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Evaluate a compute/select expression in a safe namespace.

    Supported functions:
    - pct_change_last_day(price_json) → {ticker: pct}
    - topk(dict, k) → [top k keys by value]
    - head(list, n) → list[:n]
    - unique(list) → deduplicated list
    - concat(*lists) → flattened list
    - count_keys(dict) → len(dict)
    - regex_extract_all(pattern, text) → list of matches

    Expression format: "var = fn(args)"
    Returns: {var: value}
    """</span>
    out <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"="</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> expr<span class="token punctuation">:</span>
        <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Compute expression must have '=' : </span><span class="token interpolation"><span class="token punctuation">{</span>expr<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    name<span class="token punctuation">,</span> rhs <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> expr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

    <span class="token comment"># Define safe functions</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">pct_change_last_day</span><span class="token punctuation">(</span>price_json<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Calculate percent change from last 2 days."""</span>
        pct <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token keyword keyword-for">for</span> ticker<span class="token punctuation">,</span> arr <span class="token keyword keyword-in">in</span> price_json<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-continue">continue</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"close"</span> <span class="token keyword keyword-in">in</span> arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword keyword-and">and</span> <span class="token string">"close"</span> <span class="token keyword keyword-in">in</span> arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                prev<span class="token punctuation">,</span> curr <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"close"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-if">if</span> prev <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    pct<span class="token punctuation">[</span>ticker<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>curr <span class="token operator">/</span> prev<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1.0</span>
        <span class="token keyword keyword-return">return</span> pct

    <span class="token keyword keyword-def">def</span> <span class="token function">topk</span><span class="token punctuation">(</span>d<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> k<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return top k keys by value."""</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>key <span class="token keyword keyword-for">for</span> key<span class="token punctuation">,</span> _ <span class="token keyword keyword-in">in</span> <span class="token builtin">sorted</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token operator">=</span><span class="token keyword keyword-lambda">lambda</span> x<span class="token punctuation">:</span> x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> reverse<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">head</span><span class="token punctuation">(</span>lst<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">,</span> n<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Return first n elements."""</span>
        <span class="token keyword keyword-return">return</span> lst<span class="token punctuation">[</span><span class="token punctuation">:</span>n<span class="token punctuation">]</span> <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>lst<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">unique</span><span class="token punctuation">(</span>lst<span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Deduplicate preserving order."""</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>lst<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">dict</span><span class="token punctuation">.</span>fromkeys<span class="token punctuation">(</span>lst<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">concat</span><span class="token punctuation">(</span><span class="token operator">*</span>lsts<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Flatten multiple lists."""</span>
        out <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-for">for</span> lst <span class="token keyword keyword-in">in</span> lsts<span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>lst<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                out<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>lst<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> out

    <span class="token keyword keyword-def">def</span> <span class="token function">count_keys</span><span class="token punctuation">(</span>d<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Count keys in dict."""</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token number">0</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">regex_extract_all</span><span class="token punctuation">(</span>pattern<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Extract all regex matches."""</span>
        <span class="token keyword keyword-return">return</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> text <span class="token keyword keyword-or">or</span> <span class="token string">""</span><span class="token punctuation">)</span>

    <span class="token comment"># Build safe namespace</span>
    safe_ns <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token operator">**</span>deepcopy<span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># Current state variables</span>
        <span class="token string">"pct_change_last_day"</span><span class="token punctuation">:</span> pct_change_last_day<span class="token punctuation">,</span>
        <span class="token string">"topk"</span><span class="token punctuation">:</span> topk<span class="token punctuation">,</span>
        <span class="token string">"head"</span><span class="token punctuation">:</span> head<span class="token punctuation">,</span>
        <span class="token string">"unique"</span><span class="token punctuation">:</span> unique<span class="token punctuation">,</span>
        <span class="token string">"concat"</span><span class="token punctuation">:</span> concat<span class="token punctuation">,</span>
        <span class="token string">"count_keys"</span><span class="token punctuation">:</span> count_keys<span class="token punctuation">,</span>
        <span class="token string">"regex_extract_all"</span><span class="token punctuation">:</span> regex_extract_all<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># Evaluate RHS in controlled environment (no builtins)</span>
    value <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>rhs<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> safe_ns<span class="token punctuation">)</span>
    out<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> value
    <span class="token keyword keyword-return">return</span> out


<span class="token keyword keyword-def">def</span> <span class="token function">_check</span><span class="token punctuation">(</span>cond<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check if condition holds in current state.

    Supported conditions:
    - "len(var) &gt;= 5" → numeric comparison
    - "var in other_var" → membership
    - "url ~= '^https://'" → regex match (special ~= operator)

    Returns: True if condition passes
    """</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token comment"># Regex match: "field ~= 'pattern'"</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">" ~= "</span> <span class="token keyword keyword-in">in</span> cond<span class="token punctuation">:</span>
            lhs<span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token punctuation">[</span>s<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> cond<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"~="</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            pattern <span class="token operator">=</span> pattern<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token string">"'\""</span><span class="token punctuation">)</span>
            val <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>lhs<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span>pattern<span class="token punctuation">,</span> val<span class="token punctuation">)</span> <span class="token keyword keyword-is">is</span> <span class="token keyword keyword-not">not</span> <span class="token boolean">None</span>

        <span class="token comment"># Standard boolean expression</span>
        <span class="token keyword keyword-return">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span><span class="token builtin">eval</span><span class="token punctuation">(</span>cond<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token boolean">False</span>


<span class="token keyword keyword-def">def</span> <span class="token function">_resolve_placeholders</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Any<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Replace ${var} placeholders in params with state values.

    Examples:
    - "ticker": "${top_ticker}" → "ticker": "AAPL"
    - "query": "${company} news" → "query": "Apple news"
    - "tickers": "${top3}" → "tickers": ["NVDA", "AMD", "META"]

    Recursively handles dicts, lists, and strings.
    """</span>
    <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-def">def</span> <span class="token function">repl</span><span class="token punctuation">(</span><span class="token keyword keyword-match">match</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            key <span class="token operator">=</span> <span class="token keyword keyword-match">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                val <span class="token operator">=</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"__builtins__"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
                <span class="token keyword keyword-return">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token keyword keyword-match">match</span><span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># Keep placeholder if resolution fails</span>
        <span class="token keyword keyword-return">return</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r"\$\{([^}]+)\}"</span><span class="token punctuation">,</span> repl<span class="token punctuation">,</span> obj<span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>k<span class="token punctuation">:</span> _resolve_placeholders<span class="token punctuation">(</span>v<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> k<span class="token punctuation">,</span> v <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>

    <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token punctuation">[</span>_resolve_placeholders<span class="token punctuation">(</span>v<span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> v <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">]</span>

    <span class="token keyword keyword-return">return</span> obj
</code></pre><p><strong>Key Points:</strong></p>
<ul>
<li><strong>No arbitrary eval:</strong> All functions whitelisted</li>
<li><strong>Deterministic:</strong> Same state → same output</li>
<li><strong>Error-safe:</strong> Returns False/None on failure instead of crashing</li>
<li><strong>Shared with environment:</strong> Copy this exact code to <code>src/envs/reward_functions.py</code></li>
</ul>
<h4 id="315-plan-execution">3.1.5 Plan Execution </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === ADD AFTER DSL FUNCTIONS ===</span>

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">simulate_plan_and_collect</span><span class="token punctuation">(</span>
    task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    tm<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>ToolManager<span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> ExecOut<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Execute tool_sequence against MCP tools, applying analysis_requirements.

    For each step:
    1. Resolve ${placeholders} in params using current state
    2. Execute tool via ToolManager
    3. Extract fields from result
    4. Compute derived variables
    5. Check accept_if conditions
    6. Update state for next step

    Returns: ExecOut with final state and per-step records
    """</span>
    state<span class="token punctuation">:</span> <span class="token builtin">dict</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    exec_steps<span class="token punctuation">:</span> List<span class="token punctuation">[</span>ExecStep<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-for">for</span> step_obj <span class="token keyword keyword-in">in</span> task<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        step <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>step_obj<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        tool_fqn <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>step_obj<span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>step_obj<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
        params_template <span class="token operator">=</span> step_obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"params"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># Resolve placeholders: ${var} → state[var]</span>
        params <span class="token operator">=</span> _resolve_placeholders<span class="token punctuation">(</span>params_template<span class="token punctuation">,</span> state<span class="token punctuation">)</span>

        <span class="token comment"># Execute tool</span>
        <span class="token keyword keyword-if">if</span> tm <span class="token keyword keyword-is">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token comment"># Offline mode: mock stable shape for testing</span>
            result <span class="token operator">=</span> <span class="token punctuation">{</span>
                <span class="token string">"ok"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
                <span class="token string">"echo"</span><span class="token punctuation">:</span> params<span class="token punctuation">,</span>
                <span class="token string">"timestamp"</span><span class="token punctuation">:</span> <span class="token string">"2025-09-29T00:00:00Z"</span>
            <span class="token punctuation">}</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> tm<span class="token punctuation">.</span>execute_tool<span class="token punctuation">(</span>tool_fqn<span class="token punctuation">,</span> params<span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">20.0</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
                result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"ok"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span>

        <span class="token comment"># Apply analysis requirements</span>
        ar <span class="token operator">=</span> step_obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"analysis_requirements"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        updates <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        missing <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        accept <span class="token operator">=</span> <span class="token boolean">True</span>

        <span class="token comment"># Extract fields</span>
        <span class="token keyword keyword-for">for</span> need <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"extract"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            val<span class="token punctuation">,</span> ok <span class="token operator">=</span> _extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> need<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> ok<span class="token punctuation">:</span>
                <span class="token comment"># Key is base name before brackets/braces</span>
                key <span class="token operator">=</span> need<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                updates<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
            <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
                missing<span class="token punctuation">.</span>append<span class="token punctuation">(</span>need<span class="token punctuation">)</span>
                accept <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token comment"># Compute derived variables</span>
        <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"compute"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                updates<span class="token punctuation">.</span>update<span class="token punctuation">(</span>_compute<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token operator">**</span>updates<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
                accept <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token comment"># Select/filter</span>
        <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                updates<span class="token punctuation">.</span>update<span class="token punctuation">(</span>_compute<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token operator">**</span>updates<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
                accept <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token comment"># Check acceptance conditions</span>
        <span class="token keyword keyword-for">for</span> cond <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"accept_if"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> _check<span class="token punctuation">(</span>cond<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token operator">**</span>state<span class="token punctuation">,</span> <span class="token operator">**</span>updates<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                accept <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token comment"># Update global state</span>
        state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>updates<span class="token punctuation">)</span>

        <span class="token comment"># Record step</span>
        exec_steps<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ExecStep<span class="token punctuation">(</span>
            step<span class="token operator">=</span>step<span class="token punctuation">,</span>
            tool_fqn<span class="token operator">=</span>tool_fqn<span class="token punctuation">,</span>
            args<span class="token operator">=</span>params<span class="token punctuation">,</span>
            result_summary<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">"ok"</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"ok"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"keys"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># Keep small</span>
                <span class="token string">"latency_ms"</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"latency_ms"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            accept_pass<span class="token operator">=</span>accept<span class="token punctuation">,</span>
            checks<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">"missing"</span><span class="token punctuation">:</span> missing<span class="token punctuation">,</span>
                <span class="token string">"updated"</span><span class="token punctuation">:</span> <span class="token builtin">list</span><span class="token punctuation">(</span>updates<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> ExecOut<span class="token punctuation">(</span>state<span class="token operator">=</span>state<span class="token punctuation">,</span> steps<span class="token operator">=</span>exec_steps<span class="token punctuation">)</span>
</code></pre><p><strong>Rationale:</strong></p>
<ul>
<li><strong>Mirrors environment logic:</strong> Env does same thing at training time</li>
<li><strong>Lightweight summaries:</strong> Don't store full tool results (can be MB+)</li>
<li><strong>Graceful degradation:</strong> Missing MCP? Use mocks. Tool fails? Record error, continue.</li>
</ul>
<h4 id="316-reference-answer-composition">3.1.6 Reference Answer Composition </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === ADD AFTER simulate_plan_and_collect ===</span>

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">compose_reference_answer</span><span class="token punctuation">(</span>
    task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    exec_out<span class="token punctuation">:</span> ExecOut<span class="token punctuation">,</span>
    client<span class="token punctuation">:</span> AsyncOpenAI
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Generate reference final answer grounded in executed tool results.

    Two strategies:
    1. Template-based (deterministic, free)
    2. LLM-based (flexible, costs API calls)

    Returns: {answer_text, facts, citations}
    """</span>
    far <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token string">"final_answer_requirements"</span><span class="token punctuation">]</span>
    facts <span class="token operator">=</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">:</span> exec_out<span class="token punctuation">.</span>state<span class="token punctuation">.</span>get<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> name <span class="token keyword keyword-in">in</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"grounded_from"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># Strategy 1: Simple template (fast, deterministic)</span>
    <span class="token keyword keyword-if">if</span> far<span class="token punctuation">[</span><span class="token string">"format"</span><span class="token punctuation">]</span> <span class="token keyword keyword-in">in</span> <span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">,</span> <span class="token string">"markdown"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        answer_text <span class="token operator">=</span> _template_answer<span class="token punctuation">(</span>facts<span class="token punctuation">,</span> far<span class="token punctuation">)</span>

    <span class="token comment"># Strategy 2: LLM composition (flexible, higher quality)</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        system <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token string">"You are a concise analyst. Write the final answer strictly "</span>
            <span class="token string">"grounded in the provided facts. Do not hallucinate."</span>
        <span class="token punctuation">)</span>
        user_content <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"facts"</span><span class="token punctuation">:</span> facts<span class="token punctuation">,</span>
            <span class="token string">"must_include"</span><span class="token punctuation">:</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"must_include"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"format"</span><span class="token punctuation">:</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"format"</span><span class="token punctuation">,</span> <span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"quality_criteria"</span><span class="token punctuation">:</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"quality_criteria"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        resp <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
            model<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_COMPOSER_MODEL"</span><span class="token punctuation">,</span> <span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            response_format<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"json_object"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            messages<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system<span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>user_content<span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            temperature<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
            max_tokens<span class="token operator">=</span><span class="token number">512</span>
        <span class="token punctuation">)</span>

        data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
        answer_text <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"answer"</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"final_answer"</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>facts<span class="token punctuation">)</span>

    <span class="token comment"># Build citations: map each fact to last step that produced it</span>
    name_to_step <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-for">for</span> step <span class="token keyword keyword-in">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>exec_out<span class="token punctuation">.</span>steps<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-for">for</span> key <span class="token keyword keyword-in">in</span> exec_out<span class="token punctuation">.</span>state<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> key <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> name_to_step <span class="token keyword keyword-and">and</span> key <span class="token keyword keyword-in">in</span> step<span class="token punctuation">.</span>checks<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"updated"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                name_to_step<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> step<span class="token punctuation">.</span>step

    citations <span class="token operator">=</span> <span class="token punctuation">{</span>
        k<span class="token punctuation">:</span> <span class="token punctuation">[</span>name_to_step<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> k <span class="token keyword keyword-in">in</span> name_to_step
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
        <span class="token string">"answer_text"</span><span class="token punctuation">:</span> answer_text<span class="token punctuation">,</span>
        <span class="token string">"facts"</span><span class="token punctuation">:</span> facts<span class="token punctuation">,</span>
        <span class="token string">"citations"</span><span class="token punctuation">:</span> citations
    <span class="token punctuation">}</span>


<span class="token keyword keyword-def">def</span> <span class="token function">_template_answer</span><span class="token punctuation">(</span>facts<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> far<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Deterministic template-based answer composition.
    Customize per your domain.
    """</span>
    parts <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># Example: financial research</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"top3"</span> <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">:</span>
        top3 <span class="token operator">=</span> facts<span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">]</span>
        parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Top-3: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>top3<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> <span class="token string">"neg_titles"</span> <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">:</span>
        neg <span class="token operator">=</span> facts<span class="token punctuation">[</span><span class="token string">"neg_titles"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token comment"># Truncate</span>
        parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Negative headlines: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>neg<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Example: DevOps</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"exceed_buckets"</span> <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">:</span>
        buckets <span class="token operator">=</span> facts<span class="token punctuation">[</span><span class="token string">"exceed_buckets"</span><span class="token punctuation">]</span>
        parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Buckets exceeding threshold: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token string">', '</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>buckets<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> <span class="token string">"jira_id"</span> <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">:</span>
        parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Ticket: </span><span class="token interpolation"><span class="token punctuation">{</span>facts<span class="token punctuation">[</span><span class="token string">'jira_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Fallback: JSON dump</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> parts<span class="token punctuation">:</span>
        parts<span class="token punctuation">.</span>append<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>facts<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>parts<span class="token punctuation">)</span>
</code></pre><p><strong>Design Choice:</strong></p>
<ul>
<li><strong>Template first:</strong> Free, deterministic, good for structured domains</li>
<li><strong>LLM fallback:</strong> Higher quality prose, costs ~$0.0001/call</li>
<li><strong>Citations:</strong> Track provenance (which step produced each fact)</li>
</ul>
<h4 id="317-integrate-into-generation-loop">3.1.7 Integrate into Generation Loop </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === MODIFY EXISTING _one_task FUNCTION ===</span>

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_one_task</span><span class="token punctuation">(</span>
    client<span class="token punctuation">:</span> AsyncOpenAI<span class="token punctuation">,</span>
    model<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    domain<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    complexity<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    inventory<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    max_tools<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    max_turns<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    backend<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token comment"># ... [existing code to call LLM planner] ...</span>

    task_dict <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>json_text<span class="token punctuation">)</span>
    task_dict<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">"task_id"</span><span class="token punctuation">,</span> task_id<span class="token punctuation">)</span>
    task_dict<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">"tools_available"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    task_dict<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">"limits"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment"># === NEW: Verify and repair plan ===</span>
    task_dict <span class="token operator">=</span> _verify_and_repair<span class="token punctuation">(</span>task_dict<span class="token punctuation">)</span>

    <span class="token comment"># === NEW: Execute plan over MCP tools ===</span>
    tm <span class="token operator">=</span> ToolManager<span class="token punctuation">.</span>from_config_dir<span class="token punctuation">(</span><span class="token string">"mcp_servers/configs"</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> MCP_AVAILABLE <span class="token keyword keyword-else">else</span> <span class="token boolean">None</span>
    exec_out <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> simulate_plan_and_collect<span class="token punctuation">(</span>task_dict<span class="token punctuation">,</span> tm<span class="token punctuation">)</span>

    <span class="token comment"># === NEW: Compose reference final answer ===</span>
    final_ref <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> compose_reference_answer<span class="token punctuation">(</span>task_dict<span class="token punctuation">,</span> exec_out<span class="token punctuation">,</span> client<span class="token punctuation">)</span>

    <span class="token comment"># === NEW: Attach metadata ===</span>
    task_dict<span class="token punctuation">[</span><span class="token string">"_exec_out"</span><span class="token punctuation">]</span> <span class="token operator">=</span> exec_out<span class="token punctuation">.</span>to_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># Optional breadcrumbs</span>
    task_dict<span class="token punctuation">[</span><span class="token string">"_final_reference"</span><span class="token punctuation">]</span> <span class="token operator">=</span> final_ref

    <span class="token keyword keyword-return">return</span> task_dict<span class="token punctuation">,</span> raw_payload


<span class="token keyword keyword-def">def</span> <span class="token function">_verify_and_repair</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Verify plan consistency and repair minor issues.

    Checks:
    1. All next_args_from variables are introduced by prior steps
    2. Step counts match complexity guidelines
    3. No circular dependencies

    Returns: repaired task (or raises ValueError if unfixable)
    """</span>
    tool_seq <span class="token operator">=</span> task<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span>
    introduced <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-for">for</span> step <span class="token keyword keyword-in">in</span> tool_seq<span class="token punctuation">:</span>
        ar <span class="token operator">=</span> step<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"analysis_requirements"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># Check next_args_from is introduced</span>
        naf <span class="token operator">=</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"next_args_from"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> naf <span class="token keyword keyword-and">and</span> naf <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> introduced <span class="token keyword keyword-and">and</span> naf <span class="token operator">!=</span> <span class="token string">"none"</span><span class="token punctuation">:</span>
            <span class="token comment"># Try to find in extracts</span>
            <span class="token keyword keyword-for">for</span> ext <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"extract"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                base <span class="token operator">=</span> ext<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                introduced<span class="token punctuation">.</span>add<span class="token punctuation">(</span>base<span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> comp <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"compute"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> <span class="token string">"="</span> <span class="token keyword keyword-in">in</span> comp<span class="token punctuation">:</span>
                    var <span class="token operator">=</span> comp<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    introduced<span class="token punctuation">.</span>add<span class="token punctuation">(</span>var<span class="token punctuation">)</span>

            <span class="token keyword keyword-if">if</span> naf <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> introduced<span class="token punctuation">:</span>
                logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Step </span><span class="token interpolation"><span class="token punctuation">{</span>step<span class="token punctuation">[</span><span class="token string">'step'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">: next_args_from '</span><span class="token interpolation"><span class="token punctuation">{</span>naf<span class="token punctuation">}</span></span><span class="token string">' not introduced yet"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># Track what this step introduces</span>
        <span class="token keyword keyword-for">for</span> ext <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"extract"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            introduced<span class="token punctuation">.</span>add<span class="token punctuation">(</span>ext<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"compute"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"="</span> <span class="token keyword keyword-in">in</span> expr<span class="token punctuation">:</span>
                introduced<span class="token punctuation">.</span>add<span class="token punctuation">(</span>expr<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># Check step count vs complexity</span>
    complexity <span class="token operator">=</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"complexity"</span><span class="token punctuation">,</span> <span class="token string">"moderate"</span><span class="token punctuation">)</span>
    step_count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tool_seq<span class="token punctuation">)</span>
    expected <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"simple"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"moderate"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"complex"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
    lo<span class="token punctuation">,</span> hi <span class="token operator">=</span> expected<span class="token punctuation">.</span>get<span class="token punctuation">(</span>complexity<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token punctuation">(</span>lo <span class="token operator">&lt;=</span> step_count <span class="token operator">&lt;=</span> hi<span class="token punctuation">)</span><span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Step count </span><span class="token interpolation"><span class="token punctuation">{</span>step_count<span class="token punctuation">}</span></span><span class="token string"> outside expected range [</span><span class="token interpolation"><span class="token punctuation">{</span>lo<span class="token punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token punctuation">{</span>hi<span class="token punctuation">}</span></span><span class="token string">] for </span><span class="token interpolation"><span class="token punctuation">{</span>complexity<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> task
</code></pre><p><strong>Critical Points:</strong></p>
<ul>
<li><strong>verify_and_repair:</strong> Catches common planner mistakes (undefined variables)</li>
<li><strong>Logging:</strong> Warn but don't fail (planner can be retried)</li>
<li><strong>exec_out serialization:</strong> Store only summaries, not full results</li>
</ul>
<h4 id="318-update-skyrl-sample-writer">3.1.8 Update SkyRL Sample Writer </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment"># === MODIFY to_skyrl_sample IN common.py ===</span>

<span class="token keyword keyword-def">def</span> <span class="token function">to_skyrl_sample</span><span class="token punctuation">(</span>task<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">,</span> env_class<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> data_source<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> SkyRLSample<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Convert executed task into SkyRL dataset format.

    NEW: Includes analysis_rubric, final_reference, judge_rubric in ground_truth.
    """</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"user_prompt"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> task <span class="token keyword keyword-or">or</span> <span class="token keyword keyword-not">not</span> task<span class="token punctuation">[</span><span class="token string">"user_prompt"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-raise">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"Task must include 'user_prompt'"</span><span class="token punctuation">)</span>

    tool_sequence <span class="token operator">=</span> _validate_tool_sequence<span class="token punctuation">(</span>task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tool_sequence"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    system_prompt <span class="token operator">=</span> _build_system_prompt<span class="token punctuation">(</span>task<span class="token punctuation">)</span>

    prompt_messages <span class="token operator">=</span> _normalize_prompt<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> system_prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> task<span class="token punctuation">[</span><span class="token string">"user_prompt"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># === NEW: Build analysis_rubric ===</span>
    analysis_rubric <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">"step"</span><span class="token punctuation">:</span> s<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token operator">**</span>s<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"analysis_requirements"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> tool_sequence
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"final_answer_requirements"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"final_answer_requirements"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># === NEW: Extract final_reference and judge_rubric ===</span>
    final_reference <span class="token operator">=</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_final_reference"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">"answer_text"</span><span class="token punctuation">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
        <span class="token string">"facts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"citations"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    judge_rubric <span class="token operator">=</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"judge_rubric"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">"weights"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"coverage"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"grounding"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"clarity"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"safety"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
            <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"coverage"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"grounding"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"clarity"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"safety"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"total"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span> <span class="token string">"minimum"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"maximum"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"required"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"coverage"</span><span class="token punctuation">,</span> <span class="token string">"grounding"</span><span class="token punctuation">,</span> <span class="token string">"clarity"</span><span class="token punctuation">,</span> <span class="token string">"safety"</span><span class="token punctuation">,</span> <span class="token string">"total"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    ground_truth <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"task_id"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"task_id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"complexity"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"complexity"</span><span class="token punctuation">,</span> <span class="token string">"moderate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"max_turns"</span><span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">(</span>task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"max_turns"</span><span class="token punctuation">,</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tool_sequence<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"success"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"success"</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"tool_sequence"</span><span class="token punctuation">:</span> tool_sequence<span class="token punctuation">,</span>
        <span class="token string">"limits"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"limits"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"analysis_rubric"</span><span class="token punctuation">:</span> analysis_rubric<span class="token punctuation">,</span>  <span class="token comment"># NEW</span>
        <span class="token string">"final_reference"</span><span class="token punctuation">:</span> final_reference<span class="token punctuation">,</span>  <span class="token comment"># NEW</span>
        <span class="token string">"judge_rubric"</span><span class="token punctuation">:</span> judge_rubric<span class="token punctuation">,</span>  <span class="token comment"># NEW</span>
    <span class="token punctuation">}</span>

    reward_spec <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"method"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"reward_method"</span><span class="token punctuation">,</span> <span class="token string">"rule"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"ground_truth"</span><span class="token punctuation">:</span> ground_truth<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    metadata <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"task_metadata"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"source_task"</span><span class="token punctuation">:</span> task<span class="token punctuation">,</span>
            <span class="token string">"tools_available"</span><span class="token punctuation">:</span> _extract_tools<span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"model"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_model"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"backend"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_backend"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"generated_at"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"raw_output_path"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_raw_output_path"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"exec_breadcrumbs"</span><span class="token punctuation">:</span> task<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"_exec_out"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  <span class="token comment"># Optional</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-return">return</span> SkyRLSample<span class="token punctuation">(</span>
        data_source<span class="token operator">=</span>data_source<span class="token punctuation">,</span>
        env_class<span class="token operator">=</span>env_class<span class="token punctuation">,</span>
        prompt<span class="token operator">=</span>prompt_messages<span class="token punctuation">,</span>
        reward_spec<span class="token operator">=</span>reward_spec<span class="token punctuation">,</span>
        extra_info<span class="token operator">=</span>metadata<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre><h3 id="32-new-file-srcenvsreward_functionspy">3.2 New File: <code>src/envs/reward_functions.py</code> </h3>
<p><strong>Purpose:</strong> Centralize DSL and reward logic shared by generator and environment</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token triple-quoted-string string">"""
Reward computation and DSL utilities for multi-turn tool use.

Shared by:
- src/dataset/llm/generate_with_llm.py (data generation)
- src/envs/mcp_tool_env.py (RL environment)

Ensures consistency: same DSL semantics at generation and training time.
"""</span>

<span class="token keyword keyword-from">from</span> __future__ <span class="token keyword keyword-import">import</span> annotations
<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> re
<span class="token keyword keyword-from">from</span> copy <span class="token keyword keyword-import">import</span> deepcopy
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Any<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Tuple

<span class="token comment"># === DSL FUNCTIONS ===</span>
<span class="token comment"># (Copy exact implementations from generate_with_llm.py)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">extract_path</span><span class="token punctuation">(</span>result<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> path<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span>Optional<span class="token punctuation">[</span>Any<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""[exact same as _extract_path in generator]"""</span>
    <span class="token comment"># ... (copy full implementation)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">compute_dsl</span><span class="token punctuation">(</span>expr<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">dict</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""[exact same as _compute in generator]"""</span>
    <span class="token comment"># ... (copy full implementation)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">check_cond</span><span class="token punctuation">(</span>cond<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""[exact same as _check in generator]"""</span>
    <span class="token comment"># ... (copy full implementation)</span>

<span class="token keyword keyword-def">def</span> <span class="token function">resolve_placeholders</span><span class="token punctuation">(</span>obj<span class="token punctuation">:</span> Any<span class="token punctuation">,</span> state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Any<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""[exact same as _resolve_placeholders in generator]"""</span>
    <span class="token comment"># ... (copy full implementation)</span>


<span class="token comment"># === REWARD SCORING ===</span>

<span class="token keyword keyword-def">def</span> <span class="token function">score_tool_step_heuristic</span><span class="token punctuation">(</span>
    step_idx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
    tool_fqn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    args<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    result<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    gt<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    state<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    weights<span class="token punctuation">:</span> <span class="token builtin">dict</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Compute heuristic reward for a tool execution step.

    Components:
    1. Tool name match (0.2): Did agent call the expected tool?
    2. Param binding (0.15): Did agent use next_args_from variable?
    3. Extract success (0.15): Were required fields extracted?
    4. Compute success (0.15): Did compute/select expressions succeed?
    5. Accept_if pass (0.1): Did validation conditions pass?

    Returns: (reward, metadata)
    """</span>
    reward <span class="token operator">=</span> <span class="token number">0.0</span>
    breakdown <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"tool"</span><span class="token punctuation">:</span> tool_fqn<span class="token punctuation">,</span>
        <span class="token string">"args"</span><span class="token punctuation">:</span> args<span class="token punctuation">,</span>
        <span class="token string">"accept_if"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># Find expected tool for this step</span>
    expected_fqn <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword keyword-for">for</span> st <span class="token keyword keyword-in">in</span> gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tool_sequence"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>st<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> step_idx<span class="token punctuation">:</span>
            expected_fqn <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>st<span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>st<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
            <span class="token keyword keyword-break">break</span>

    <span class="token comment"># 1. Tool name reward</span>
    <span class="token keyword keyword-if">if</span> expected_fqn <span class="token operator">==</span> tool_fqn<span class="token punctuation">:</span>
        reward <span class="token operator">+=</span> weights<span class="token punctuation">[</span><span class="token string">"tool_name"</span><span class="token punctuation">]</span>
        breakdown<span class="token punctuation">[</span><span class="token string">"tool_name_match"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        breakdown<span class="token punctuation">[</span><span class="token string">"tool_name_match"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>
        breakdown<span class="token punctuation">[</span><span class="token string">"expected"</span><span class="token punctuation">]</span> <span class="token operator">=</span> expected_fqn

    <span class="token comment"># Get analysis rubric for this step</span>
    ar <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"analysis_rubric"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"steps"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> step_idx<span class="token punctuation">:</span>
            ar <span class="token operator">=</span> s
            <span class="token keyword keyword-break">break</span>

    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> ar<span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> reward<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"warn"</span><span class="token punctuation">:</span> <span class="token string">"no_rubric"</span><span class="token punctuation">}</span>

    <span class="token comment"># 2. Param binding reward</span>
    naf <span class="token operator">=</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"next_args_from"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> naf<span class="token punctuation">:</span>
        args_str <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>args<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> naf <span class="token keyword keyword-in">in</span> args_str<span class="token punctuation">:</span>
            reward <span class="token operator">+=</span> weights<span class="token punctuation">[</span><span class="token string">"param_binding"</span><span class="token punctuation">]</span>
            breakdown<span class="token punctuation">[</span><span class="token string">"param_binding"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            breakdown<span class="token punctuation">[</span><span class="token string">"param_binding"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token comment"># 3. Extract reward</span>
    ext_ok <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword keyword-for">for</span> need <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"extract"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        val<span class="token punctuation">,</span> ok <span class="token operator">=</span> extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> need<span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> ok<span class="token punctuation">:</span>
            ext_ok <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            key <span class="token operator">=</span> need<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"{"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            state<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val  <span class="token comment"># Update state for next step</span>

    <span class="token keyword keyword-if">if</span> ext_ok<span class="token punctuation">:</span>
        reward <span class="token operator">+=</span> weights<span class="token punctuation">[</span><span class="token string">"extract"</span><span class="token punctuation">]</span>
        breakdown<span class="token punctuation">[</span><span class="token string">"extract"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"success"</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        breakdown<span class="token punctuation">[</span><span class="token string">"extract"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"failed"</span>

    <span class="token comment"># 4. Compute/select reward</span>
    <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"compute"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>compute_dsl<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> expr <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"select"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            state<span class="token punctuation">.</span>update<span class="token punctuation">(</span>compute_dsl<span class="token punctuation">(</span>expr<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">)</span>
        reward <span class="token operator">+=</span> weights<span class="token punctuation">[</span><span class="token string">"compute"</span><span class="token punctuation">]</span>
        breakdown<span class="token punctuation">[</span><span class="token string">"compute"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"success"</span>
    <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
        breakdown<span class="token punctuation">[</span><span class="token string">"compute"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"failed: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>

    <span class="token comment"># 5. Accept_if reward</span>
    pass_all <span class="token operator">=</span> <span class="token boolean">True</span>
    <span class="token keyword keyword-for">for</span> cond <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"accept_if"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        ok <span class="token operator">=</span> check_cond<span class="token punctuation">(</span>cond<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
        pass_all <span class="token operator">=</span> pass_all <span class="token keyword keyword-and">and</span> ok
        breakdown<span class="token punctuation">[</span><span class="token string">"accept_if"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"cond"</span><span class="token punctuation">:</span> cond<span class="token punctuation">,</span> <span class="token string">"ok"</span><span class="token punctuation">:</span> ok<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> pass_all<span class="token punctuation">:</span>
        reward <span class="token operator">+=</span> weights<span class="token punctuation">[</span><span class="token string">"accept_if"</span><span class="token punctuation">]</span>

    <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>reward<span class="token punctuation">)</span><span class="token punctuation">,</span> breakdown


<span class="token keyword keyword-def">def</span> <span class="token function">score_final_answer_heuristic</span><span class="token punctuation">(</span>
    text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    gt<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    state<span class="token punctuation">:</span> <span class="token builtin">dict</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Compute heuristic reward for final text answer.

    Components:
    1. Coverage: Does text include all must_include facts?
    2. Grounding: Is text consistent with reference facts?
    3. Clarity: Is length in target range?
    4. Safety: No sensitive info patterns?

    Returns: (weighted_score, breakdown)
    """</span>
    far <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"analysis_rubric"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"final_answer_requirements"</span><span class="token punctuation">]</span>
    jr <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"judge_rubric"</span><span class="token punctuation">]</span>
    weights <span class="token operator">=</span> jr<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"weights"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    lo<span class="token punctuation">,</span> hi <span class="token operator">=</span> jr<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"target_length_range"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token operator">**</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 1. Coverage</span>
    must <span class="token operator">=</span> far<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"must_include"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    cov_hits <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>
        <span class="token number">1</span> <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> must
        <span class="token keyword keyword-if">if</span> k <span class="token keyword keyword-in">in</span> text <span class="token keyword keyword-or">or</span> k <span class="token keyword keyword-in">in</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    coverage <span class="token operator">=</span> cov_hits <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>must<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 2. Grounding</span>
    facts <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"facts"</span><span class="token punctuation">]</span>
    grounding <span class="token operator">=</span> _grounding_score<span class="token punctuation">(</span>text<span class="token punctuation">,</span> facts<span class="token punctuation">)</span>

    <span class="token comment"># 3. Clarity (simple length check)</span>
    words <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-if">if</span> lo <span class="token operator">&lt;=</span> words <span class="token operator">&lt;=</span> hi<span class="token punctuation">:</span>
        clarity <span class="token operator">=</span> <span class="token number">1.0</span>
    <span class="token keyword keyword-elif">elif</span> <span class="token punctuation">(</span><span class="token number">0.7</span> <span class="token operator">*</span> lo<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> words <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token number">1.5</span> <span class="token operator">*</span> hi<span class="token punctuation">)</span><span class="token punctuation">:</span>
        clarity <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        clarity <span class="token operator">=</span> <span class="token number">0.0</span>

    <span class="token comment"># 4. Safety (basic blacklist)</span>
    safety <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"\b(SSN|password|api_key|secret)\b"</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> re<span class="token punctuation">.</span>I<span class="token punctuation">)</span> <span class="token keyword keyword-else">else</span> <span class="token number">0.0</span>

    <span class="token comment"># Weighted sum</span>
    total <span class="token operator">=</span> <span class="token punctuation">(</span>
        weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"coverage"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> coverage <span class="token operator">+</span>
        weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"grounding"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> grounding <span class="token operator">+</span>
        weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"clarity"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> clarity <span class="token operator">+</span>
        weights<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"safety"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*</span> safety
    <span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token string">"coverage"</span><span class="token punctuation">:</span> coverage<span class="token punctuation">,</span>
        <span class="token string">"grounding"</span><span class="token punctuation">:</span> grounding<span class="token punctuation">,</span>
        <span class="token string">"clarity"</span><span class="token punctuation">:</span> clarity<span class="token punctuation">,</span>
        <span class="token string">"safety"</span><span class="token punctuation">:</span> safety<span class="token punctuation">,</span>
        <span class="token string">"word_count"</span><span class="token punctuation">:</span> words
    <span class="token punctuation">}</span>


<span class="token keyword keyword-def">def</span> <span class="token function">_grounding_score</span><span class="token punctuation">(</span>text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> facts<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">float</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Check if text mentions are consistent with reference facts.

    Example: If facts["top3"] = ["NVDA", "AMD", "META"],
    ensure text only mentions these tickers (no hallucinations).
    """</span>
    <span class="token comment"># Example for financial domain</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"top3"</span> <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">:</span>
        mentions <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span><span class="token string">r"\b[A-Z]{1,5}\b"</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">)</span>
        target <span class="token operator">=</span> <span class="token builtin">set</span><span class="token punctuation">(</span>facts<span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> mentions<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> <span class="token number">0.5</span>  <span class="token comment"># Neutral: no mentions</span>
        <span class="token comment"># All mentions must be in target</span>
        ok <span class="token operator">=</span> <span class="token builtin">all</span><span class="token punctuation">(</span>m <span class="token keyword keyword-in">in</span> target <span class="token keyword keyword-for">for</span> m <span class="token keyword keyword-in">in</span> mentions <span class="token keyword keyword-if">if</span> m<span class="token punctuation">.</span>isupper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">1.0</span> <span class="token keyword keyword-if">if</span> ok <span class="token keyword keyword-else">else</span> <span class="token number">0.0</span>

    <span class="token comment"># Generic: assume grounded if mentions any fact values</span>
    fact_values <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token builtin">str</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> v <span class="token keyword keyword-in">in</span> facts<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> v<span class="token punctuation">}</span>
    <span class="token keyword keyword-if">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>fv <span class="token keyword keyword-in">in</span> text <span class="token keyword keyword-for">for</span> fv <span class="token keyword keyword-in">in</span> fact_values<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> <span class="token number">1.0</span>

    <span class="token keyword keyword-return">return</span> <span class="token number">0.5</span>  <span class="token comment"># Neutral</span>


<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">score_final_answer_laj</span><span class="token punctuation">(</span>
    client<span class="token punctuation">,</span>
    text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span>
    gt<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span>
    state<span class="token punctuation">:</span> <span class="token builtin">dict</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Compute LLM-as-a-Judge reward for final text answer.

    Uses OpenAI Structured Outputs to enforce numeric scoring schema.

    Returns: (total_score, judge_details)
    """</span>
    schema <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"judge_rubric"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"schema"</span><span class="token punctuation">]</span>
    facts <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"facts"</span><span class="token punctuation">]</span>
    reference <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"answer_text"</span><span class="token punctuation">]</span>

    rubric_prompt <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">"instructions"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token string">"Evaluate the FINAL answer vs the reference and facts."</span><span class="token punctuation">,</span>
            <span class="token string">"Return ONLY valid JSON matching the schema."</span><span class="token punctuation">,</span>
            <span class="token string">"Provide numeric scores in [0, 1] range."</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"facts"</span><span class="token punctuation">:</span> facts<span class="token punctuation">,</span>
        <span class="token string">"reference"</span><span class="token punctuation">:</span> reference<span class="token punctuation">,</span>
        <span class="token string">"final"</span><span class="token punctuation">:</span> text
    <span class="token punctuation">}</span>

    <span class="token keyword keyword-import">import</span> os
    resp <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span>os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"OPENAI_JUDGE_MODEL"</span><span class="token punctuation">,</span> <span class="token string">"gpt-4o-mini"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        response_format<span class="token operator">=</span><span class="token punctuation">{</span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"json_schema"</span><span class="token punctuation">,</span>
            <span class="token string">"json_schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"name"</span><span class="token punctuation">:</span> <span class="token string">"judge_schema"</span><span class="token punctuation">,</span>
                <span class="token string">"schema"</span><span class="token punctuation">:</span> schema
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        messages<span class="token operator">=</span><span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"You are a strict, unbiased evaluator."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>rubric_prompt<span class="token punctuation">)</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        temperature<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span>
        max_tokens<span class="token operator">=</span><span class="token number">512</span>
    <span class="token punctuation">)</span>

    data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>resp<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content<span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> <span class="token builtin">float</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"total"</span><span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> data
</code></pre><p><strong>Rationale:</strong></p>
<ul>
<li>Single source of truth for DSL semantics</li>
<li>Environment imports from here (no duplication)</li>
<li>Easy to add new functions (extend whitelist)</li>
</ul>
<hr>
<h2 id="4-phase-2-environment-reward-system">4. Phase 2: Environment Reward System </h2>
<h3 id="41-file-srcenvsmcp_tool_envpy-major-rewrite">4.1 File: <code>src/envs/mcp_tool_env.py</code> (Major Rewrite) </h3>
<p><strong>Current Issues:</strong></p>
<ul>
<li>Trivial reward (binary check on first tool)</li>
<li>No state tracking</li>
<li>No final answer handling</li>
</ul>
<p><strong>Target:</strong></p>
<ul>
<li>Dense per-step rewards using analysis rubric</li>
<li>Final answer scoring (heuristic + LAJ)</li>
<li>Clean <code>BaseTextEnvStepOutput</code> returns</li>
</ul>
<h4 id="411-imports-and-config">4.1.1 Imports and Config </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-from">from</span> __future__ <span class="token keyword keyword-import">import</span> annotations

<span class="token keyword keyword-import">import</span> asyncio
<span class="token keyword keyword-import">import</span> hashlib
<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> os
<span class="token keyword keyword-import">import</span> re
<span class="token keyword keyword-from">from</span> dataclasses <span class="token keyword keyword-import">import</span> dataclass
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Any<span class="token punctuation">,</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Tuple

<span class="token keyword keyword-from">from</span> openai <span class="token keyword keyword-import">import</span> AsyncOpenAI
<span class="token keyword keyword-from">from</span> skyrl_gym<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>base_text_env <span class="token keyword keyword-import">import</span> BaseTextEnv<span class="token punctuation">,</span> BaseTextEnvStepOutput

<span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>mcp_tool_group <span class="token keyword keyword-import">import</span> MCPToolGroup
<span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>reward_functions <span class="token keyword keyword-import">import</span> <span class="token punctuation">(</span>
    check_cond<span class="token punctuation">,</span>
    compute_dsl<span class="token punctuation">,</span>
    extract_path<span class="token punctuation">,</span>
    resolve_placeholders<span class="token punctuation">,</span>
    score_final_answer_heuristic<span class="token punctuation">,</span>
    score_final_answer_laj<span class="token punctuation">,</span>
    score_tool_step_heuristic<span class="token punctuation">,</span>
<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword keyword-class">class</span> <span class="token class-name">MCPEnvConfig</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Environment configuration."""</span>
    max_turns<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">8</span>
    tools<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    reward_weights<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    enable_laj<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span>  <span class="token comment"># Enable LLM-as-a-Judge</span>
    laj_cache_size<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1000</span>  <span class="token comment"># Cache LAJ calls</span>
</code></pre><h4 id="412-environment-class">4.1.2 Environment Class </h4>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-class">class</span> <span class="token class-name">MCPToolEnv</span><span class="token punctuation">(</span>BaseTextEnv<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Multi-turn, multi-tool environment with dense rewards.

    Supports:
    - Tool execution with per-step analysis rewards
    - Final text answer with heuristic + LAJ scoring
    - State tracking across turns
    - Action parsing (JSON and XML-style)
    """</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>MCPEnvConfig<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>config <span class="token operator">=</span> config <span class="token keyword keyword-or">or</span> MCPEnvConfig<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># Tool setup</span>
        allowed <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>tools <span class="token keyword keyword-or">or</span> <span class="token punctuation">[</span><span class="token string">"polygon"</span><span class="token punctuation">,</span> <span class="token string">"fmp"</span><span class="token punctuation">,</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span> <span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"slack"</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>init_tool_groups<span class="token punctuation">(</span><span class="token punctuation">[</span>MCPToolGroup<span class="token punctuation">(</span>allowed<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Reward weights</span>
        self<span class="token punctuation">.</span>weights <span class="token operator">=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>reward_weights <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span>
            <span class="token string">"tool_name"</span><span class="token punctuation">:</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
            <span class="token string">"param_binding"</span><span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
            <span class="token string">"extract"</span><span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
            <span class="token string">"compute"</span><span class="token punctuation">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
            <span class="token string">"accept_if"</span><span class="token punctuation">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span>
            <span class="token string">"penalty"</span><span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">0.1</span><span class="token punctuation">,</span>
            <span class="token string">"final_heur"</span><span class="token punctuation">:</span> <span class="token number">0.6</span><span class="token punctuation">,</span>
            <span class="token string">"final_laj"</span><span class="token punctuation">:</span> <span class="token number">0.4</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>

        <span class="token comment"># LLM-as-a-Judge client</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>enable_laj<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>judge <span class="token operator">=</span> AsyncOpenAI<span class="token punctuation">(</span>api_key<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"OPENAI_API_KEY"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_laj_cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># {hash: (score, details)}</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>judge <span class="token operator">=</span> <span class="token boolean">None</span>
            self<span class="token punctuation">.</span>_laj_cache <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        <span class="token comment"># Episode state</span>
        self<span class="token punctuation">.</span>turn <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>gt <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># ground_truth from reward_spec</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>  <span class="token comment"># Derived named variables (like generator)</span>

    <span class="token comment"># ===== BaseTextEnv API =====</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">init</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        prompt<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        ground_truth<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Initialize episode with dataset prompt and ground truth.

        Args:
            prompt: List of message dicts (system, user)
            ground_truth: reward_spec.ground_truth from dataset

        Returns:
            (prompt, info_dict)
        """</span>
        self<span class="token punctuation">.</span>turn <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>gt <span class="token operator">=</span> ground_truth <span class="token keyword keyword-or">or</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

        info <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"task_id"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"task_id"</span><span class="token punctuation">,</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"complexity"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"complexity"</span><span class="token punctuation">,</span> <span class="token string">"moderate"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"max_turns"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"max_turns"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>max_turns<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword keyword-return">return</span> prompt<span class="token punctuation">,</span> info

    <span class="token keyword keyword-def">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BaseTextEnvStepOutput<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Execute one environment step.

        Args:
            action: Model output (JSON tool call or final answer)

        Returns:
            BaseTextEnvStepOutput with observations, reward, done, metadata
        """</span>
        self<span class="token punctuation">.</span>turn <span class="token operator">+=</span> <span class="token number">1</span>
        kind<span class="token punctuation">,</span> payload <span class="token operator">=</span> self<span class="token punctuation">.</span>_parse_action<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> kind <span class="token operator">==</span> <span class="token string">"tool"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>_step_tool<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        <span class="token keyword keyword-elif">elif</span> kind <span class="token operator">==</span> <span class="token string">"final"</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>_step_final<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token comment"># Unknown action type: penalty</span>
            <span class="token keyword keyword-return">return</span> BaseTextEnvStepOutput<span class="token punctuation">(</span>
                observations<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"invalid_action"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                reward<span class="token operator">=</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">[</span><span class="token string">"penalty"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                done<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>turn <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>max_turns<span class="token punctuation">)</span><span class="token punctuation">,</span>
                metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"parse_failed"</span><span class="token punctuation">}</span>
            <span class="token punctuation">)</span>

    <span class="token comment"># ===== Tool Step =====</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_step_tool</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> payload<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BaseTextEnvStepOutput<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Handle tool execution step."""</span>
        tool_fqn <span class="token operator">=</span> payload<span class="token punctuation">[</span><span class="token string">"name"</span><span class="token punctuation">]</span>
        args <span class="token operator">=</span> payload<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"arguments"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># Execute tool via ToolGroup</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            group_name<span class="token punctuation">,</span> tool_name <span class="token operator">=</span> tool_fqn<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            result <span class="token operator">=</span> self<span class="token punctuation">.</span>_execute_tool<span class="token punctuation">(</span>group_name<span class="token punctuation">,</span> tool_name<span class="token punctuation">,</span> <span class="token punctuation">[</span>args<span class="token punctuation">]</span><span class="token punctuation">)</span>

            <span class="token comment"># Parse result (ToolGroup returns JSON string)</span>
            <span class="token keyword keyword-if">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                result <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token keyword keyword-except">except</span> Exception <span class="token keyword keyword-as">as</span> e<span class="token punctuation">:</span>
            <span class="token comment"># Tool execution failed: penalty</span>
            <span class="token keyword keyword-return">return</span> BaseTextEnvStepOutput<span class="token punctuation">(</span>
                observations<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                reward<span class="token operator">=</span>self<span class="token punctuation">.</span>weights<span class="token punctuation">[</span><span class="token string">"penalty"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                done<span class="token operator">=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>turn <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>max_turns<span class="token punctuation">)</span><span class="token punctuation">,</span>
                metadata<span class="token operator">=</span><span class="token punctuation">{</span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"tool_exec"</span><span class="token punctuation">,</span> <span class="token string">"exception"</span><span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># Match step to ground truth</span>
        step_idx <span class="token operator">=</span> self<span class="token punctuation">.</span>_match_step<span class="token punctuation">(</span>tool_fqn<span class="token punctuation">)</span>

        <span class="token comment"># Score with heuristic rewards</span>
        r_step<span class="token punctuation">,</span> breakdown <span class="token operator">=</span> score_tool_step_heuristic<span class="token punctuation">(</span>
            step_idx<span class="token operator">=</span>step_idx<span class="token punctuation">,</span>
            tool_fqn<span class="token operator">=</span>tool_fqn<span class="token punctuation">,</span>
            args<span class="token operator">=</span>args<span class="token punctuation">,</span>
            result<span class="token operator">=</span>result<span class="token punctuation">,</span>
            gt<span class="token operator">=</span>self<span class="token punctuation">.</span>gt<span class="token punctuation">,</span>
            state<span class="token operator">=</span>self<span class="token punctuation">.</span>state<span class="token punctuation">,</span>  <span class="token comment"># Will be updated in place</span>
            weights<span class="token operator">=</span>self<span class="token punctuation">.</span>weights
        <span class="token punctuation">)</span>

        <span class="token comment"># Check termination</span>
        done <span class="token operator">=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>turn <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>max_turns<span class="token punctuation">)</span>

        <span class="token comment"># Build observations</span>
        observations <span class="token operator">=</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">}</span>  <span class="token comment"># Truncate</span>
        <span class="token punctuation">]</span>

        <span class="token keyword keyword-return">return</span> BaseTextEnvStepOutput<span class="token punctuation">(</span>
            observations<span class="token operator">=</span>observations<span class="token punctuation">,</span>
            reward<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">(</span>r_step<span class="token punctuation">)</span><span class="token punctuation">,</span>
            done<span class="token operator">=</span>done<span class="token punctuation">,</span>
            metadata<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">"step"</span><span class="token punctuation">:</span> step_idx<span class="token punctuation">,</span>
                <span class="token string">"turn"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>turn<span class="token punctuation">,</span>
                <span class="token operator">**</span>breakdown
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>

    <span class="token comment"># ===== Final Answer Step =====</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_step_final</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> final_text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> BaseTextEnvStepOutput<span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Handle final answer step."""</span>
        <span class="token comment"># Heuristic scoring</span>
        r_heur<span class="token punctuation">,</span> heur_meta <span class="token operator">=</span> score_final_answer_heuristic<span class="token punctuation">(</span>
            text<span class="token operator">=</span>final_text<span class="token punctuation">,</span>
            gt<span class="token operator">=</span>self<span class="token punctuation">.</span>gt<span class="token punctuation">,</span>
            state<span class="token operator">=</span>self<span class="token punctuation">.</span>state
        <span class="token punctuation">)</span>

        <span class="token comment"># LLM-as-a-Judge scoring</span>
        <span class="token keyword keyword-if">if</span> self<span class="token punctuation">.</span>judge<span class="token punctuation">:</span>
            r_laj<span class="token punctuation">,</span> laj_meta <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_until_complete<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>_score_laj_cached<span class="token punctuation">(</span>final_text<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            r_laj<span class="token punctuation">,</span> laj_meta <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"disabled"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>

        <span class="token comment"># Combine rewards</span>
        total <span class="token operator">=</span> <span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>weights<span class="token punctuation">[</span><span class="token string">"final_heur"</span><span class="token punctuation">]</span> <span class="token operator">*</span> r_heur <span class="token operator">+</span>
            self<span class="token punctuation">.</span>weights<span class="token punctuation">[</span><span class="token string">"final_laj"</span><span class="token punctuation">]</span> <span class="token operator">*</span> r_laj
        <span class="token punctuation">)</span>

        <span class="token keyword keyword-return">return</span> BaseTextEnvStepOutput<span class="token punctuation">(</span>
            observations<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># No more observations after final</span>
            reward<span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">,</span>
            done<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            metadata<span class="token operator">=</span><span class="token punctuation">{</span>
                <span class="token string">"turn"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>turn<span class="token punctuation">,</span>
                <span class="token string">"final"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"heur"</span><span class="token punctuation">:</span> heur_meta<span class="token punctuation">,</span>
                    <span class="token string">"laj"</span><span class="token punctuation">:</span> laj_meta<span class="token punctuation">,</span>
                    <span class="token string">"text_length"</span><span class="token punctuation">:</span> <span class="token builtin">len</span><span class="token punctuation">(</span>final_text<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">)</span>

    <span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">_score_laj_cached</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">,</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Score with LAJ, using cache to avoid redundant calls."""</span>
        task_id <span class="token operator">=</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"task_id"</span><span class="token punctuation">,</span> <span class="token string">"unknown"</span><span class="token punctuation">)</span>
        cache_key <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span><span class="token punctuation">(</span>task_id <span class="token operator">+</span> text<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword keyword-if">if</span> cache_key <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>_laj_cache<span class="token punctuation">:</span>
            <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>_laj_cache<span class="token punctuation">[</span>cache_key<span class="token punctuation">]</span>

        score<span class="token punctuation">,</span> details <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> score_final_answer_laj<span class="token punctuation">(</span>
            client<span class="token operator">=</span>self<span class="token punctuation">.</span>judge<span class="token punctuation">,</span>
            text<span class="token operator">=</span>text<span class="token punctuation">,</span>
            gt<span class="token operator">=</span>self<span class="token punctuation">.</span>gt<span class="token punctuation">,</span>
            state<span class="token operator">=</span>self<span class="token punctuation">.</span>state
        <span class="token punctuation">)</span>

        <span class="token comment"># Cache (LRU-style: if full, clear oldest half)</span>
        <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_laj_cache<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> self<span class="token punctuation">.</span>config<span class="token punctuation">.</span>laj_cache_size<span class="token punctuation">:</span>
            keys <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_laj_cache<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> k <span class="token keyword keyword-in">in</span> keys<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>keys<span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-del">del</span> self<span class="token punctuation">.</span>_laj_cache<span class="token punctuation">[</span>k<span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>_laj_cache<span class="token punctuation">[</span>cache_key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>score<span class="token punctuation">,</span> details<span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> score<span class="token punctuation">,</span> details

    <span class="token comment"># ===== Helpers =====</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_match_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tool_fqn<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Match tool FQN to expected step index in ground truth.

        Returns: step index (or current turn if no match)
        """</span>
        <span class="token keyword keyword-for">for</span> s <span class="token keyword keyword-in">in</span> self<span class="token punctuation">.</span>gt<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tool_sequence"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            expected_fqn <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>s<span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>s<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
            <span class="token keyword keyword-if">if</span> expected_fqn <span class="token operator">==</span> tool_fqn<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token builtin">int</span><span class="token punctuation">(</span>s<span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> self<span class="token punctuation">.</span>turn  <span class="token comment"># Fallback: use turn number</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">_parse_action</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> text<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        Parse action from model output.

        Supported formats:
        1. JSON tool call: {"tool": "server.tool", "arguments": {...}}
        2. JSON final answer: {"final_answer": "text"}
        3. XML tool call: &lt;tool&gt;&lt;name&gt;...&lt;/name&gt;&lt;/tool&gt;
        4. XML final answer: &lt;answer&gt;text&lt;/answer&gt;
        5. Plain text: treat as final answer

        Returns: (kind, payload)
            kind: "tool" | "final" | "unknown"
            payload: dict (for tool) or str (for final)
        """</span>
        <span class="token comment"># Try JSON first</span>
        <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
            obj <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"tool"</span> <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                    <span class="token string">"name"</span><span class="token punctuation">:</span> obj<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"arguments"</span><span class="token punctuation">:</span> obj<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"arguments"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"final_answer"</span> <span class="token keyword keyword-in">in</span> obj<span class="token punctuation">:</span>
                <span class="token keyword keyword-return">return</span> <span class="token string">"final"</span><span class="token punctuation">,</span> obj<span class="token punctuation">[</span><span class="token string">"final_answer"</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
            <span class="token keyword keyword-pass">pass</span>

        <span class="token comment"># Try XML tags</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"&lt;answer&gt;"</span> <span class="token keyword keyword-in">in</span> text <span class="token keyword keyword-and">and</span> <span class="token string">"&lt;/answer&gt;"</span> <span class="token keyword keyword-in">in</span> text<span class="token punctuation">:</span>
            ans <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;answer&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;/answer&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-return">return</span> <span class="token string">"final"</span><span class="token punctuation">,</span> ans

        <span class="token keyword keyword-if">if</span> <span class="token string">"&lt;tool&gt;"</span> <span class="token keyword keyword-in">in</span> text <span class="token keyword keyword-and">and</span> <span class="token string">"&lt;/tool&gt;"</span> <span class="token keyword keyword-in">in</span> text<span class="token punctuation">:</span>
            inner <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;tool&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"&lt;/tool&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            m <span class="token operator">=</span> re<span class="token punctuation">.</span>search<span class="token punctuation">(</span><span class="token string">r"&lt;([a-zA-Z0-9_.-]+)&gt;(.*?)&lt;/\1&gt;"</span><span class="token punctuation">,</span> inner<span class="token punctuation">,</span> re<span class="token punctuation">.</span>DOTALL<span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> m<span class="token punctuation">:</span>
                name<span class="token punctuation">,</span> args_text <span class="token operator">=</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m<span class="token punctuation">.</span>group<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword keyword-try">try</span><span class="token punctuation">:</span>
                    args <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>args_text<span class="token punctuation">)</span>
                <span class="token keyword keyword-except">except</span> Exception<span class="token punctuation">:</span>
                    args <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"raw"</span><span class="token punctuation">:</span> args_text<span class="token punctuation">}</span>
                <span class="token keyword keyword-return">return</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"name"</span><span class="token punctuation">:</span> name<span class="token punctuation">,</span> <span class="token string">"arguments"</span><span class="token punctuation">:</span> args<span class="token punctuation">}</span>

        <span class="token comment"># Default: treat as final answer</span>
        <span class="token keyword keyword-return">return</span> <span class="token string">"final"</span><span class="token punctuation">,</span> text<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><strong>Key Points:</strong></p>
<ul>
<li><strong>State tracking:</strong> <code>self.state</code> updated in <code>score_tool_step_heuristic</code> (via reward_functions)</li>
<li><strong>LAJ caching:</strong> Avoid redundant API calls (same task + text → cached)</li>
<li><strong>Graceful degradation:</strong> If LAJ disabled, falls back to heuristic only</li>
<li><strong>Clean metadata:</strong> Per-step breakdowns for debugging</li>
</ul>
<h3 id="42-testing-strategy">4.2 Testing Strategy </h3>
<h4 id="421-unit-tests-for-dsl">4.2.1 Unit Tests for DSL </h4>
<p><strong>File:</strong> <code>tests/test_dsl.py</code></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token triple-quoted-string string">"""Unit tests for safe DSL functions."""</span>

<span class="token keyword keyword-import">import</span> pytest
<span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>reward_functions <span class="token keyword keyword-import">import</span> extract_path<span class="token punctuation">,</span> compute_dsl<span class="token punctuation">,</span> check_cond

<span class="token keyword keyword-def">def</span> <span class="token function">test_extract_path_simple</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">42.5</span><span class="token punctuation">}</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">=</span> extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-assert">assert</span> ok
    <span class="token keyword keyword-assert">assert</span> val <span class="token operator">==</span> <span class="token number">42.5</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_extract_path_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"tickers"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"AAPL"</span><span class="token punctuation">,</span> <span class="token string">"GOOG"</span><span class="token punctuation">,</span> <span class="token string">"MSFT"</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">=</span> extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">"tickers[]"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-assert">assert</span> ok
    <span class="token keyword keyword-assert">assert</span> val <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token string">"AAPL"</span><span class="token punctuation">,</span> <span class="token string">"GOOG"</span><span class="token punctuation">,</span> <span class="token string">"MSFT"</span><span class="token punctuation">]</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_extract_path_nested</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"articles"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"B"</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">=</span> extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">"articles[][title]"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-assert">assert</span> ok
    <span class="token keyword keyword-assert">assert</span> val <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token string">"B"</span><span class="token punctuation">]</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_extract_path_map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"data"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"ticker"</span><span class="token punctuation">:</span> <span class="token string">"AAPL"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"ticker"</span><span class="token punctuation">:</span> <span class="token string">"GOOG"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    val<span class="token punctuation">,</span> ok <span class="token operator">=</span> extract_path<span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token string">"data{ticker-&gt;score}"</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-assert">assert</span> ok
    <span class="token keyword keyword-assert">assert</span> val <span class="token operator">==</span> <span class="token punctuation">{</span><span class="token string">"AAPL"</span><span class="token punctuation">:</span> <span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token string">"GOOG"</span><span class="token punctuation">:</span> <span class="token number">0.7</span><span class="token punctuation">}</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_compute_topk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"pct"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"AAPL"</span><span class="token punctuation">:</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token string">"GOOG"</span><span class="token punctuation">:</span> <span class="token number">0.03</span><span class="token punctuation">,</span> <span class="token string">"MSFT"</span><span class="token punctuation">:</span> <span class="token number">0.08</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    out <span class="token operator">=</span> compute_dsl<span class="token punctuation">(</span><span class="token string">"top3 = topk(pct, 3)"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token keyword keyword-assert">assert</span> <span class="token string">"top3"</span> <span class="token keyword keyword-in">in</span> out
    <span class="token keyword keyword-assert">assert</span> out<span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token string">"MSFT"</span><span class="token punctuation">,</span> <span class="token string">"AAPL"</span><span class="token punctuation">,</span> <span class="token string">"GOOG"</span><span class="token punctuation">]</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_compute_head</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"items"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    out <span class="token operator">=</span> compute_dsl<span class="token punctuation">(</span><span class="token string">"first3 = head(items, 3)"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
    <span class="token keyword keyword-assert">assert</span> out<span class="token punctuation">[</span><span class="token string">"first3"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_check_cond_numeric</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-assert">assert</span> check_cond<span class="token punctuation">(</span><span class="token string">"count &gt;= 5"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">True</span>
    <span class="token keyword keyword-assert">assert</span> check_cond<span class="token punctuation">(</span><span class="token string">"count &lt; 5"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">False</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_check_cond_regex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://example.com"</span><span class="token punctuation">}</span>
    <span class="token keyword keyword-assert">assert</span> check_cond<span class="token punctuation">(</span><span class="token string">"url ~= '^https://'"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">True</span>
    <span class="token keyword keyword-assert">assert</span> check_cond<span class="token punctuation">(</span><span class="token string">"url ~= '^http://'"</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">False</span>
</code></pre><h4 id="422-environment-step-tests">4.2.2 Environment Step Tests </h4>
<p><strong>File:</strong> <code>tests/test_env_rewards.py</code></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token triple-quoted-string string">"""Test environment reward logic."""</span>

<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> pytest
<span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>mcp_tool_env <span class="token keyword keyword-import">import</span> MCPToolEnv<span class="token punctuation">,</span> MCPEnvConfig

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword keyword-def">def</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> MCPEnvConfig<span class="token punctuation">(</span>max_turns<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> enable_laj<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-return">return</span> MCPToolEnv<span class="token punctuation">(</span>config<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword keyword-def">def</span> <span class="token function">ground_truth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
        <span class="token string">"task_id"</span><span class="token punctuation">:</span> <span class="token string">"test_001"</span><span class="token punctuation">,</span>
        <span class="token string">"complexity"</span><span class="token punctuation">:</span> <span class="token string">"simple"</span><span class="token punctuation">,</span>
        <span class="token string">"max_turns"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
        <span class="token string">"tool_sequence"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token string">"step"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                <span class="token string">"server"</span><span class="token punctuation">:</span> <span class="token string">"polygon"</span><span class="token punctuation">,</span>
                <span class="token string">"tool"</span><span class="token punctuation">:</span> <span class="token string">"get_price"</span><span class="token punctuation">,</span>
                <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"ticker"</span><span class="token punctuation">:</span> <span class="token string">"SPY"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token string">"analysis_requirements"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"extract"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"price"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"next_args_from"</span><span class="token punctuation">:</span> <span class="token string">"price"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"analysis_rubric"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"steps"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">"step"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
                    <span class="token string">"extract"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"price"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"compute"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"select"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"accept_if"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"price &gt; 0"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token string">"next_args_from"</span><span class="token punctuation">:</span> <span class="token string">"price"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"final_answer_requirements"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"format"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
                <span class="token string">"must_include"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"price"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"grounded_from"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"price"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"final_reference"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"answer_text"</span><span class="token punctuation">:</span> <span class="token string">"SPY price: $500"</span><span class="token punctuation">,</span>
            <span class="token string">"facts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"citations"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"judge_rubric"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"weights"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"coverage"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"grounding"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"clarity"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"safety"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token keyword keyword-def">def</span> <span class="token function">test_tool_step_correct</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ground_truth<span class="token punctuation">,</span> monkeypatch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Test reward for correct tool call."""</span>
    <span class="token comment"># Mock tool execution</span>
    <span class="token keyword keyword-def">def</span> <span class="token function">mock_execute</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> tool<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-return">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"ok"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    monkeypatch<span class="token punctuation">.</span><span class="token builtin">setattr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"_execute_tool"</span><span class="token punctuation">,</span> mock_execute<span class="token punctuation">)</span>

    <span class="token comment"># Init</span>
    prompt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"get SPY price"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>init<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> ground_truth<span class="token punctuation">)</span>

    <span class="token comment"># Step: correct tool</span>
    action <span class="token operator">=</span> <span class="token string">'{"tool":"polygon.get_price","arguments":{"ticker":"SPY"}}'</span>
    out <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

    <span class="token keyword keyword-assert">assert</span> out<span class="token punctuation">.</span>reward <span class="token operator">&gt;</span> <span class="token number">0</span>  <span class="token comment"># Should get tool_name + extract + accept_if rewards</span>
    <span class="token keyword keyword-assert">assert</span> <span class="token keyword keyword-not">not</span> out<span class="token punctuation">.</span>done
    <span class="token keyword keyword-assert">assert</span> <span class="token string">"step"</span> <span class="token keyword keyword-in">in</span> out<span class="token punctuation">.</span>metadata

<span class="token keyword keyword-def">def</span> <span class="token function">test_final_answer_correct</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> ground_truth<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Test reward for correct final answer."""</span>
    prompt <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"test"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> <span class="token string">"task"</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
    env<span class="token punctuation">.</span>init<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> ground_truth<span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"price"</span><span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">}</span>  <span class="token comment"># Simulate extracted state</span>

    <span class="token comment"># Final answer</span>
    action <span class="token operator">=</span> <span class="token string">'{"final_answer":"SPY price is $500"}'</span>
    out <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

    <span class="token keyword keyword-assert">assert</span> out<span class="token punctuation">.</span>reward <span class="token operator">&gt;</span> <span class="token number">0</span>  <span class="token comment"># Heuristic reward (LAJ disabled)</span>
    <span class="token keyword keyword-assert">assert</span> out<span class="token punctuation">.</span>done
    <span class="token keyword keyword-assert">assert</span> <span class="token string">"final"</span> <span class="token keyword keyword-in">in</span> out<span class="token punctuation">.</span>metadata
</code></pre><h4 id="423-llm-as-a-judge-mock-test">4.2.3 LLM-as-a-Judge Mock Test </h4>
<p><strong>File:</strong> <code>tests/test_laj_mock.py</code></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token triple-quoted-string string">"""Test LAJ integration with mocked LLM."""</span>

<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> pytest
<span class="token keyword keyword-from">from</span> unittest<span class="token punctuation">.</span>mock <span class="token keyword keyword-import">import</span> AsyncMock<span class="token punctuation">,</span> MagicMock
<span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>mcp_tool_env <span class="token keyword keyword-import">import</span> MCPToolEnv<span class="token punctuation">,</span> MCPEnvConfig

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword keyword-def">def</span> <span class="token function">env_with_judge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> MCPEnvConfig<span class="token punctuation">(</span>enable_laj<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    env <span class="token operator">=</span> MCPToolEnv<span class="token punctuation">(</span>config<span class="token punctuation">)</span>

    <span class="token comment"># Mock OpenAI client</span>
    mock_client <span class="token operator">=</span> MagicMock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mock_resp <span class="token operator">=</span> MagicMock<span class="token punctuation">(</span><span class="token punctuation">)</span>
    mock_resp<span class="token punctuation">.</span>choices <span class="token operator">=</span> <span class="token punctuation">[</span>MagicMock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
    mock_resp<span class="token punctuation">.</span>choices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>message<span class="token punctuation">.</span>content <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"coverage"</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string">"grounding"</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string">"clarity"</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string">"safety"</span><span class="token punctuation">:</span> <span class="token number">1.0</span><span class="token punctuation">,</span>
        <span class="token string">"total"</span><span class="token punctuation">:</span> <span class="token number">1.0</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    mock_create <span class="token operator">=</span> AsyncMock<span class="token punctuation">(</span>return_value<span class="token operator">=</span>mock_resp<span class="token punctuation">)</span>
    mock_client<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create <span class="token operator">=</span> mock_create

    env<span class="token punctuation">.</span>judge <span class="token operator">=</span> mock_client
    <span class="token keyword keyword-return">return</span> env

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
<span class="token keyword keyword-def">def</span> <span class="token function">simple_gt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword keyword-return">return</span> <span class="token punctuation">{</span>
        <span class="token string">"task_id"</span><span class="token punctuation">:</span> <span class="token string">"test_laj"</span><span class="token punctuation">,</span>
        <span class="token string">"analysis_rubric"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"final_answer_requirements"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"format"</span><span class="token punctuation">:</span> <span class="token string">"text"</span><span class="token punctuation">,</span>
                <span class="token string">"must_include"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"answer"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"grounded_from"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"result"</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"final_reference"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"answer_text"</span><span class="token punctuation">:</span> <span class="token string">"The answer is 42"</span><span class="token punctuation">,</span>
            <span class="token string">"facts"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"citations"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"judge_rubric"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"weights"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"coverage"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"grounding"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"clarity"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token string">"safety"</span><span class="token punctuation">:</span> <span class="token number">0.25</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"schema"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
                <span class="token string">"properties"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
                    <span class="token string">"coverage"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"grounding"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"clarity"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"safety"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token string">"total"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"number"</span><span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>asyncio</span>
<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">test_laj_scoring</span><span class="token punctuation">(</span>env_with_judge<span class="token punctuation">,</span> simple_gt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Test that LAJ is called and scored correctly."""</span>
    env <span class="token operator">=</span> env_with_judge
    env<span class="token punctuation">.</span>gt <span class="token operator">=</span> simple_gt
    env<span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string">"result"</span><span class="token punctuation">:</span> <span class="token number">42</span><span class="token punctuation">}</span>

    final_text <span class="token operator">=</span> <span class="token string">"The answer is 42"</span>
    score<span class="token punctuation">,</span> details <span class="token operator">=</span> <span class="token keyword keyword-await">await</span> env<span class="token punctuation">.</span>_score_laj_cached<span class="token punctuation">(</span>final_text<span class="token punctuation">)</span>

    <span class="token keyword keyword-assert">assert</span> score <span class="token operator">==</span> <span class="token number">1.0</span>
    <span class="token keyword keyword-assert">assert</span> details<span class="token punctuation">[</span><span class="token string">"total"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1.0</span>
    <span class="token keyword keyword-assert">assert</span> env<span class="token punctuation">.</span>judge<span class="token punctuation">.</span>chat<span class="token punctuation">.</span>completions<span class="token punctuation">.</span>create<span class="token punctuation">.</span>called
</code></pre><hr>
<h2 id="5-phase-3-integration--testing">5. Phase 3: Integration &amp; Testing </h2>
<h3 id="51-dataset-validation-script">5.1 Dataset Validation Script </h3>
<p><strong>File:</strong> <code>scripts/validate_dataset.py</code></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment">#!/usr/bin/env python3</span>
<span class="token triple-quoted-string string">"""Validate generated dataset for SkyRL compatibility."""</span>

<span class="token keyword keyword-import">import</span> argparse
<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-import">import</span> sys
<span class="token keyword keyword-from">from</span> pathlib <span class="token keyword keyword-import">import</span> Path
<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> List

<span class="token keyword keyword-def">def</span> <span class="token function">validate_sample</span><span class="token punctuation">(</span>sample<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">,</span> idx<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Validate a single dataset sample. Returns list of errors."""</span>
    errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment"># Required top-level keys</span>
    required <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"data_source"</span><span class="token punctuation">,</span> <span class="token string">"env_class"</span><span class="token punctuation">,</span> <span class="token string">"prompt"</span><span class="token punctuation">,</span> <span class="token string">"reward_spec"</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> key <span class="token keyword keyword-in">in</span> required<span class="token punctuation">:</span>
        <span class="token keyword keyword-if">if</span> key <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> sample<span class="token punctuation">:</span>
            errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: Missing required key '</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">'"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Prompt validation</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"prompt"</span> <span class="token keyword keyword-in">in</span> sample<span class="token punctuation">:</span>
        prompt <span class="token operator">=</span> sample<span class="token punctuation">[</span><span class="token string">"prompt"</span><span class="token punctuation">]</span>
        <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span> <span class="token keyword keyword-or">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: prompt must be list of 2+ messages"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-for">for</span> i<span class="token punctuation">,</span> msg <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>prompt<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> <span class="token string">"role"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> msg <span class="token keyword keyword-or">or</span> <span class="token string">"content"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> msg<span class="token punctuation">:</span>
                    errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">, prompt[</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">]: missing role/content"</span></span><span class="token punctuation">)</span>
                <span class="token keyword keyword-if">if</span> msg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"role"</span><span class="token punctuation">)</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> <span class="token punctuation">(</span><span class="token string">"system"</span><span class="token punctuation">,</span> <span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">, prompt[</span><span class="token interpolation"><span class="token punctuation">{</span>i<span class="token punctuation">}</span></span><span class="token string">]: invalid role '</span><span class="token interpolation"><span class="token punctuation">{</span>msg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'role'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Ground truth validation</span>
    <span class="token keyword keyword-if">if</span> <span class="token string">"reward_spec"</span> <span class="token keyword keyword-in">in</span> sample<span class="token punctuation">:</span>
        gt <span class="token operator">=</span> sample<span class="token punctuation">[</span><span class="token string">"reward_spec"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"ground_truth"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment"># Tool sequence</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"tool_sequence"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> gt<span class="token punctuation">:</span>
            errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: Missing tool_sequence"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-for">for</span> step_idx<span class="token punctuation">,</span> step <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>gt<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                required_step <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"step"</span><span class="token punctuation">,</span> <span class="token string">"server"</span><span class="token punctuation">,</span> <span class="token string">"tool"</span><span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">]</span>
                <span class="token keyword keyword-for">for</span> key <span class="token keyword keyword-in">in</span> required_step<span class="token punctuation">:</span>
                    <span class="token keyword keyword-if">if</span> key <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> step<span class="token punctuation">:</span>
                        errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">, step </span><span class="token interpolation"><span class="token punctuation">{</span>step_idx<span class="token punctuation">}</span></span><span class="token string">: missing '</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">'"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># Analysis rubric</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"analysis_rubric"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> gt<span class="token punctuation">:</span>
            errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: Missing analysis_rubric"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            ar <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"analysis_rubric"</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"steps"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">:</span>
                errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: analysis_rubric missing 'steps'"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"final_answer_requirements"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> ar<span class="token punctuation">:</span>
                errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: analysis_rubric missing 'final_answer_requirements'"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># Final reference</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"final_reference"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> gt<span class="token punctuation">:</span>
            errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: Missing final_reference"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            fr <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-for">for</span> key <span class="token keyword keyword-in">in</span> <span class="token punctuation">[</span><span class="token string">"answer_text"</span><span class="token punctuation">,</span> <span class="token string">"facts"</span><span class="token punctuation">,</span> <span class="token string">"citations"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword keyword-if">if</span> key <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> fr<span class="token punctuation">:</span>
                    errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: final_reference missing '</span><span class="token interpolation"><span class="token punctuation">{</span>key<span class="token punctuation">}</span></span><span class="token string">'"</span></span><span class="token punctuation">)</span>

        <span class="token comment"># Judge rubric</span>
        <span class="token keyword keyword-if">if</span> <span class="token string">"judge_rubric"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> gt<span class="token punctuation">:</span>
            errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: Missing judge_rubric"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
            jr <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"judge_rubric"</span><span class="token punctuation">]</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"weights"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> jr<span class="token punctuation">:</span>
                errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: judge_rubric missing 'weights'"</span></span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> <span class="token string">"schema"</span> <span class="token keyword keyword-not">not</span> <span class="token keyword keyword-in">in</span> jr<span class="token punctuation">:</span>
                errors<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Sample </span><span class="token interpolation"><span class="token punctuation">{</span>idx<span class="token punctuation">}</span></span><span class="token string">: judge_rubric missing 'schema'"</span></span><span class="token punctuation">)</span>

    <span class="token keyword keyword-return">return</span> errors

<span class="token keyword keyword-def">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Validate SkyRL dataset"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"dataset_path"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span>Path<span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Path to dataset JSON"</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> args<span class="token punctuation">.</span>dataset_path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ File not found: </span><span class="token interpolation"><span class="token punctuation">{</span>args<span class="token punctuation">.</span>dataset_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>dataset_path<span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> f<span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"❌ Dataset must be a JSON array"</span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    all_errors <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword keyword-for">for</span> idx<span class="token punctuation">,</span> sample <span class="token keyword keyword-in">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
        errors <span class="token operator">=</span> validate_sample<span class="token punctuation">(</span>sample<span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
        all_errors<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>errors<span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> all_errors<span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"❌ Validation failed with </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>all_errors<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> errors:"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-for">for</span> err <span class="token keyword keyword-in">in</span> all_errors<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">:</span>  <span class="token comment"># Show first 20</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  - </span><span class="token interpolation"><span class="token punctuation">{</span>err<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword keyword-if">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>all_errors<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">20</span><span class="token punctuation">:</span>
            <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  ... and </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>all_errors<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">20</span><span class="token punctuation">}</span></span><span class="token string"> more"</span></span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword keyword-else">else</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ Validation passed for </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token builtin">len</span><span class="token punctuation">(</span>dataset<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> samples"</span></span><span class="token punctuation">)</span>
        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><p><strong>Usage:</strong></p>
<pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code>python scripts/validate_dataset.py data/processed/train_llm.json
</code></pre><h3 id="52-environment-smoke-test">5.2 Environment Smoke Test </h3>
<p><strong>File:</strong> <code>scripts/test_env_full.py</code></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token comment">#!/usr/bin/env python3</span>
<span class="token triple-quoted-string string">"""Full environment test with real tool execution."""</span>

<span class="token keyword keyword-import">import</span> asyncio
<span class="token keyword keyword-import">import</span> json
<span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>mcp_tool_env <span class="token keyword keyword-import">import</span> MCPToolEnv<span class="token punctuation">,</span> MCPEnvConfig

<span class="token keyword keyword-async">async</span> <span class="token keyword keyword-def">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># Load a sample from dataset</span>
    <span class="token keyword keyword-with">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">"data/processed/train_llm.json"</span><span class="token punctuation">)</span> <span class="token keyword keyword-as">as</span> f<span class="token punctuation">:</span>
        dataset <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>

    <span class="token keyword keyword-if">if</span> <span class="token keyword keyword-not">not</span> dataset<span class="token punctuation">:</span>
        <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string">"❌ Empty dataset"</span><span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span>

    sample <span class="token operator">=</span> dataset<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gt <span class="token operator">=</span> sample<span class="token punctuation">[</span><span class="token string">"reward_spec"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"ground_truth"</span><span class="token punctuation">]</span>
    prompt <span class="token operator">=</span> sample<span class="token punctuation">[</span><span class="token string">"prompt"</span><span class="token punctuation">]</span>

    <span class="token comment"># Create environment</span>
    config <span class="token operator">=</span> MCPEnvConfig<span class="token punctuation">(</span>
        max_turns<span class="token operator">=</span>gt<span class="token punctuation">[</span><span class="token string">"max_turns"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        enable_laj<span class="token operator">=</span><span class="token boolean">False</span>  <span class="token comment"># Disable for smoke test</span>
    <span class="token punctuation">)</span>
    env <span class="token operator">=</span> MCPToolEnv<span class="token punctuation">(</span>config<span class="token punctuation">)</span>

    <span class="token comment"># Init</span>
    obs<span class="token punctuation">,</span> info <span class="token operator">=</span> env<span class="token punctuation">.</span>init<span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> gt<span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ Init successful: </span><span class="token interpolation"><span class="token punctuation">{</span>info<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Try first tool step</span>
    first_step <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"tool_sequence"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    tool_fqn <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{</span>first_step<span class="token punctuation">[</span><span class="token string">"server"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{</span>first_step<span class="token punctuation">[</span><span class="token string">"tool"</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
    action <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token string">"tool"</span><span class="token punctuation">:</span> tool_fqn<span class="token punctuation">,</span>
        <span class="token string">"arguments"</span><span class="token punctuation">:</span> first_step<span class="token punctuation">[</span><span class="token string">"params"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"🔧 Executing: </span><span class="token interpolation"><span class="token punctuation">{</span>tool_fqn<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    out <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>

    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ Step reward: </span><span class="token interpolation"><span class="token punctuation">{</span>out<span class="token punctuation">.</span>reward<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   Metadata: </span><span class="token interpolation"><span class="token punctuation">{</span>out<span class="token punctuation">.</span>metadata<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Try final answer</span>
    final_text <span class="token operator">=</span> gt<span class="token punctuation">[</span><span class="token string">"final_reference"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"answer_text"</span><span class="token punctuation">]</span>
    action_final <span class="token operator">=</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token string">"final_answer"</span><span class="token punctuation">:</span> final_text<span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"📝 Final answer: </span><span class="token interpolation"><span class="token punctuation">{</span>final_text<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token format-spec">50]</span><span class="token punctuation">}</span></span><span class="token string">..."</span></span><span class="token punctuation">)</span>
    out_final <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action_final<span class="token punctuation">)</span>

    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"✅ Final reward: </span><span class="token interpolation"><span class="token punctuation">{</span>out_final<span class="token punctuation">.</span>reward<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword keyword-print">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   Done: </span><span class="token interpolation"><span class="token punctuation">{</span>out_final<span class="token punctuation">.</span>done<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword keyword-if">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="6-phase-4-training--evaluation">6. Phase 4: Training &amp; Evaluation </h2>
<h3 id="61-config-adjustments">6.1 Config Adjustments </h3>
<p><strong>File:</strong> <code>src/training/configs/rollout.yaml</code></p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">rollout</span><span class="token punctuation">:</span>
  <span class="token key atrule">backend</span><span class="token punctuation">:</span> <span class="token string">"auto"</span>  <span class="token comment"># vllm for LoRA, hf for Full FT</span>
  <span class="token key atrule">num_envs</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">num_workers</span><span class="token punctuation">:</span> <span class="token number">2</span>
  <span class="token key atrule">max_steps_per_episode</span><span class="token punctuation">:</span> <span class="token number">12</span>  <span class="token comment"># INCREASED for multi-turn</span>
  <span class="token key atrule">max_episodes_per_update</span><span class="token punctuation">:</span> <span class="token number">16</span>
  <span class="token key atrule">max_new_tokens</span><span class="token punctuation">:</span> <span class="token number">512</span>  <span class="token comment"># INCREASED for longer final answers</span>
  <span class="token key atrule">temperature</span><span class="token punctuation">:</span> <span class="token number">0.7</span>
  <span class="token key atrule">top_p</span><span class="token punctuation">:</span> <span class="token number">0.95</span>
  <span class="token key atrule">return_token_logprobs</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token comment"># NEW: Stop strings for tag-style actions</span>
  <span class="token key atrule">stop_strings</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"&lt;/tool&gt;"</span><span class="token punctuation">,</span> <span class="token string">"&lt;/answer&gt;"</span><span class="token punctuation">]</span>

  <span class="token key atrule">tools</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">timeout_seconds</span><span class="token punctuation">:</span> <span class="token number">20.0</span>
    <span class="token key atrule">retry_attempts</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">allow_list</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"polygon"</span><span class="token punctuation">,</span> <span class="token string">"fmp"</span><span class="token punctuation">,</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span> <span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"slack"</span><span class="token punctuation">]</span>

  <span class="token key atrule">batch_size</span><span class="token punctuation">:</span> <span class="token number">4</span>
  <span class="token key atrule">minibatch_size</span><span class="token punctuation">:</span> <span class="token number">1</span>
</code></pre><p><strong>File:</strong> <code>src/training/configs/env.yaml</code> (NEW)</p>
<pre data-role="codeBlock" data-info="yaml" class="language-yaml yaml"><code><span class="token key atrule">env</span><span class="token punctuation">:</span>
  <span class="token key atrule">class</span><span class="token punctuation">:</span> <span class="token string">"MCPToolEnv"</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span>
    <span class="token key atrule">max_turns</span><span class="token punctuation">:</span> <span class="token number">12</span>
    <span class="token key atrule">tools</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"polygon"</span><span class="token punctuation">,</span> <span class="token string">"fmp"</span><span class="token punctuation">,</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span> <span class="token string">"python"</span><span class="token punctuation">,</span> <span class="token string">"slack"</span><span class="token punctuation">]</span>
    <span class="token key atrule">enable_laj</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">laj_cache_size</span><span class="token punctuation">:</span> <span class="token number">1000</span>
    <span class="token key atrule">reward_weights</span><span class="token punctuation">:</span>
      <span class="token key atrule">tool_name</span><span class="token punctuation">:</span> <span class="token number">0.2</span>
      <span class="token key atrule">param_binding</span><span class="token punctuation">:</span> <span class="token number">0.15</span>
      <span class="token key atrule">extract</span><span class="token punctuation">:</span> <span class="token number">0.15</span>
      <span class="token key atrule">compute</span><span class="token punctuation">:</span> <span class="token number">0.15</span>
      <span class="token key atrule">accept_if</span><span class="token punctuation">:</span> <span class="token number">0.1</span>
      <span class="token key atrule">penalty</span><span class="token punctuation">:</span> <span class="token number">-0.1</span>
      <span class="token key atrule">final_heur</span><span class="token punctuation">:</span> <span class="token number">0.7</span>  <span class="token comment"># Start high, decrease as policy improves</span>
      <span class="token key atrule">final_laj</span><span class="token punctuation">:</span> <span class="token number">0.3</span>   <span class="token comment"># Start low, increase later</span>
</code></pre><h3 id="62-training-script-updates">6.2 Training Script Updates </h3>
<p><strong>File:</strong> <code>src/training/train_grpo_vllm.py</code></p>
<p>Add environment config loading:</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token keyword keyword-def">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># ... [existing arg parsing] ...</span>

    env_cfg <span class="token operator">=</span> load_yaml<span class="token punctuation">(</span>args<span class="token punctuation">.</span>env_config<span class="token punctuation">)</span> <span class="token keyword keyword-if">if</span> args<span class="token punctuation">.</span>env_config <span class="token keyword keyword-else">else</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment"># ... [existing setup] ...</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">env_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword keyword-from">from</span> src<span class="token punctuation">.</span>envs<span class="token punctuation">.</span>mcp_tool_env <span class="token keyword keyword-import">import</span> MCPToolEnv<span class="token punctuation">,</span> MCPEnvConfig
        config <span class="token operator">=</span> MCPEnvConfig<span class="token punctuation">(</span>
            max_turns<span class="token operator">=</span>env_cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"max_turns"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            tools<span class="token operator">=</span>env_cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tools"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            enable_laj<span class="token operator">=</span>env_cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"enable_laj"</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            reward_weights<span class="token operator">=</span>env_cfg<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"config"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"reward_weights"</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        <span class="token keyword keyword-return">return</span> MCPToolEnv<span class="token punctuation">(</span>config<span class="token punctuation">)</span>

    <span class="token comment"># ... [rest of training setup] ...</span>
</code></pre><h3 id="63-evaluation-metrics">6.3 Evaluation Metrics </h3>
<p><strong>File:</strong> <code>src/training/callbacks/metrics_callback.py</code> (NEW)</p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code><span class="token triple-quoted-string string">"""Custom metrics callback for multi-turn tool use."""</span>

<span class="token keyword keyword-from">from</span> typing <span class="token keyword keyword-import">import</span> Dict<span class="token punctuation">,</span> Any

<span class="token keyword keyword-class">class</span> <span class="token class-name">MultiTurnMetricsCallback</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Track tool-specific and final-answer metrics."""</span>

    <span class="token keyword keyword-def">def</span> <span class="token function">on_rollout_end</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> rollout_stats<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Any<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Aggregate metrics from episode metadata."""</span>
        episodes <span class="token operator">=</span> rollout_stats<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"episodes"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># Tool metrics</span>
        tool_correct <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>
            <span class="token number">1</span> <span class="token keyword keyword-for">for</span> ep <span class="token keyword keyword-in">in</span> episodes
            <span class="token keyword keyword-for">for</span> step <span class="token keyword keyword-in">in</span> ep<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-if">if</span> step<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"tool_name_match"</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        tool_total <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ep<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"metadata"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword keyword-for">for</span> ep <span class="token keyword keyword-in">in</span> episodes<span class="token punctuation">)</span>  <span class="token comment"># -1 for final</span>

        <span class="token comment"># Final answer metrics</span>
        final_scores <span class="token operator">=</span> <span class="token punctuation">[</span>
            ep<span class="token punctuation">[</span><span class="token string">"metadata"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"final"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword keyword-for">for</span> ep <span class="token keyword keyword-in">in</span> episodes
            <span class="token keyword keyword-if">if</span> ep<span class="token punctuation">[</span><span class="token string">"metadata"</span><span class="token punctuation">]</span> <span class="token keyword keyword-and">and</span> <span class="token string">"final"</span> <span class="token keyword keyword-in">in</span> ep<span class="token punctuation">[</span><span class="token string">"metadata"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
        <span class="token punctuation">]</span>

        heur_scores <span class="token operator">=</span> <span class="token punctuation">[</span>fs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"heur"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"coverage"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> fs <span class="token keyword keyword-in">in</span> final_scores<span class="token punctuation">]</span>
        laj_scores <span class="token operator">=</span> <span class="token punctuation">[</span>fs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"laj"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"total"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> fs <span class="token keyword keyword-in">in</span> final_scores <span class="token keyword keyword-if">if</span> <span class="token string">"laj"</span> <span class="token keyword keyword-in">in</span> fs<span class="token punctuation">]</span>

        <span class="token comment"># Log to W&amp;B</span>
        <span class="token keyword keyword-import">import</span> wandb
        wandb<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">"metrics/tool_accuracy"</span><span class="token punctuation">:</span> tool_correct <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span>tool_total<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"metrics/final_coverage_avg"</span><span class="token punctuation">:</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>heur_scores<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>heur_scores<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"metrics/final_laj_avg"</span><span class="token punctuation">:</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>laj_scores<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>laj_scores<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"metrics/avg_episode_length"</span><span class="token punctuation">:</span> <span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ep<span class="token punctuation">[</span><span class="token string">"metadata"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword keyword-for">for</span> ep <span class="token keyword keyword-in">in</span> episodes<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>episodes<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><p><strong>Wire into trainer:</strong></p>
<pre data-role="codeBlock" data-info="python" class="language-python python"><code>trainer <span class="token operator">=</span> Trainer<span class="token punctuation">(</span>
    algorithm<span class="token operator">=</span>algo<span class="token punctuation">,</span>
    config<span class="token operator">=</span>trainer_conf<span class="token punctuation">,</span>
    callbacks<span class="token operator">=</span><span class="token punctuation">[</span>
        PPOHealthCallback<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        MultiTurnMetricsCallback<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># NEW</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre><hr>
<h2 id="7-risk-mitigation">7. Risk Mitigation </h2>
<h3 id="71-known-risks-and-mitigations">7.1 Known Risks and Mitigations </h3>
<table>
<thead>
<tr>
<th>Risk</th>
<th>Probability</th>
<th>Impact</th>
<th>Mitigation</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>LLM planner generates invalid tool sequences</strong></td>
<td>High</td>
<td>Medium</td>
<td>Verify/repair step; retry with modified prompt; fallback to simpler templates</td>
</tr>
<tr>
<td><strong>MCP tool execution failures</strong></td>
<td>Medium</td>
<td>Medium</td>
<td>Graceful degradation (mock results); increase timeouts; add retries</td>
</tr>
<tr>
<td><strong>LAJ API rate limits</strong></td>
<td>Medium</td>
<td>High</td>
<td>Cache aggressively; batch calls; use heuristic-only mode for early training</td>
</tr>
<tr>
<td><strong>Reward hacking (model exploits rubric)</strong></td>
<td>Medium</td>
<td>High</td>
<td>Add negative shaping (repeated tools, malformed args); monitor W&amp;B for anomalies</td>
</tr>
<tr>
<td><strong>State variable name collisions</strong></td>
<td>Low</td>
<td>Medium</td>
<td>Namespace prefixes (e.g., <code>step1_price</code>); validation in verify_and_repair</td>
</tr>
<tr>
<td><strong>Dataset prompt bloat</strong></td>
<td>Low</td>
<td>High</td>
<td>Enforce compact format; validate token budget; truncate tool results in observations</td>
</tr>
<tr>
<td><strong>vLLM LoRA sync issues</strong></td>
<td>Medium</td>
<td>High</td>
<td>Add refresh callback post-update; verify weights hash; fallback to HF if stale</td>
</tr>
<tr>
<td><strong>DSL eval security</strong></td>
<td>Low</td>
<td>Critical</td>
<td>Whitelist functions only; no <strong>builtins</strong>; audit new functions rigorously</td>
</tr>
</tbody>
</table>
<h3 id="72-rollback-plan">7.2 Rollback Plan </h3>
<p>If Phase 1 or 2 breaks existing functionality:</p>
<ol>
<li><strong>Isolate changes:</strong> New code in separate modules (<code>reward_functions.py</code>, extended generator)</li>
<li><strong>Feature flag:</strong> Environment config has <code>enable_analysis_rewards</code> (default False)</li>
<li><strong>Dataset backward compat:</strong> Old datasets work (missing fields use defaults)</li>
<li><strong>Revert script:</strong><pre data-role="codeBlock" data-info="bash" class="language-bash bash"><code><span class="token function">git</span> revert <span class="token operator">&lt;</span>commit-hash<span class="token operator">&gt;</span>
<span class="token function">bash</span> scripts/train_grpo.sh  <span class="token comment"># Verify old behavior restored</span>
</code></pre></li>
</ol>
<hr>
<h2 id="8-success-criteria">8. Success Criteria </h2>
<h3 id="81-phase-1-complete-data-generator">8.1 Phase 1 Complete (Data Generator) </h3>
<ul>
<li>✅ Can generate 50 samples with analysis_requirements, final_reference, judge_rubric</li>
<li>✅ Plans execute against MCP tools (or mocks) without crashes</li>
<li>✅ <code>python scripts/validate_dataset.py data/processed/train_llm.json</code> passes</li>
<li>✅ Reference answers are non-empty and grounded in state</li>
</ul>
<h3 id="82-phase-2-complete-environment">8.2 Phase 2 Complete (Environment) </h3>
<ul>
<li>✅ <code>pytest tests/test_dsl.py</code> passes (all DSL functions work)</li>
<li>✅ <code>pytest tests/test_env_rewards.py</code> passes (tool step rewards correct)</li>
<li>✅ <code>python scripts/test_env_full.py</code> runs without errors</li>
<li>✅ LAJ mock test passes</li>
</ul>
<h3 id="83-phase-3-complete-integration">8.3 Phase 3 Complete (Integration) </h3>
<ul>
<li>✅ Full dataset of 100 samples generates in &lt;10 minutes</li>
<li>✅ Environment can load and run 10 episodes with dense rewards</li>
<li>✅ W&amp;B logs show non-zero tool_accuracy and final_coverage_avg</li>
</ul>
<h3 id="84-phase-4-complete-training">8.4 Phase 4 Complete (Training) </h3>
<ul>
<li>✅ GRPO training runs for 100 steps without crashes</li>
<li>✅ Policy loss, value loss, KL divergence are stable</li>
<li>✅ Average reward increases over time (or plateaus above baseline)</li>
<li>✅ Episode length distribution matches expected (8-12 turns)</li>
<li>✅ Final answer quality improves (LAJ scores increase)</li>
</ul>
<hr>
<h2 id="9-appendix">9. Appendix </h2>
<h3 id="91-full-example-dataset-item">9.1 Full Example Dataset Item </h3>
<pre data-role="codeBlock" data-info="json" class="language-json json"><code><span class="token punctuation">{</span>
  <span class="token property">"data_source"</span><span class="token operator">:</span> <span class="token string">"synthetic/llm"</span><span class="token punctuation">,</span>
  <span class="token property">"env_class"</span><span class="token operator">:</span> <span class="token string">"MCPToolEnv"</span><span class="token punctuation">,</span>
  <span class="token property">"prompt"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span>
      <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"You are a research assistant with access to tools: polygon, fmp, tavily, python_execution, slack. To call a tool, use JSON: {\"tool\":\"server.tool\",\"arguments\":{...}}. To provide final answer, use: {\"final_answer\":\"text\"}."</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token property">"role"</span><span class="token operator">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span>
      <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"Find the top 3 NASDAQ-100 gainers today, collect 5 news headlines for each, filter negative sentiment ones, and post a digest to Slack."</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">"reward_spec"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"rule"</span><span class="token punctuation">,</span>
    <span class="token property">"ground_truth"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"task_id"</span><span class="token operator">:</span> <span class="token string">"nasdaq100-neg-digest-001"</span><span class="token punctuation">,</span>
      <span class="token property">"complexity"</span><span class="token operator">:</span> <span class="token string">"complex"</span><span class="token punctuation">,</span>
      <span class="token property">"max_turns"</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
      <span class="token property">"limits"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"max_servers"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
        <span class="token property">"max_tools"</span><span class="token operator">:</span> <span class="token number">10</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"tool_sequence"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"NASDAQ-100 components list"</span><span class="token punctuation">,</span>
            <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">1</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][url]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url = results[0]['url']"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url ~= '^https://'"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers_url"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"extract"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"${tickers_url}"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = regex_extract_all('[A-Z]{2,5}', content)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = unique(tickers)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(tickers) &gt;= 80"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"polygon"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"get_aggs"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"ticker"</span><span class="token operator">:</span> <span class="token string">"${tickers}"</span><span class="token punctuation">,</span>
            <span class="token property">"timespan"</span><span class="token operator">:</span> <span class="token string">"day"</span><span class="token punctuation">,</span>
            <span class="token property">"from"</span><span class="token operator">:</span> <span class="token string">"2025-09-27"</span><span class="token punctuation">,</span>
            <span class="token property">"to"</span><span class="token operator">:</span> <span class="token string">"2025-09-29"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"pct = pct_change_last_day(results)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3 = topk(pct, 3)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(top3) == 3"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"top3"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[0]} stock news"</span><span class="token punctuation">,</span>
            <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news0 = results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news0) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news0"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[1]} stock news"</span><span class="token punctuation">,</span>
            <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news1 = results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news1) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news1"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"tavily"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"search"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"query"</span><span class="token operator">:</span> <span class="token string">"${top3[2]} stock news"</span><span class="token punctuation">,</span>
            <span class="token property">"max_results"</span><span class="token operator">:</span> <span class="token number">5</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news2 = results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news2) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news2"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"execute_python"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"import json; all_titles = ${news0} + ${news1} + ${news2}; sentiment = analyze_sentiment(all_titles); result = {t: s for t, s in zip(all_titles, sentiment)}; json.dumps(result)"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"sentiment_map = result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"count_keys(sentiment_map) &gt;= 10"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"sentiment_map"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"python_execution"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"execute_python"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"code"</span><span class="token operator">:</span> <span class="token string">"neg_titles = [t for t, s in ${sentiment_map}.items() if s &lt; -0.3][:5]; json.dumps(neg_titles)"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"neg_titles = result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(neg_titles) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"neg_titles"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
          <span class="token property">"server"</span><span class="token operator">:</span> <span class="token string">"slack"</span><span class="token punctuation">,</span>
          <span class="token property">"tool"</span><span class="token operator">:</span> <span class="token string">"send_message"</span><span class="token punctuation">,</span>
          <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"channel"</span><span class="token operator">:</span> <span class="token string">"research-alerts"</span><span class="token punctuation">,</span>
            <span class="token property">"text"</span><span class="token operator">:</span> <span class="token string">"Top-3 NASDAQ gainers: ${top3}. Negative headlines: ${neg_titles}"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"analysis_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ok == True"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"ok"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">"analysis_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"steps"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][url]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url = results[0]['url']"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url ~= '^https://'"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers_url"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = regex_extract_all('[A-Z]{2,5}', content)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers = unique(tickers)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(tickers) &gt;= 80"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"tickers"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"pct = pct_change_last_day(results)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3 = topk(pct, 3)"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(top3) == 3"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"top3"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news0 = results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news0) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news0"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news1 = results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news1) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news1"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"results[][title]"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"news2 = results"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(news2) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"news2"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"sentiment_map = result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"count_keys(sentiment_map) &gt;= 10"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"sentiment_map"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"neg_titles = result"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"len(neg_titles) &gt;= 1"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"neg_titles"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>
            <span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
            <span class="token property">"extract"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ok"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"compute"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"select"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"accept_if"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"ok == True"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token property">"next_args_from"</span><span class="token operator">:</span> <span class="token string">"ok"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"final_answer_requirements"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"format"</span><span class="token operator">:</span> <span class="token string">"markdown"</span><span class="token punctuation">,</span>
          <span class="token property">"must_include"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">,</span> <span class="token string">"neg_titles"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"grounded_from"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"top3"</span><span class="token punctuation">,</span> <span class="token string">"sentiment_map"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"quality_criteria"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"No hallucinated tickers"</span><span class="token punctuation">,</span>
            <span class="token string">"Relevant negative headlines"</span><span class="token punctuation">,</span>
            <span class="token string">"Concise (50-120 words)"</span>
          <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"final_reference"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"answer_text"</span><span class="token operator">:</span> <span class="token string">"**Top-3 NASDAQ-100 Gainers Today:**\n1. NVDA (+5.2%)\n2. AMD (+4.8%)\n3. META (+3.9%)\n\n**Negative Headlines:**\n- \"NVDA faces supply chain disruptions\"\n- \"AMD loses key contract to competitor\"\n- \"META ad revenue concerns grow\"\n\nPosted to Slack #research-alerts."</span><span class="token punctuation">,</span>
        <span class="token property">"facts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"NVDA"</span><span class="token punctuation">,</span> <span class="token string">"AMD"</span><span class="token punctuation">,</span> <span class="token string">"META"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token string">"NVDA faces supply chain disruptions"</span><span class="token punctuation">,</span>
            <span class="token string">"AMD loses key contract to competitor"</span><span class="token punctuation">,</span>
            <span class="token string">"META ad revenue concerns grow"</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"slack_posted"</span><span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"citations"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"top3"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"neg_titles"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token property">"slack_posted"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token property">"judge_rubric"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"weights"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token number">0.35</span><span class="token punctuation">,</span>
          <span class="token property">"grounding"</span><span class="token operator">:</span> <span class="token number">0.40</span><span class="token punctuation">,</span>
          <span class="token property">"clarity"</span><span class="token operator">:</span> <span class="token number">0.15</span><span class="token punctuation">,</span>
          <span class="token property">"safety"</span><span class="token operator">:</span> <span class="token number">0.10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"schema"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"object"</span><span class="token punctuation">,</span>
          <span class="token property">"properties"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token property">"coverage"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
              <span class="token property">"minimum"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">"maximum"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Fraction of required facts included"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"grounding"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
              <span class="token property">"minimum"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">"maximum"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Consistency with reference facts (no hallucinations)"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"clarity"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
              <span class="token property">"minimum"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">"maximum"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Readability and structure"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"safety"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
              <span class="token property">"minimum"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">"maximum"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"No sensitive info or harmful content"</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token property">"total"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
              <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"number"</span><span class="token punctuation">,</span>
              <span class="token property">"minimum"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token property">"maximum"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
              <span class="token property">"description"</span><span class="token operator">:</span> <span class="token string">"Weighted sum of above"</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token property">"required"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"coverage"</span><span class="token punctuation">,</span> <span class="token string">"grounding"</span><span class="token punctuation">,</span> <span class="token string">"clarity"</span><span class="token punctuation">,</span> <span class="token string">"safety"</span><span class="token punctuation">,</span> <span class="token string">"total"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token property">"target_length_range"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"extra_info"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"task_metadata"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"model"</span><span class="token operator">:</span> <span class="token string">"gpt-5-mini"</span><span class="token punctuation">,</span>
      <span class="token property">"backend"</span><span class="token operator">:</span> <span class="token string">"responses"</span><span class="token punctuation">,</span>
      <span class="token property">"generated_at"</span><span class="token operator">:</span> <span class="token string">"2025-09-29T12:00:00Z"</span><span class="token punctuation">,</span>
      <span class="token property">"exec_breadcrumbs"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"state_keys"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"tickers_url"</span><span class="token punctuation">,</span> <span class="token string">"tickers"</span><span class="token punctuation">,</span> <span class="token string">"pct"</span><span class="token punctuation">,</span> <span class="token string">"top3"</span><span class="token punctuation">,</span> <span class="token string">"news0"</span><span class="token punctuation">,</span> <span class="token string">"news1"</span><span class="token punctuation">,</span> <span class="token string">"news2"</span><span class="token punctuation">,</span> <span class="token string">"sentiment_map"</span><span class="token punctuation">,</span> <span class="token string">"neg_titles"</span><span class="token punctuation">,</span> <span class="token string">"ok"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token property">"steps"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"tavily.search"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"tavily.extract"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"polygon.get_aggs"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"tavily.search"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"tavily.search"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"tavily.search"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"python_execution.execute_python"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"python_execution.execute_python"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span><span class="token property">"step"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token property">"tool_fqn"</span><span class="token operator">:</span> <span class="token string">"slack.send_message"</span><span class="token punctuation">,</span> <span class="token property">"accept_pass"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="92-implementation-timeline">9.2 Implementation Timeline </h3>
<p><strong>Estimated effort:</strong> 3-4 weeks (1 senior ML engineer + 1 junior engineer)</p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Duration</th>
<th>Dependencies</th>
<th>Deliverables</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Phase 1: Data Generator</strong></td>
<td>1 week</td>
<td>None</td>
<td>Extended generator, DSL, validation script</td>
</tr>
<tr>
<td><strong>Phase 2: Environment</strong></td>
<td>1 week</td>
<td>Phase 1 DSL</td>
<td>reward_functions.py, updated mcp_tool_env.py, unit tests</td>
</tr>
<tr>
<td><strong>Phase 3: Integration</strong></td>
<td>1 week</td>
<td>Phases 1 &amp; 2</td>
<td>Full smoke tests, dataset validation, metrics callback</td>
</tr>
<tr>
<td><strong>Phase 4: Training</strong></td>
<td>1 week</td>
<td>Phase 3</td>
<td>Config updates, training runs, W&amp;B dashboards</td>
</tr>
</tbody>
</table>
<p><strong>Parallel tracks:</strong></p>
<ul>
<li>Testing can start in Phase 1 (DSL unit tests)</li>
<li>Dataset generation can run overnight (generate 1000+ samples)</li>
<li>LAJ integration can be phased (heuristic-only first, LAJ later)</li>
</ul>
<h3 id="93-references">9.3 References </h3>
<ul>
<li><strong>SkyRL Docs:</strong> <a href="https://skyrl.readthedocs.io/">https://skyrl.readthedocs.io/</a>
<ul>
<li>BaseTextEnv API: /tutorials/new_env.html</li>
<li>ToolGroups: /tutorials/tools_guide.html</li>
<li>Multi-turn Search example: /examples/search.html</li>
<li>LLM-as-a-Judge: /examples/llm_as_a_judge.html</li>
<li>Dataset preparation: /datasets/dataset-preparation.html</li>
</ul>
</li>
<li><strong>OpenAI Structured Outputs:</strong> <a href="https://platform.openai.com/docs/guides/structured-outputs">https://platform.openai.com/docs/guides/structured-outputs</a></li>
<li><strong>GRPO Paper:</strong> <a href="https://arxiv.org/abs/2402.03300">https://arxiv.org/abs/2402.03300</a></li>
<li><strong>MCP Protocol:</strong> (Your internal docs / tool server specs)</li>
</ul>
<hr>
<h2 id="conclusion">Conclusion </h2>
<p>This implementation plan provides a complete, surgical upgrade path from the current "basic tool execution" system to a <strong>production-ready, long-horizon, multi-turn tool use agent with research capabilities</strong>.</p>
<p><strong>Key innovations:</strong></p>
<ol>
<li><strong>Executed plans in data generation</strong> (not just hypothetical)</li>
<li><strong>Safe, auditable DSL</strong> for analysis (no arbitrary eval)</li>
<li><strong>Dense per-step rewards</strong> (reduces credit assignment problem)</li>
<li><strong>Hybrid reward system</strong> (heuristic + LAJ for quality)</li>
<li><strong>Full SkyRL compatibility</strong> (BaseTextEnv, compact prompts, ToolGroups)</li>
</ol>
<p><strong>Next steps:</strong></p>
<ol>
<li>Review this document with the team</li>
<li>Create implementation issues/tickets</li>
<li>Start with Phase 1 (can be developed independently)</li>
<li>Run validation suite after each phase</li>
<li>Monitor W&amp;B metrics closely during Phase 4</li>
</ol>
<p><strong>Success metrics:</strong></p>
<ul>
<li>Policy learns to call correct tools in correct order</li>
<li>Final answers are factual, grounded, and well-structured</li>
<li>Training is stable (no reward hacking or degenerate behaviors)</li>
<li>System can scale to 10+ step tasks across 5+ tool domains</li>
</ul>
<hr>
<p><strong>Document Status:</strong> Ready for implementation<br>
<strong>Last Updated:</strong> 2025-09-29<br>
<strong>Reviewed By:</strong> [Pending]<br>
<strong>Approved By:</strong> [Pending]</p>

      </div>
      
      
    
    
    
    
    
    
  
    </body></html>